<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ATOM.LAB — Atomic Sandbox</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Outfit:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#020510;--s1:#0a0f1e;--s2:#0e1322;--border:rgba(255,255,255,.07);--text:#cdd6e4;--dim:#5a6580;--acc:#06d6a0;--acc2:#118ab2;--acc3:#ef476f}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif}
#app{display:flex;height:100vh}

/* === SIDEBAR === */
#side{width:280px;background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
#sideHead{padding:14px 16px 10px;border-bottom:1px solid var(--border)}
#sideHead h1{font-size:20px;font-weight:800;letter-spacing:-1px;margin:0}
#sideHead h1 b{background:linear-gradient(135deg,#06d6a0,#118ab2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#sideHead h1 span{font-size:12px;color:var(--dim);font-weight:600;margin-left:2px}

/* Tabs */
#sideTabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.stab{flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:700;color:var(--dim);cursor:pointer;border:none;border-bottom:2px solid transparent;transition:all .15s;background:none;font-family:inherit}
.stab:hover{color:var(--text);background:rgba(255,255,255,.02)}
.stab.active{color:var(--acc);border-bottom-color:var(--acc);background:rgba(6,214,160,.04)}

/* Tab panels */
.tabPanel{display:none;flex:1;overflow-y:auto;min-height:0}
.tabPanel.active{display:flex;flex-direction:column}
.tabPanel::-webkit-scrollbar{width:4px}.tabPanel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}

/* Search */
#elSearch{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px 12px;color:var(--text);font-family:inherit;font-size:13px;outline:none;font-weight:500}
#elSearch:focus{border-color:rgba(6,214,160,.4);box-shadow:0 0 0 3px rgba(6,214,160,.08)}
#elSearch::placeholder{color:var(--dim)}

/* Category chips */
.catWrap{padding:6px 12px;display:flex;flex-wrap:wrap;gap:4px}
.catChip{font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--dim);cursor:pointer;font-family:inherit;font-weight:600;transition:all .12s}
.catChip:hover{background:rgba(255,255,255,.06);color:var(--text)}
.catChip.active{background:rgba(6,214,160,.15);border-color:rgba(6,214,160,.3);color:var(--acc)}

/* Element grid */
.elGrid{padding:6px 8px;display:grid;grid-template-columns:repeat(5,1fr);gap:3px}
.abtn{display:flex;align-items:center;justify-content:center;flex-direction:column;height:54px;border-radius:8px;border:1.5px solid rgba(255,255,255,.05);background:rgba(255,255,255,.025);color:var(--text);font-family:inherit;cursor:pointer;transition:all .12s;position:relative}
.abtn:hover{border-color:rgba(255,255,255,.15);background:rgba(255,255,255,.06);transform:scale(1.04)}
.abtn.active{border-color:var(--acc);background:rgba(6,214,160,.12);box-shadow:0 0 12px rgba(6,214,160,.15)}
.abtn .sym{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:800;line-height:1}
.abtn .anum{position:absolute;top:3px;left:5px;font-size:8px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.abtn .aname{font-size:7px;color:var(--dim);margin-top:1px;letter-spacing:.3px;font-weight:500}

/* Structures */
.structCat{font-size:11px;color:var(--dim);padding:12px 14px 4px;letter-spacing:1px;text-transform:uppercase;font-weight:700}
.structBtn{display:block;width:calc(100% - 20px);margin:2px 10px;padding:8px 12px;text-align:left;font-size:13px;border-radius:8px;border:1px solid rgba(255,255,255,.05);background:rgba(255,255,255,.025);color:var(--text);cursor:pointer;font-family:inherit;font-weight:600;transition:all .12s}
.structBtn:hover{background:rgba(6,214,160,.1);border-color:rgba(6,214,160,.2);color:var(--acc)}

/* Environment pinned bottom */
.envSection{padding:10px 12px 12px;flex-shrink:0;border-top:1px solid var(--border);background:var(--s1)}
.envTitle{font-size:10px;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;font-weight:700;margin-bottom:6px}
.resetBtn{background:none;border:1px solid rgba(255,255,255,.08);border-radius:5px;color:var(--dim);font-family:inherit;font-size:10px;font-weight:600;padding:2px 8px;cursor:pointer;transition:all .12s}
.resetBtn:hover{border-color:var(--acc3);color:var(--acc3);background:rgba(239,71,111,.08)}
.srow{display:flex;align-items:center;gap:6px;padding:3px 0}
.srow label{font-size:11px;color:var(--dim);min-width:50px;font-weight:600}
.srow input[type=range]{flex:1;height:4px;-webkit-appearance:none;background:rgba(255,255,255,.08);border-radius:2px;outline:none}
.srow input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--acc);cursor:pointer;box-shadow:0 0 6px rgba(6,214,160,.35)}
.srow span{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--acc);min-width:28px;text-align:right;font-weight:700}

/* === CANVAS AREA === */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#cvWrap{flex:1;position:relative;overflow:hidden;background:var(--bg);cursor:crosshair}
canvas{position:absolute;top:0;left:0}
#bgCv{z-index:0}#mainCv{z-index:1}#uiCv{z-index:2;pointer-events:none}

/* Floating toolbar */
#toolbar{position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:20;display:flex;align-items:center;gap:4px;padding:6px 10px;background:rgba(6,10,20,.9);border:1px solid rgba(255,255,255,.1);border-radius:12px;backdrop-filter:blur(16px)}
.tbtn{display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:7px 14px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--text);font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;transition:all .12s;white-space:nowrap}
.tbtn:hover{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.08)}
.tbtn.active{background:var(--acc);border-color:var(--acc);color:#000;box-shadow:0 0 12px rgba(6,214,160,.25)}
.tbtn.danger{border-color:rgba(239,68,68,.3);color:#f87171}.tbtn.danger:hover{background:rgba(239,68,68,.15)}
.tdiv{width:1px;height:24px;background:rgba(255,255,255,.1);margin:0 2px}

/* === ORBITAL TAB === */
#orbWrap{position:absolute;inset:0;z-index:15;background:#020510;overflow:hidden}
#orbCv{width:100%;height:100%;display:block}
#orbHUD{pointer-events:none}
.orbRow{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.orbRow label{font-size:10px;color:var(--dim);font-weight:700;min-width:20px}
.orbRow input[type=range]{flex:1;height:4px;-webkit-appearance:none;background:rgba(255,255,255,.08);border-radius:2px;outline:none}
.orbRow input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--acc2);cursor:pointer;box-shadow:0 0 6px rgba(17,138,178,.4)}
.orbRow span{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--acc2);min-width:30px;text-align:right;font-weight:700}
.orbBtnRow{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
.orbBtn{padding:4px 10px;border-radius:6px;border:1px solid rgba(17,138,178,.25);background:rgba(17,138,178,.08);color:rgba(17,138,178,.7);font-family:inherit;font-size:10px;font-weight:700;cursor:pointer;transition:all .12s}
.orbBtn:hover{border-color:rgba(17,138,178,.5);color:var(--acc2);background:rgba(17,138,178,.15)}
.orbBtn.active{background:var(--acc2);border-color:var(--acc2);color:#000}
.orbElGrid{display:grid;grid-template-columns:repeat(9,1fr);gap:2px;margin-bottom:6px}
.orbElBtn{padding:4px 0;border-radius:4px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);color:var(--dim);font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:800;cursor:pointer;transition:all .12s;text-align:center}
.orbElBtn:hover{border-color:rgba(17,138,178,.3);color:var(--text);background:rgba(17,138,178,.1)}
.orbElBtn.active{border-color:var(--acc2);background:rgba(17,138,178,.2);color:var(--acc2)}

/* Quantum number button selectors */
.qnRow{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.qnLabel{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:800;color:var(--acc2);min-width:14px}
.qnDesc{font-size:9px;color:var(--dim);min-width:36px;font-weight:600}
.qnBtns{display:flex;gap:3px;flex:1;flex-wrap:wrap}
.qnB{min-width:28px;padding:5px 8px;border-radius:6px;border:1.5px solid rgba(17,138,178,.15);background:rgba(17,138,178,.04);color:var(--dim);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:800;cursor:pointer;transition:all .12s;text-align:center}
.qnB:hover{border-color:rgba(17,138,178,.4);color:var(--text);background:rgba(17,138,178,.1)}
.qnB.active{background:var(--acc2);border-color:var(--acc2);color:#000;box-shadow:0 0 8px rgba(17,138,178,.3)}
.qnB.disabled{opacity:.2;pointer-events:none}

/* Display toggles bottom-left */
#dispBar{position:absolute;bottom:12px;left:12px;z-index:20;display:flex;gap:4px;padding:5px 8px;background:rgba(6,10,20,.9);border:1px solid rgba(255,255,255,.08);border-radius:10px;backdrop-filter:blur(16px)}
#dispBar .tbtn{padding:5px 10px;font-size:11px}

/* Stats top-right */
#statsBar{position:absolute;top:12px;right:12px;z-index:20;font-size:11px;color:var(--dim);background:rgba(6,10,20,.85);padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.06);font-family:'JetBrains Mono',monospace}
#statsBar span{color:var(--acc);font-weight:700}

/* Info panel */
.panel{position:absolute;background:rgba(6,10,20,.92);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px 14px;backdrop-filter:blur(16px);z-index:10;pointer-events:none}
#infoP{top:52px;right:12px;min-width:180px;display:none}
#infoP.show{display:block}
.olbl{font-size:9px;color:var(--dim);letter-spacing:.8px;text-transform:uppercase;margin-bottom:2px;font-weight:600}
.oval{font-size:13px;font-weight:700;margin-bottom:6px;font-family:'JetBrains Mono',monospace}
#molP{bottom:50px;left:12px;pointer-events:none}
#molP .oval{margin:0;font-size:12px;color:var(--acc)}

/* Bond log */
#bondLog{position:absolute;top:52px;left:12px;z-index:10;pointer-events:none;display:flex;flex-direction:column;gap:4px}
.bl-msg{background:rgba(6,10,20,.9);border:1px solid rgba(6,214,160,.2);border-radius:6px;padding:5px 10px;font-size:11px;font-weight:700;color:var(--acc);backdrop-filter:blur(8px);animation:blIn .3s ease;white-space:nowrap;font-family:'JetBrains Mono',monospace}
@keyframes blIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}

/* Tooltip */
#tip{position:fixed;background:rgba(6,10,20,.95);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:8px 12px;pointer-events:none;z-index:999;display:none;backdrop-filter:blur(14px);max-width:240px}
#tip .tn{font-size:13px;font-weight:700;margin-bottom:3px}
#tip .td{font-size:10px;color:var(--dim);line-height:1.5;white-space:pre-line}
/* Energy graph */
/* Mobile toggle button */
#mobToggle{display:none;position:absolute;top:12px;left:12px;z-index:50;width:40px;height:40px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:rgba(6,10,20,.9);color:var(--text);font-size:18px;cursor:pointer;backdrop-filter:blur(16px);font-family:inherit}
/* Mobile */
@media(max-width:768px){
  #mobToggle{display:flex;align-items:center;justify-content:center}
  #side{position:fixed;left:-290px;top:0;bottom:0;z-index:40;width:280px;transition:left .25s ease;box-shadow:4px 0 20px rgba(0,0,0,.5)}
  #side.open{left:0}
  #mobOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:35}
  #mobOverlay.show{display:block}
  #toolbar{top:10px;left:56px;transform:none;padding:4px 6px;gap:2px}
  #toolbar .tbtn{padding:6px 8px;font-size:10px}
  #toolbar .danger{padding:6px 8px;font-size:10px}
  #statsBar{top:auto;bottom:48px;right:8px;font-size:9px;padding:4px 8px}
  #dispBar{bottom:8px;left:8px;gap:2px;padding:3px 5px;flex-wrap:wrap;max-width:calc(100vw - 16px)}
  #dispBar .tbtn{padding:4px 7px;font-size:9px}
  #molP{bottom:80px;left:8px;font-size:10px}
  #molP .oval{font-size:11px}
  .envSection{padding:8px 10px}
  .srow label{font-size:9px;min-width:50px}
  .srow span{font-size:9px;min-width:30px}
}
@media(max-width:480px){
  #toolbar{flex-wrap:wrap;max-width:calc(100vw - 70px)}
  #statsBar{font-size:8px}
  #dispBar .tbtn{padding:3px 5px;font-size:8px}
}
</style>
</head>
<body>
<div id="mobOverlay"></div>
<div id="app">
<div id="side">
<div id="sideHead"><h1><b>ATOM</b><span>.LAB</span></h1></div>
<!-- Tabs -->
<div id="sideTabs">
<button class="stab active" data-tab="elements">⚛ Elements</button>
<button class="stab" data-tab="structures">◈ Build</button>
<button class="stab" data-tab="orbitals">☁ Orbitals</button>
</div>
<!-- Elements Tab -->
<div class="tabPanel active" id="tab-elements">
<div style="padding:6px 8px 4px"><input type="text" id="elSearch" placeholder="Search elements..."></div>
<div class="catWrap" id="catBtns">
<button class="catChip catF active" data-cat="all">All</button>
<button class="catChip catF" data-cat="nonmetal" style="color:#27ae60">Nonmetal</button>
<button class="catChip catF" data-cat="metal" style="color:#2ecc71">Metal</button>
<button class="catChip catF" data-cat="noble" style="color:#3498db">Noble</button>
<button class="catChip catF" data-cat="halogen" style="color:#1abc9c">Halogen</button>
<button class="catChip catF" data-cat="alkali" style="color:#9b59b6">Alkali</button>
<button class="catChip catF" data-cat="transition" style="color:#e67e22">Trans.</button>
<button class="catChip catF" data-cat="lanthanide" style="color:#5dade2">Lnth.</button>
<button class="catChip catF" data-cat="actinide" style="color:#c39bd3">Actn.</button>
</div>
<div class="elGrid" id="gEl"></div>
</div>
<!-- Structures Tab -->
<div class="tabPanel" id="tab-structures">
<div id="gStruct"></div>
</div>
<!-- Orbitals Tab (sidebar controls only) -->
<div class="tabPanel" id="tab-orbitals">
<div style="padding:8px 10px">
<div id="orbInfo">
<div><span id="orbElName" style="color:var(--acc2);font-size:18px;font-weight:800">Hydrogen</span><span id="orbElSym" style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:800;margin-left:6px;opacity:.5">H</span></div>
<div id="orbConfig" style="font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace;margin-top:2px">1s¹</div>
<div id="orbDesc" style="font-size:9px;color:var(--dim);margin-top:4px;line-height:1.5"></div>
</div>
</div>
<div style="padding:4px 10px">
<div style="font-size:10px;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;font-weight:700;margin-bottom:6px">Element</div>
<div class="orbElGrid" id="orbElGrid"></div>
</div>
<div style="padding:6px 10px">
<div style="font-size:10px;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;font-weight:700;margin-bottom:8px">Quantum Numbers</div>
<div class="qnRow"><span class="qnLabel">n</span><span class="qnDesc">shell</span><div class="qnBtns" id="orbNbtns"></div></div>
<div class="qnRow"><span class="qnLabel">ℓ</span><span class="qnDesc">shape</span><div class="qnBtns" id="orbLbtns"></div></div>
<div class="qnRow"><span class="qnLabel">m</span><span class="qnDesc">orient.</span><div class="qnBtns" id="orbMbtns"></div></div>
<div style="margin-top:8px">
<div style="display:flex;align-items:center;gap:6px">
<span style="font-size:10px;color:var(--dim);font-weight:700">Density</span>
<div class="qnBtns" id="orbPtsBtns"></div>
</div>
</div>
</div>
<div style="padding:4px 10px">
<div style="font-size:10px;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase;font-weight:700;margin-bottom:6px">View</div>
<div class="orbBtnRow">
<button class="orbBtn" id="orbSlice">Slice</button>
<button class="orbBtn active" id="orbSpin">Spin</button>
<button class="orbBtn" id="orbReset">Reset View</button>
<button class="orbBtn" id="orbAxes">Axes</button>
</div>
</div>
</div>
<!-- Environment always visible at bottom -->
<div class="envSection">
<div style="display:flex;align-items:center;justify-content:space-between"><div class="envTitle">Environment</div><button class="resetBtn" id="resetEnv">↺ Reset</button></div>
<div class="srow"><label>Temp</label><input type="range" id="sTemp" min="0" max="1000" value="345"><span id="sTempV">300 K</span></div>
<div class="srow"><label>E-Field</label><input type="range" id="sEF" min="-100" max="100" value="0"><span id="sEFV">0</span></div>
<div class="srow"><label>Gravity</label><input type="range" id="sGrav" min="0" max="100" value="0"><span id="sGravV">0</span></div>
<div class="srow"><label>Pressure</label><input type="range" id="sPres" min="0" max="100" value="0"><span id="sPresV">0</span></div>
<div class="srow"><label>Magnetic</label><input type="range" id="sMag" min="-100" max="100" value="0"><span id="sMagV">0</span></div>
<div class="srow"><label>Radiation</label><input type="range" id="sRad" min="0" max="100" value="0"><span id="sRadV">0</span></div>
<div style="display:flex;align-items:center;justify-content:space-between;margin-top:4px"><div class="envTitle">Simulation</div><button class="resetBtn" id="resetSim">↺ Reset</button></div>
<div class="srow"><label>Speed</label><input type="range" id="sSpd" min="1" max="10" value="5"><span id="sSpdV">5</span></div>
<div class="srow"><label>Atom Size</label><input type="range" id="sSize" min="30" max="200" value="100"><span id="sSizeV">100%</span></div>
<div class="srow"><label>Bond Str</label><input type="range" id="sBStr" min="10" max="300" value="100"><span id="sBStrV">100%</span></div>
<div class="srow"><label>Damping</label><input type="range" id="sDamp" min="80" max="100" value="95"><span id="sDampV">95%</span></div>
</div>
</div>
<div id="main">
<div id="cvWrap">
<canvas id="bgCv"></canvas>
<canvas id="mainCv"></canvas>
<canvas id="uiCv"></canvas>
<!-- Orbital 3D overlay (hidden until tab active) -->
<div id="orbWrap" style="display:none;position:absolute;inset:0;z-index:15;background:#020510">
<canvas id="orbCv" style="width:100%;height:100%;display:block"></canvas>
<div id="orbHUD" style="position:absolute;top:12px;left:50%;transform:translateX(-50%);font-family:'JetBrains Mono',monospace;font-size:11px;color:rgba(17,138,178,.5);font-weight:700;letter-spacing:1px;pointer-events:none">ORBITAL PROBABILITY CLOUD</div>
</div>
<!-- Mobile sidebar toggle -->
<button id="mobToggle">☰</button>
<!-- Floating toolbar -->
<div id="toolbar">
<button class="tbtn danger" id="bClear">✕ Clear</button>
<div style="width:1px;height:24px;background:rgba(255,255,255,.1);margin:0 4px"></div>
<div id="gTool" style="display:flex;gap:3px"></div>
</div>
<!-- Stats top-right -->
<div id="statsBar"><span id="aCnt">0</span> atoms · <span id="bCnt">0</span> bonds · <span id="mCnt">0</span> molecules</div>
<!-- Energy graph bottom-right -->
<!-- Display toggles -->
<div id="dispBar">
<button class="tbtn" id="bInfo">Info</button>
<div style="width:1px;height:20px;background:rgba(255,255,255,.1);margin:0 2px"></div>
<button class="tbtn active" id="bShells">Shells</button>
<button class="tbtn" id="bOrbitals">Orbitals</button>
<button class="tbtn active" id="bBonds">Bonds</button>
<button class="tbtn" id="bCharges">Charges</button>
<button class="tbtn active" id="bHBonds">H-Bonds</button>
</div>
<div class="panel" id="infoP"><div class="olbl">Element</div><div class="oval" id="iEl">—</div><div class="olbl">Electrons</div><div class="oval" id="iElec">—</div><div class="olbl">Bonds</div><div class="oval" id="iBond">—</div><div class="olbl">Shared Pairs</div><div class="oval" id="iShared">—</div><div class="olbl">Lone Pairs</div><div class="oval" id="iLone">—</div><div class="olbl">Charge</div><div class="oval" id="iChrg">—</div><div class="olbl">Molecule</div><div class="oval" id="iMol">—</div></div>
<div class="panel" id="molP"><div class="olbl">Mode</div><div class="oval" id="modeName">Place H</div></div>
<div id="bondLog"></div>
</div></div></div>
<div id="tip"><div class="tn"></div><div class="td"></div></div>
<script>
// === ELEMENT DATA ===
// === ALL 118 ELEMENTS ===
// Format: z, sym, name, mass, radius(visual), color(CPK-ish), valence(common), shells(electron config), eneg(Pauling), cat(category), desc
const _E=(z,sym,name,mass,rad,col,val,sh,en,cat,desc)=>({z,sym,name,mass,radius:rad,color:col,valence:val,shells:sh,eneg:en,cat,desc});
const EL={
// Period 1
H:  _E(1,'H','Hydrogen',1,25,'#FFFFFF',1,[1],2.2,'nonmetal','Lightest element. 1 bond. Most abundant in universe.'),
He: _E(2,'He','Helium',4,20,'#D9FFFF',0,[2],0,'noble','Noble gas. Full shell. Inert.'),
// Period 2
Li: _E(3,'Li','Lithium',7,34,'#CC80FF',1,[2,1],0.98,'alkali','Lightest metal. 1 valence electron.'),
Be: _E(4,'Be','Beryllium',9,30,'#2ecc71',2,[2,2],1.57,'metal','Alkaline earth. Toxic. 2 bonds.'),
B:  _E(5,'B','Boron',11,28,'#FFB5B5',3,[2,3],2.04,'nonmetal','Metalloid. 3 bonds. Used in glass.'),
C:  _E(6,'C','Carbon',12,34,'#333333',4,[2,4],2.55,'nonmetal','4 bonds. Backbone of organic chemistry.'),
N:  _E(7,'N','Nitrogen',14,32,'#3050F8',3,[2,5],3.04,'nonmetal','3 bonds + 1 lone pair. 78% of air.'),
O:  _E(8,'O','Oxygen',16,30,'#FF0D0D',2,[2,6],3.44,'nonmetal','2 bonds + 2 lone pairs. Essential for life.'),
F:  _E(9,'F','Fluorine',19,28,'#90E050',1,[2,7],3.98,'halogen','Most electronegative. 1 bond.'),
Ne: _E(10,'Ne','Neon',20,24,'#B3E3F5',0,[2,8],0,'noble','Noble gas. Glows orange-red in tubes.'),
// Period 3
Na: _E(11,'Na','Sodium',23,38,'#AB82FF',1,[2,8,1],0.93,'alkali','Soft alkali metal. Reacts violently with water.'),
Mg: _E(12,'Mg','Magnesium',24,36,'#8AFF00',2,[2,8,2],1.31,'metal','Alkaline earth. Burns bright white.'),
Al: _E(13,'Al','Aluminum',27,34,'#BFA6A6',3,[2,8,3],1.61,'metal','Light metal. 3 bonds.'),
Si: _E(14,'Si','Silicon',28,34,'#F0C8A0',4,[2,8,4],1.9,'nonmetal','Metalloid. Semiconductors. 4 bonds.'),
P:  _E(15,'P','Phosphorus',31,32,'#FF8000',3,[2,8,5],2.19,'nonmetal','3-5 bonds. Essential for DNA/ATP.'),
S:  _E(16,'S','Sulfur',32,32,'#FFFF30',2,[2,8,6],2.58,'nonmetal','2-6 bonds. Yellow solid. Smells.'),
Cl: _E(17,'Cl','Chlorine',35,35,'#1FF01F',1,[2,8,7],3.16,'halogen','Toxic green gas. 1 bond. Forms salts.'),
Ar: _E(18,'Ar','Argon',40,28,'#80D1E3',0,[2,8,8],0,'noble','Noble gas. 1% of atmosphere.'),
// Period 4
K:  _E(19,'K','Potassium',39,42,'#8F40D4',1,[2,8,8,1],0.82,'alkali','Alkali metal. Even more reactive than Na.'),
Ca: _E(20,'Ca','Calcium',40,40,'#3DFF00',2,[2,8,8,2],1,'metal','Alkaline earth. Bones and teeth.'),
Sc: _E(21,'Sc','Scandium',45,38,'#e67e22',3,[2,8,9,2],1.36,'transition','First transition metal.'),
Ti: _E(22,'Ti','Titanium',48,37,'#BFC2C7',4,[2,8,10,2],1.54,'transition','Strong, light metal. Aircraft.'),
V:  _E(23,'V','Vanadium',51,36,'#e67e22',5,[2,8,11,2],1.63,'transition','Hard steel-blue metal.'),
Cr: _E(24,'Cr','Chromium',52,35,'#e67e22',6,[2,8,13,1],1.66,'transition','Chrome plating. Blue-silver.'),
Mn: _E(25,'Mn','Manganese',55,35,'#e67e22',4,[2,8,13,2],1.55,'transition','Steel production.'),
Fe: _E(26,'Fe','Iron',56,36,'#E06633',3,[2,8,14,2],1.83,'transition','Most used metal. Rusts.'),
Co: _E(27,'Co','Cobalt',59,35,'#e67e22',3,[2,8,15,2],1.88,'transition','Blue pigment. Magnets.'),
Ni: _E(28,'Ni','Nickel',59,35,'#e67e22',2,[2,8,16,2],1.91,'transition','Corrosion resistant. Coins.'),
Cu: _E(29,'Cu','Copper',64,35,'#C88033',2,[2,8,18,1],1.9,'transition','Excellent conductor. Turns green.'),
Zn: _E(30,'Zn','Zinc',65,34,'#7D80B0',2,[2,8,18,2],1.65,'transition','Galvanizing. Immune system.'),
Ga: _E(31,'Ga','Gallium',70,34,'#2ecc71',3,[2,8,18,3],1.81,'metal','Melts in your hand (30°C).'),
Ge: _E(32,'Ge','Germanium',73,33,'#27ae60',4,[2,8,18,4],2.01,'nonmetal','Semiconductor. Used in transistors.'),
As: _E(33,'As','Arsenic',75,33,'#27ae60',3,[2,8,18,5],2.18,'nonmetal','Metalloid. Toxic. Used in semiconductors.'),
Se: _E(34,'Se','Selenium',79,32,'#27ae60',2,[2,8,18,6],2.55,'nonmetal','Essential trace element. Photoelectric.'),
Br: _E(35,'Br','Bromine',80,33,'#A62929',1,[2,8,18,7],2.96,'halogen','Red-brown liquid halogen.'),
Kr: _E(36,'Kr','Krypton',84,28,'#5CB8D1',0,[2,8,18,8],0,'noble','Noble gas. Used in photography flash.'),
// Period 5
Rb: _E(37,'Rb','Rubidium',85,44,'#9b59b6',1,[2,8,18,8,1],0.82,'alkali','Soft alkali. Ignites in air.'),
Sr: _E(38,'Sr','Strontium',88,42,'#2ecc71',2,[2,8,18,8,2],0.95,'metal','Red flame color. Fireworks.'),
Y:  _E(39,'Y','Yttrium',89,40,'#e67e22',3,[2,8,18,9,2],1.22,'transition','Superconductors. LEDs.'),
Zr: _E(40,'Zr','Zirconium',91,38,'#e67e22',4,[2,8,18,10,2],1.33,'transition','Nuclear reactors. Corrosion resistant.'),
Nb: _E(41,'Nb','Niobium',93,37,'#e67e22',5,[2,8,18,12,1],1.6,'transition','Superconducting alloys.'),
Mo: _E(42,'Mo','Molybdenum',96,36,'#e67e22',6,[2,8,18,13,1],2.16,'transition','High melting point. Steel alloys.'),
Tc: _E(43,'Tc','Technetium',98,36,'#e67e22',7,[2,8,18,13,2],1.9,'transition','First synthetic element. Radioactive.'),
Ru: _E(44,'Ru','Ruthenium',101,36,'#e67e22',4,[2,8,18,15,1],2.2,'transition','Platinum group. Catalysts.'),
Rh: _E(45,'Rh','Rhodium',103,35,'#e67e22',3,[2,8,18,16,1],2.28,'transition','Most expensive precious metal.'),
Pd: _E(46,'Pd','Palladium',106,35,'#e67e22',2,[2,8,18,18,0],2.2,'transition','Catalytic converters. Hydrogen absorber.'),
Ag: _E(47,'Ag','Silver',108,36,'#C0C0C0',1,[2,8,18,18,1],1.93,'transition','Best conductor. Antibacterial.'),
Cd: _E(48,'Cd','Cadmium',112,35,'#e67e22',2,[2,8,18,18,2],1.69,'transition','Toxic. Batteries. Yellow pigment.'),
In: _E(49,'In','Indium',115,35,'#2ecc71',3,[2,8,18,18,3],1.78,'metal','Soft. Touch screens (ITO).'),
Sn: _E(50,'Sn','Tin',119,35,'#668080',4,[2,8,18,18,4],1.96,'metal','Tin cans. Solder. Two allotropes.'),
Sb: _E(51,'Sb','Antimony',122,34,'#27ae60',3,[2,8,18,18,5],2.05,'nonmetal','Metalloid. Flame retardants.'),
Te: _E(52,'Te','Tellurium',128,34,'#27ae60',2,[2,8,18,18,6],2.1,'nonmetal','Rare metalloid. Thermoelectric.'),
I:  _E(53,'I','Iodine',127,35,'#940094',1,[2,8,18,18,7],2.66,'halogen','Purple vapor. Thyroid essential.'),
Xe: _E(54,'Xe','Xenon',131,30,'#429EB0',0,[2,8,18,18,8],2.6,'noble','Noble gas. Can form compounds.'),
// Period 6
Cs: _E(55,'Cs','Cesium',133,48,'#9b59b6',1,[2,8,18,18,8,1],0.79,'alkali','Most reactive stable metal.Atomic clocks.'),
Ba: _E(56,'Ba','Barium',137,44,'#2ecc71',2,[2,8,18,18,8,2],0.89,'metal','Green flame. X-ray contrast.'),
// Lanthanides 57-71
La: _E(57,'La','Lanthanum',139,42,'#5dade2',3,[2,8,18,18,9,2],1.1,'lanthanide','First lanthanide. Camera lenses.'),
Ce: _E(58,'Ce','Cerium',140,41,'#5dade2',3,[2,8,18,19,9,2],1.12,'lanthanide','Most abundant rare earth. Lighter flints.'),
Pr: _E(59,'Pr','Praseodymium',141,41,'#5dade2',3,[2,8,18,21,8,2],1.13,'lanthanide','Green glass colorant.'),
Nd: _E(60,'Nd','Neodymium',144,41,'#5dade2',3,[2,8,18,22,8,2],1.14,'lanthanide','Strongest permanent magnets.'),
Pm: _E(61,'Pm','Promethium',145,41,'#5dade2',3,[2,8,18,23,8,2],1.13,'lanthanide','Radioactive. Luminous paint.'),
Sm: _E(62,'Sm','Samarium',150,41,'#5dade2',3,[2,8,18,24,8,2],1.17,'lanthanide','Magnets. Cancer treatment.'),
Eu: _E(63,'Eu','Europium',152,41,'#5dade2',3,[2,8,18,25,8,2],1.2,'lanthanide','Red phosphor in TVs.'),
Gd: _E(64,'Gd','Gadolinium',157,40,'#5dade2',3,[2,8,18,25,9,2],1.2,'lanthanide','MRI contrast agent.'),
Tb: _E(65,'Tb','Terbium',159,40,'#5dade2',3,[2,8,18,27,8,2],1.1,'lanthanide','Green phosphor. Fuel cells.'),
Dy: _E(66,'Dy','Dysprosium',163,40,'#5dade2',3,[2,8,18,28,8,2],1.22,'lanthanide','Magnets. Nuclear reactors.'),
Ho: _E(67,'Ho','Holmium',165,40,'#5dade2',3,[2,8,18,29,8,2],1.23,'lanthanide','Strongest magnetic moment.'),
Er: _E(68,'Er','Erbium',167,40,'#5dade2',3,[2,8,18,30,8,2],1.24,'lanthanide','Pink glass. Fiber optic amplifiers.'),
Tm: _E(69,'Tm','Thulium',169,40,'#5dade2',3,[2,8,18,31,8,2],1.25,'lanthanide','Rarest lanthanide. X-ray source.'),
Yb: _E(70,'Yb','Ytterbium',173,40,'#5dade2',3,[2,8,18,32,8,2],1.1,'lanthanide','Atomic clocks. Stress gauges.'),
Lu: _E(71,'Lu','Lutetium',175,39,'#5dade2',3,[2,8,18,32,9,2],1.27,'lanthanide','Last lanthanide. PET scanners.'),
// Period 6 continued
Hf: _E(72,'Hf','Hafnium',178,38,'#e67e22',4,[2,8,18,32,10,2],1.3,'transition','Nuclear control rods. Heat resistant.'),
Ta: _E(73,'Ta','Tantalum',181,37,'#e67e22',5,[2,8,18,32,11,2],1.5,'transition','Capacitors. Surgical implants.'),
W:  _E(74,'W','Tungsten',184,36,'#2194D6',6,[2,8,18,32,12,2],2.36,'transition','Highest melting point (3422°C).'),
Re: _E(75,'Re','Rhenium',186,36,'#e67e22',4,[2,8,18,32,13,2],1.9,'transition','Jet engine superalloys.'),
Os: _E(76,'Os','Osmium',190,36,'#e67e22',4,[2,8,18,32,14,2],2.2,'transition','Densest element. Blue-silver.'),
Ir: _E(77,'Ir','Iridium',192,36,'#e67e22',4,[2,8,18,32,15,2],2.2,'transition','Most corrosion resistant metal.'),
Pt: _E(78,'Pt','Platinum',195,36,'#D0D0E0',2,[2,8,18,32,17,1],2.28,'transition','Catalysts. Jewelry. Very rare.'),
Au: _E(79,'Au','Gold',197,36,'#FFD123',1,[2,8,18,32,18,1],2.54,'transition','The classic precious metal. Excellent conductor.'),
Hg: _E(80,'Hg','Mercury',201,36,'#B8B8D0',2,[2,8,18,32,18,2],2,'transition','Only liquid metal at room temp. Toxic.'),
Tl: _E(81,'Tl','Thallium',204,36,'#2ecc71',1,[2,8,18,32,18,3],1.62,'metal','Extremely toxic. Formerly rat poison.'),
Pb: _E(82,'Pb','Lead',207,36,'#575961',2,[2,8,18,32,18,4],2.33,'metal','Dense, toxic. Batteries. Radiation shield.'),
Bi: _E(83,'Bi','Bismuth',209,35,'#2ecc71',3,[2,8,18,32,18,5],2.02,'metal','Rainbow oxide crystals. Pepto-Bismol.'),
Po: _E(84,'Po','Polonium',209,35,'#27ae60',2,[2,8,18,32,18,6],2,'nonmetal','Radioactive. Used to poison Litvinenko.'),
At: _E(85,'At','Astatine',210,34,'#1abc9c',1,[2,8,18,32,18,7],2.2,'halogen','Rarest natural element. Radioactive halogen.'),
Rn: _E(86,'Rn','Radon',222,32,'#428296',0,[2,8,18,32,18,8],0,'noble','Radioactive noble gas. Home hazard.'),
// Period 7
Fr: _E(87,'Fr','Francium',223,48,'#9b59b6',1,[2,8,18,32,18,8,1],0.7,'alkali','Most reactive metal. ~30g exists at once.'),
Ra: _E(88,'Ra','Radium',226,44,'#2ecc71',2,[2,8,18,32,18,8,2],0.9,'metal','Radioactive. Glows blue. Marie Curie.'),
// Actinides 89-103
Ac: _E(89,'Ac','Actinium',227,42,'#c39bd3',3,[2,8,18,32,18,9,2],1.1,'actinide','First actinide. Glows blue in dark.'),
Th: _E(90,'Th','Thorium',232,41,'#c39bd3',4,[2,8,18,32,18,10,2],1.3,'actinide','Nuclear fuel candidate.'),
Pa: _E(91,'Pa','Protactinium',231,41,'#c39bd3',5,[2,8,18,32,20,9,2],1.5,'actinide','Rare radioactive actinide.'),
U:  _E(92,'U','Uranium',238,41,'#008FFF',6,[2,8,18,32,21,9,2],1.38,'actinide','Nuclear fission fuel. Dense.'),
Np: _E(93,'Np','Neptunium',237,41,'#c39bd3',5,[2,8,18,32,22,9,2],1.36,'actinide','First transuranium element.'),
Pu: _E(94,'Pu','Plutonium',244,41,'#c39bd3',4,[2,8,18,32,24,8,2],1.28,'actinide','Nuclear weapons and reactors.'),
Am: _E(95,'Am','Americium',243,41,'#c39bd3',3,[2,8,18,32,25,8,2],1.3,'actinide','Smoke detectors.'),
Cm: _E(96,'Cm','Curium',247,41,'#c39bd3',3,[2,8,18,32,25,9,2],1.3,'actinide','Named after Marie Curie.'),
Bk: _E(97,'Bk','Berkelium',247,41,'#c39bd3',3,[2,8,18,32,27,8,2],1.3,'actinide','Named after Berkeley, CA.'),
Cf: _E(98,'Cf','Californium',251,41,'#c39bd3',3,[2,8,18,32,28,8,2],1.3,'actinide','Neutron source. Extremely radioactive.'),
Es: _E(99,'Es','Einsteinium',252,41,'#c39bd3',3,[2,8,18,32,29,8,2],1.3,'actinide','Named after Einstein.'),
Fm: _E(100,'Fm','Fermium',257,41,'#c39bd3',3,[2,8,18,32,30,8,2],1.3,'actinide','Only microgram quantities made.'),
Md: _E(101,'Md','Mendelevium',258,41,'#c39bd3',3,[2,8,18,32,31,8,2],1.3,'actinide','Named after Mendeleev.'),
No: _E(102,'No','Nobelium',259,41,'#c39bd3',2,[2,8,18,32,32,8,2],1.3,'actinide','Named after Alfred Nobel.'),
Lr: _E(103,'Lr','Lawrencium',262,41,'#c39bd3',3,[2,8,18,32,32,8,3],1.3,'actinide','Last actinide.'),
// Period 7 continued
Rf: _E(104,'Rf','Rutherfordium',267,38,'#e67e22',4,[2,8,18,32,32,10,2],0,'transition','Synthetic. Seconds half-life.'),
Db: _E(105,'Db','Dubnium',268,37,'#e67e22',5,[2,8,18,32,32,11,2],0,'transition','Synthetic. Named after Dubna.'),
Sg: _E(106,'Sg','Seaborgium',271,37,'#e67e22',6,[2,8,18,32,32,12,2],0,'transition','Synthetic. Named after Seaborg.'),
Bh: _E(107,'Bh','Bohrium',270,37,'#e67e22',7,[2,8,18,32,32,13,2],0,'transition','Synthetic superheavy.'),
Hs: _E(108,'Hs','Hassium',277,36,'#e67e22',4,[2,8,18,32,32,14,2],0,'transition','Named after Hesse, Germany.'),
Mt: _E(109,'Mt','Meitnerium',276,36,'#e67e22',3,[2,8,18,32,32,15,2],0,'transition','Named after Lise Meitner.'),
Ds: _E(110,'Ds','Darmstadtium',281,36,'#e67e22',2,[2,8,18,32,32,17,1],0,'transition','Millisecond half-life.'),
Rg: _E(111,'Rg','Roentgenium',280,36,'#e67e22',1,[2,8,18,32,32,18,1],0,'transition','Named after Röntgen.'),
Cn: _E(112,'Cn','Copernicium',285,36,'#e67e22',2,[2,8,18,32,32,18,2],0,'transition','May be a gas at room temp.'),
Nh: _E(113,'Nh','Nihonium',284,36,'#2ecc71',1,[2,8,18,32,32,18,3],0,'metal','Named after Japan (Nihon).'),
Fl: _E(114,'Fl','Flerovium',289,36,'#2ecc71',2,[2,8,18,32,32,18,4],0,'metal','Superheavy. Very short-lived.'),
Mc: _E(115,'Mc','Moscovium',288,36,'#2ecc71',1,[2,8,18,32,32,18,5],0,'metal','Named after Moscow.'),
Lv: _E(116,'Lv','Livermorium',293,36,'#2ecc71',2,[2,8,18,32,32,18,6],0,'metal','Named after Livermore lab.'),
Ts: _E(117,'Ts','Tennessine',294,35,'#1abc9c',1,[2,8,18,32,32,18,7],0,'halogen','Newest halogen. Synthetic.'),
Og: _E(118,'Og','Oganesson',294,34,'#3498db',0,[2,8,18,32,32,18,8],0,'noble','Heaviest element. May not be a gas.'),
};
// Tool modes
const TOOLS={
place:{name:'Place Atom',desc:'Click to place selected element'},
drag:{name:'Drag Atom',desc:'Click and drag atoms to move them'},
bond:{name:'Force Bond',desc:'Click two atoms to force a bond'},
break_b:{name:'Break Bond',desc:'Click a bond to break it'},
ionize:{name:'Ionize',desc:'Click atom to remove/add electron'},
eraser:{name:'Eraser',desc:'Click atom to remove it'},
};
let mode='place',selEl='H';

// === SIMULATION STATE ===
let atoms=[],bonds=[],nextId=1;
let W,H,simSpd=5,envTemp=300,eField=0,grav=0;
let pressure=0,magField=0,radiation=0,atomScale=100,bondStr=100,damping=95;
let showShells=true,showOrbitals=false,showBonds=true,showCharges=false,showVel=false,showInfo=false,showHBonds=true;
let dragAtom=null,dragOff={x:0,y:0},bondStart=null;
let mX=0,mY=0,hoverAtom=null;
// Radiation visual particles
let radParticles=[];
// Electron transfer particles (fly from one atom to another)
let eTransferFX=[];
// Hydrogen bonds (weak intermolecular)
let hBonds=[];
let vdwPairs=[];

// Spectral emission colors — real flame test / emission spectra colors
const SPECTRAL={
  H:'#ff4466',Li:'#cc0022',Na:'#ffaa00',K:'#cc88ff',Rb:'#cc2244',Cs:'#6644cc',
  Ca:'#ff4400',Sr:'#cc1111',Ba:'#88cc44',Cu:'#33cc66',B:'#66cc44',
  Fe:'#ffcc44',Mn:'#ddcc88',Zn:'#44ccaa',Pb:'#88aaff',In:'#4444ff',
  Ne:'#ff4422',Ar:'#cc88ff',Kr:'#aaffaa',Xe:'#8888ff',
  He:'#ffeecc',C:'#ff6644',N:'#ff8844',O:'#eeffcc',S:'#5588ff',
  P:'#ccffcc',Mg:'#ffffff',Al:'#cccccc',Ti:'#cccccc',Cr:'#cccccc',
  Co:'#4488ff',Ni:'#44cc88',Ag:'#cccccc',Au:'#ffdd44',
  U:'#44ff44',Ra:'#44ffcc',Th:'#ff8844'
};

// Radioactive decay chains
const DECAY={
  U:{half:1000,products:['Th','He'],type:'alpha'},
  Th:{half:1500,products:['Ra','He'],type:'alpha'},
  Ra:{half:800,products:['Rn','He'],type:'alpha'},
  Rn:{half:600,products:['Po','He'],type:'alpha'},
  Po:{half:400,products:['Pb','He'],type:'alpha'},
  Pu:{half:1200,products:['U','He'],type:'alpha'},
  Am:{half:900,products:['Np','He'],type:'alpha'},
  Np:{half:1100,products:['Pa','He'],type:'alpha'},
};

// Canvases
const bgCv=document.getElementById('bgCv'),bgCtx=bgCv.getContext('2d');
const cv=document.getElementById('mainCv'),ctx=cv.getContext('2d');
const uiCv=document.getElementById('uiCv'),uiCtx=uiCv.getContext('2d');

function resize(){
  const w=document.getElementById('cvWrap');
  W=w.clientWidth;H=w.clientHeight;
  [bgCv,cv,uiCv].forEach(c=>{c.width=W;c.height=H;c.style.width=W+'px';c.style.height=H+'px'});
  drawBg();
}

function drawBg(){
  bgCtx.fillStyle='#020510';bgCtx.fillRect(0,0,W,H);
  // Subtle grid
  bgCtx.strokeStyle='rgba(255,255,255,.015)';bgCtx.lineWidth=1;
  for(let x=0;x<W;x+=40){bgCtx.beginPath();bgCtx.moveTo(x,0);bgCtx.lineTo(x,H);bgCtx.stroke()}
  for(let y=0;y<H;y+=40){bgCtx.beginPath();bgCtx.moveTo(0,y);bgCtx.lineTo(W,y);bgCtx.stroke()}
}

// === ATOM FACTORY ===
function addAtom(sym,x,y){
  const el=EL[sym];if(!el)return null;
  const a={id:nextId++,sym,x,y,vx:0,vy:0,charge:0,electrons:el.z,bonds:[],fx:0,fy:0,bondCooldown:0};
  atoms.push(a);return a;
}

function getEl(a){return EL[a.sym]}
function maxBonds(a){const el=getEl(a);return el?el.valence:0}
function curBonds(a){return a.bonds.length}
function canBond(a){return curBonds(a)<maxBonds(a)}
function bondExists(a1,a2){return bonds.some(b=>(b.a===a1.id&&b.b===a2.id)||(b.a===a2.id&&b.b===a1.id))}
function dist(a,b){return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2)}

function addBond(a1,a2,order=1){
  if(bondExists(a1,a2))return false;
  const el1=getEl(a1),el2=getEl(a2);
  const enDiff=Math.abs(el1.eneg-el2.eneg);
  // Determine bond type
  const metalCats=['alkali','alkaline','transition','post-transition','lanthanide','actinide'];
  const isMetal1=metalCats.includes(el1.cat);
  const isMetal2=metalCats.includes(el2.cat);
  let type='covalent'; // default
  if(isMetal1&&isMetal2)type='metallic';
  else if(enDiff>1.7)type='ionic';
  else if(enDiff>0.4)type='polar';
  // Coordinate bond: electron-rich atom donating to electron-poor (e.g. N→B, O→metal)
  // Detected when one atom has lone pairs and other has empty orbitals
  const lp1=loneElectrons(a1),lp2=loneElectrons(a2);
  const empty1=el1.valence-a1.bonds.length,empty2=el2.valence-a2.bonds.length;
  if(type==='covalent'&&((lp1>=2&&empty2>=1&&a2.bonds.length>=el2.valence-1)||(lp2>=2&&empty1>=1&&a1.bonds.length>=el1.valence-1))){
    type='coordinate';
  }
  // Electron sharing: each atom contributes 1 electron per bond order to shared pool
  // For ionic: full transfer. For covalent/polar: shared pair with polarity shift
  const b={a:a1.id,b:a2.id,order,type,enDiff,
    // Shared electrons: array of {fromA, fromB} — each bond order = 1 pair
    sharedE:order, // number of shared electron PAIRS
    // Polarity: 0=equal share, positive=shifted toward atom b, negative=toward a
    polarity:el2.eneg>el1.eneg?(el2.eneg-el1.eneg)/4:-(el1.eneg-el2.eneg)/4,
    // Phase for electron animation
    phase:Math.random()*Math.PI*2,
  };
  bonds.push(b);a1.bonds.push(b);a2.bonds.push(b);

  if(type==='ionic'){
    // Full electron transfer: less electroneg atom loses, more gains
    const donor=el1.eneg<el2.eneg?a1:a2;
    const acceptor=donor===a1?a2:a1;
    for(let i=0;i<order;i++){
      if(donor.electrons>0){donor.electrons--;donor.charge++;acceptor.electrons++;acceptor.charge--;
        // Spawn electron transfer animation
        eTransferFX.push({sx:donor.x,sy:donor.y,ex:acceptor.x,ey:acceptor.y,x:donor.x,y:donor.y,t:0});
      }
    }
    b.sharedE=0; // no sharing in ionic bonds
  } else {
    // Covalent/polar: valence electrons participate in bond
    // Each atom contributes 1 electron per bond → shared pair lives between them
    // We track this by reducing "free" valence electrons on each atom
    // The shared electrons are rendered between the atoms
  }
  return true;
}

// Get count of LONE PAIR electrons on an atom (unbonded valence electrons)
function lonePairs(a){
  const el=getEl(a);
  const outerE=el.shells[el.shells.length-1]||0;
  const bondingE=a.bonds.reduce((s,b)=>s+(b.type==='ionic'?0:b.order),0);
  const remaining=outerE-bondingE+a.charge; // charge affects available electrons
  return Math.max(0,Math.floor(remaining/2)); // lone pairs
}
function loneElectrons(a){
  const el=getEl(a);
  const outerE=el.shells[el.shells.length-1]||0;
  const bondingE=a.bonds.reduce((s,b)=>s+(b.type==='ionic'?0:b.order),0);
  return Math.max(0,outerE-bondingE+a.charge);
}
function removeBond(b){
  const i=bonds.indexOf(b);if(i>=0)bonds.splice(i,1);
  const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);
  if(a1){const j=a1.bonds.indexOf(b);if(j>=0)a1.bonds.splice(j,1)}
  if(a2){const j=a2.bonds.indexOf(b);if(j>=0)a2.bonds.splice(j,1)}
  // Cooldown — prevent re-bonding for 120 frames
  const now=performance.now();
  if(a1)a1.bondCooldown=now;
  if(a2)a2.bondCooldown=now;
  // Kick atoms apart
  if(a1&&a2){
    const dx=a2.x-a1.x,dy=a2.y-a1.y;
    const d=Math.sqrt(dx*dx+dy*dy)||1;
    const kick=5;
    a1.vx-=dx/d*kick;a1.vy-=dy/d*kick;
    a2.vx+=dx/d*kick;a2.vy+=dy/d*kick;
  }
}
function removeAtom(at){
  [...at.bonds].forEach(b=>removeBond(b));
  const i=atoms.indexOf(at);if(i>=0)atoms.splice(i,1);
}

// === MOLECULE DETECTION ===
function getMolecules(){
  const visited=new Set(),mols=[];
  atoms.forEach(a=>{
    if(visited.has(a.id))return;
    const mol=[],queue=[a];
    while(queue.length){const c=queue.shift();if(visited.has(c.id))continue;visited.add(c.id);mol.push(c);
      c.bonds.forEach(b=>{const oid=b.a===c.id?b.b:b.a;const oa=atoms.find(x=>x.id===oid);if(oa&&!visited.has(oa.id))queue.push(oa)})}
    mols.push(mol);
  });
  return mols;
}
function molFormula(mol){
  const cnt={};mol.forEach(a=>{cnt[a.sym]=(cnt[a.sym]||0)+1});
  const syms=Object.keys(cnt);
  // Electropositive elements first (metals/alkali/alkaline), then C, H, then nonmetals alphabetical
  // This matches standard inorganic naming: NaCl not ClNa, CaO not OCa, etc.
  const metalOrder=['Fr','Cs','Rb','K','Na','Li','Ra','Ba','Sr','Ca','Mg','Be','Al','Ga','In','Tl',
    'Ti','V','Cr','Mn','Fe','Co','Ni','Cu','Zn','Zr','Nb','Mo','Ag','Cd','Sn','W','Pt','Au','Hg','Pb','Bi',
    'Sc','Y','La','Ce','Nd','Sm','Eu','Gd','Tb','Dy','Ho','Er','Yb','Lu','Hf','Ta','Re','Os','Ir',
    'Rh','Ru','Pd','Ac','Th','U','Np','Pu'];
  const sorted=syms.sort((a,b)=>{
    const ai=metalOrder.indexOf(a),bi=metalOrder.indexOf(b);
    // Both metals: order by metal priority
    if(ai>=0&&bi>=0)return ai-bi;
    // Metal before nonmetal
    if(ai>=0)return -1;if(bi>=0)return 1;
    // Then C, then H
    if(a==='C')return -1;if(b==='C')return 1;
    if(a==='H')return -1;if(b==='H')return 1;
    // Then alphabetical
    return a.localeCompare(b);
  });
  let f='';sorted.forEach(s=>{f+=s+(cnt[s]>1?cnt[s]:'')});
  return f;
}
// Also try common alternate orderings when looking up names
function nameMolecule(f){
  const names={
// === DIATOMIC ELEMENTS ===
'H2':'Hydrogen gas','O2':'Oxygen gas','N2':'Nitrogen gas','F2':'Fluorine gas','Cl2':'Chlorine gas','Br2':'Bromine','I2':'Iodine',
// === WATER & ICE ===
'H2O':'Water','H3O':'Hydronium ion','OH':'Hydroxide',
// === SIMPLE OXIDES ===
'CO':'Carbon monoxide','CO2':'Carbon dioxide','NO':'Nitric oxide','NO2':'Nitrogen dioxide','N2O':'Nitrous oxide (Laughing gas)',
'N2O3':'Dinitrogen trioxide','N2O4':'Dinitrogen tetroxide','N2O5':'Dinitrogen pentoxide',
'SO2':'Sulfur dioxide','SO3':'Sulfur trioxide','P2O5':'Phosphorus pentoxide','P4O10':'Phosphorus pentoxide',
'Cl2O':'Dichlorine monoxide','ClO2':'Chlorine dioxide','Cl2O7':'Dichlorine heptoxide',
'As2O3':'Arsenic trioxide','As2O5':'Arsenic pentoxide','SeO2':'Selenium dioxide','B2O3':'Boron trioxide',
// === SIMPLE HYDRIDES ===
'CH4':'Methane','NH3':'Ammonia','PH3':'Phosphine','AsH3':'Arsine','SbH3':'Stibine',
'H2S':'Hydrogen sulfide','H2Se':'Hydrogen selenide','H2Te':'Hydrogen telluride',
'SiH4':'Silane','GeH4':'Germane','BH3':'Borane','B2H6':'Diborane',
// === HYDROGEN HALIDES ===
'HF':'Hydrofluoric acid','HCl':'Hydrochloric acid','HBr':'Hydrobromic acid','HI':'Hydroiodic acid',
// === OXYACIDS ===
'HNO3':'Nitric acid','HNO2':'Nitrous acid','H2SO4':'Sulfuric acid','H2SO3':'Sulfurous acid',
'H3PO4':'Phosphoric acid','H2CO3':'Carbonic acid','HClO':'Hypochlorous acid',
'HClO2':'Chlorous acid','HClO3':'Chloric acid','HClO4':'Perchloric acid',
'H3BO3':'Boric acid','H2CrO4':'Chromic acid','H2Cr2O7':'Dichromic acid',
'HMnO4':'Permanganic acid','H2MoO4':'Molybdic acid',
// === PEROXIDES ===
'H2O2':'Hydrogen peroxide','Na2O2':'Sodium peroxide','BaO2':'Barium peroxide',
// === ALKALI METAL COMPOUNDS ===
'LiH':'Lithium hydride','LiF':'Lithium fluoride','LiCl':'Lithium chloride','LiBr':'Lithium bromide','LiI':'Lithium iodide',
'Li2O':'Lithium oxide','Li2S':'Lithium sulfide','LiOH':'Lithium hydroxide','Li2CO3':'Lithium carbonate',
'LiNO3':'Lithium nitrate','Li3N':'Lithium nitride','LiAlH4':'Lithium aluminum hydride',
'NaH':'Sodium hydride','NaF':'Sodium fluoride','NaCl':'Table salt','NaBr':'Sodium bromide','NaI':'Sodium iodide',
'Na2O':'Sodium oxide','Na2S':'Sodium sulfide','NaOH':'Sodium hydroxide (Lye)','Na2CO3':'Soda ash',
'NaHCO3':'Baking soda','NaNO3':'Chile saltpeter','Na2SO4':'Glauber\'s salt','NaClO':'Bleach',
'NaCN':'Sodium cyanide','Na3PO4':'Trisodium phosphate','NaF':'Sodium fluoride',
'Na2SiO3':'Sodium silicate (Water glass)','NaBH4':'Sodium borohydride',
'KH':'Potassium hydride','KF':'Potassium fluoride','KCl':'Potassium chloride','KBr':'Potassium bromide','KI':'Potassium iodide',
'K2O':'Potassium oxide','K2S':'Potassium sulfide','KOH':'Potassium hydroxide (Caustic potash)',
'K2CO3':'Potash','KHCO3':'Potassium bicarbonate','KNO3':'Saltpeter (Potassium nitrate)',
'K2SO4':'Potassium sulfate','KMnO4':'Potassium permanganate','K2Cr2O7':'Potassium dichromate',
'KCN':'Potassium cyanide','KClO3':'Potassium chlorate',
'RbCl':'Rubidium chloride','RbF':'Rubidium fluoride',
'CsF':'Cesium fluoride','CsCl':'Cesium chloride','CsBr':'Cesium bromide',
// === ALKALINE EARTH COMPOUNDS ===
'BeO':'Beryllium oxide','BeF2':'Beryllium fluoride','BeCl2':'Beryllium chloride',
'MgO':'Magnesia','MgH2':'Magnesium hydride','MgF2':'Magnesium fluoride',
'MgCl2':'Magnesium chloride','MgBr2':'Magnesium bromide',
'MgS':'Magnesium sulfide','MgCO3':'Magnesite','MgSO4':'Epsom salt',
'Mg3N2':'Magnesium nitride','MgSiO3':'Magnesium silicate',
'CaO':'Quicklime','CaH2':'Calcium hydride','CaF2':'Fluorite',
'CaCl2':'Calcium chloride','CaBr2':'Calcium bromide',
'CaS':'Calcium sulfide','CaCO3':'Limestone/Chalk','CaSO4':'Gypsum',
'Ca3P2':'Calcium phosphide','Ca3N2':'Calcium nitride',
'CaSiO3':'Wollastonite','Ca3Al2Si3O12':'Garnet',
'SrO':'Strontium oxide','SrCl2':'Strontium chloride','SrCO3':'Strontianite','SrSO4':'Celestite',
'BaO':'Barium oxide','BaCl2':'Barium chloride','BaCO3':'Witherite','BaSO4':'Barite',
'BaCrO4':'Barium chromate','BaTiO3':'Barium titanate',
// === BORON COMPOUNDS ===
'BF3':'Boron trifluoride','BCl3':'Boron trichloride','BN':'Boron nitride',
'B4C':'Boron carbide','B2O3':'Boron oxide','NaBF4':'Sodium tetrafluoroborate',
// === CARBON COMPOUNDS (INORGANIC) ===
'CS2':'Carbon disulfide','COS':'Carbonyl sulfide','CCl4':'Carbon tetrachloride',
'CF4':'Carbon tetrafluoride','CBr4':'Carbon tetrabromide','CI4':'Carbon tetraiodide',
'SiC':'Silicon carbide (Carborundum)','CaC2':'Calcium carbide','Al4C3':'Aluminum carbide',
// === SILICON COMPOUNDS ===
'SiO2':'Quartz/Sand','SiF4':'Silicon tetrafluoride','SiCl4':'Silicon tetrachloride',
'SiS2':'Silicon disulfide','Si3N4':'Silicon nitride','SiC':'Carborundum',
// === NITROGEN COMPOUNDS ===
'NCl3':'Nitrogen trichloride','NF3':'Nitrogen trifluoride','N2H4':'Hydrazine',
'NH4Cl':'Ammonium chloride (Sal ammoniac)','NH4NO3':'Ammonium nitrate',
'NH4OH':'Ammonium hydroxide','NaN3':'Sodium azide',
// === PHOSPHORUS COMPOUNDS ===
'PCl3':'Phosphorus trichloride','PCl5':'Phosphorus pentachloride',
'PF3':'Phosphorus trifluoride','PF5':'Phosphorus pentafluoride',
'P4S10':'Phosphorus pentasulfide','Ca3P2O8':'Calcium phosphate',
// === SULFUR COMPOUNDS ===
'SF6':'Sulfur hexafluoride','SCl2':'Sulfur dichloride','S2Cl2':'Disulfur dichloride',
'SOCl2':'Thionyl chloride','SO2Cl2':'Sulfuryl chloride',
'Na2S2O3':'Sodium thiosulfate (Hypo)','FeS2':'Iron pyrite (Fool\'s gold)',
// === HALOGEN INTERCOMPOUNDS ===
'ClF':'Chlorine monofluoride','ClF3':'Chlorine trifluoride','ClF5':'Chlorine pentafluoride',
'BrF':'Bromine fluoride','BrF3':'Bromine trifluoride','BrF5':'Bromine pentafluoride',
'BrCl':'Bromine chloride','ICl':'Iodine monochloride','ICl3':'Iodine trichloride',
'IF5':'Iodine pentafluoride','IF7':'Iodine heptafluoride',
// === TRANSITION METAL — TITANIUM ===
'TiO2':'Titanium dioxide (Titania)','TiCl4':'Titanium tetrachloride','TiN':'Titanium nitride',
'TiC':'Titanium carbide','TiF4':'Titanium tetrafluoride',
// === VANADIUM ===
'V2O5':'Vanadium pentoxide','VCl3':'Vanadium trichloride','VO2':'Vanadium dioxide',
// === CHROMIUM ===
'Cr2O3':'Chromium oxide (Chrome green)','CrO3':'Chromium trioxide','CrCl3':'Chromium chloride',
'CrF3':'Chromium fluoride','K2CrO4':'Potassium chromate',
// === MANGANESE ===
'MnO':'Manganese oxide','MnO2':'Manganese dioxide (Pyrolusite)','Mn2O3':'Manganese(III) oxide',
'MnCl2':'Manganese chloride','MnS':'Manganese sulfide',
// === IRON ===
'FeO':'Wüstite','Fe2O3':'Hematite (Rust)','Fe3O4':'Magnetite',
'FeCl2':'Ferrous chloride','FeCl3':'Ferric chloride','FeBr2':'Ferrous bromide','FeBr3':'Ferric bromide',
'FeF2':'Ferrous fluoride','FeF3':'Ferric fluoride',
'FeS':'Iron sulfide','FeS2':'Pyrite (Fool\'s gold)','FeSO4':'Green vitriol',
'Fe2S3':'Iron(III) sulfide','FeCO3':'Siderite','Fe3C':'Cementite',
// === COBALT ===
'CoO':'Cobalt oxide','Co2O3':'Cobalt(III) oxide','CoCl2':'Cobalt chloride',
'CoS':'Cobalt sulfide','CoSO4':'Cobalt sulfate',
// === NICKEL ===
'NiO':'Nickel oxide','NiCl2':'Nickel chloride','NiS':'Nickel sulfide',
'NiSO4':'Nickel sulfate','NiF2':'Nickel fluoride','Ni3S2':'Heazlewoodite',
// === COPPER ===
'CuO':'Copper(II) oxide (Tenorite)','Cu2O':'Copper(I) oxide (Cuprite)',
'CuCl':'Copper(I) chloride','CuCl2':'Copper(II) chloride',
'CuBr':'Copper(I) bromide','CuBr2':'Copper(II) bromide',
'CuF2':'Copper fluoride','CuI':'Copper iodide',
'CuS':'Covellite','Cu2S':'Chalcocite','CuSO4':'Blue vitriol',
'CuCO3':'Malachite (green)','Cu3N':'Copper nitride',
'CuFeS2':'Chalcopyrite',
// === ZINC ===
'ZnO':'Zinc oxide (Chinese white)','ZnCl2':'Zinc chloride','ZnBr2':'Zinc bromide',
'ZnF2':'Zinc fluoride','ZnI2':'Zinc iodide',
'ZnS':'Sphalerite','ZnSO4':'White vitriol','ZnCO3':'Smithsonite',
// === SILVER ===
'AgF':'Silver fluoride','AgCl':'Silver chloride','AgBr':'Silver bromide','AgI':'Silver iodide',
'Ag2O':'Silver oxide','Ag2S':'Silver sulfide (Tarnish)','AgNO3':'Lunar caustic',
'AgCN':'Silver cyanide',
// === GOLD ===
'AuCl':'Gold(I) chloride','AuCl3':'Gold(III) chloride','Au2O3':'Gold oxide',
// === PLATINUM ===
'PtCl2':'Platinum chloride','PtCl4':'Platinum tetrachloride','PtO2':'Platinum oxide (Adam\'s catalyst)',
// === MERCURY ===
'HgO':'Mercury oxide','HgCl2':'Mercuric chloride (Corrosive sublimate)','Hg2Cl2':'Calomel',
'HgS':'Cinnabar (Vermillion)','HgBr2':'Mercuric bromide','HgI2':'Mercuric iodide',
// === TIN ===
'SnO':'Tin(II) oxide','SnO2':'Tin dioxide (Cassiterite)','SnCl2':'Tin(II) chloride',
'SnCl4':'Tin(IV) chloride','SnF2':'Stannous fluoride (Toothpaste)','SnS':'Tin sulfide',
// === LEAD ===
'PbO':'Litharge (Lead oxide)','PbO2':'Lead dioxide','Pb3O4':'Red lead (Minium)',
'PbCl2':'Lead chloride','PbBr2':'Lead bromide','PbF2':'Lead fluoride',
'PbS':'Galena','PbSO4':'Anglesite','PbCO3':'Cerussite (White lead)',
'PbCrO4':'Chrome yellow','PbI2':'Lead iodide',
// === ALUMINUM ===
'Al2O3':'Alumina (Corundum/Sapphire/Ruby)','AlCl3':'Aluminum chloride',
'AlF3':'Aluminum fluoride','AlBr3':'Aluminum bromide',
'AlN':'Aluminum nitride','Al2S3':'Aluminum sulfide',
'AlOOH':'Boehmite','Al2SiO5':'Kyanite',
// === TUNGSTEN ===
'WO3':'Tungsten trioxide','WC':'Tungsten carbide','WF6':'Tungsten hexafluoride',
'WS2':'Tungsten disulfide','WCl6':'Tungsten hexachloride',
// === MOLYBDENUM ===
'MoO3':'Molybdenum trioxide','MoS2':'Molybdenite','MoCl5':'Molybdenum pentachloride',
// === URANIUM & NUCLEAR ===
'UO2':'Uranium dioxide (Yellowcake)','UO3':'Uranium trioxide','UF4':'Uranium tetrafluoride (Green salt)',
'UF6':'Uranium hexafluoride','UCl4':'Uranium tetrachloride','U3O8':'Triuranium octoxide',
'PuO2':'Plutonium dioxide','ThO2':'Thorium dioxide','ThF4':'Thorium tetrafluoride',
// === ORGANIC — ALKANES ===
'CH4':'Methane','C2H6':'Ethane','C3H8':'Propane','C4H10':'Butane','C5H12':'Pentane',
'C6H14':'Hexane','C7H16':'Heptane','C8H18':'Octane','C9H20':'Nonane','C10H22':'Decane',
// === ORGANIC — ALKENES ===
'C2H4':'Ethylene','C3H6':'Propylene','C4H8':'Butylene','C5H10':'Pentene',
// === ORGANIC — ALKYNES ===
'C2H2':'Acetylene','C3H4':'Propyne','C4H6':'Butyne',
// === ORGANIC — AROMATICS ===
'C6H6':'Benzene','C7H8':'Toluene','C8H10':'Xylene','C10H8':'Naphthalene',
'C14H10':'Anthracene','C6H5OH':'Phenol','C6H5NH2':'Aniline',
// === ORGANIC — ALCOHOLS ===
'CH4O':'Methanol (Wood alcohol)','C2H6O':'Ethanol (Drinking alcohol)',
'C3H8O':'Isopropanol (Rubbing alcohol)','C4H10O':'Butanol',
'C2H6O2':'Ethylene glycol (Antifreeze)','C3H8O3':'Glycerol',
// === ORGANIC — ALDEHYDES & KETONES ===
'CH2O':'Formaldehyde','C2H4O':'Acetaldehyde','C3H6O':'Acetone',
// === ORGANIC — CARBOXYLIC ACIDS ===
'CH2O2':'Formic acid','C2H4O2':'Acetic acid (Vinegar)','C3H6O2':'Propionic acid',
'C4H8O2':'Butyric acid','C6H8O7':'Citric acid','C4H6O6':'Tartaric acid',
'C7H6O2':'Benzoic acid','C9H8O4':'Aspirin','C18H36O2':'Stearic acid',
// === ORGANIC — ESTERS ===
'C4H8O2':'Ethyl acetate','C5H10O2':'Ethyl propanoate',
// === ORGANIC — AMINES ===
'CH5N':'Methylamine','C2H7N':'Ethylamine','C6H7N':'Aniline',
// === ORGANIC — AMINO ACIDS ===
'C2H5NO2':'Glycine','C3H7NO2':'Alanine','C5H9NO4':'Glutamic acid (MSG)',
// === ORGANIC — SUGARS ===
'C6H12O6':'Glucose/Fructose','C12H22O11':'Sucrose (Table sugar)',
'C5H10O5':'Ribose','C6H10O5':'Starch/Cellulose monomer',
// === ORGANIC — HALOGENATED ===
'CH3Cl':'Chloromethane','CH2Cl2':'Dichloromethane (DCM)','CHCl3':'Chloroform','CCl4':'Carbon tet',
'CH3F':'Fluoromethane','CH3Br':'Bromomethane','CH3I':'Iodomethane',
'C2H3Cl':'Vinyl chloride (PVC monomer)','C2HCl3':'Trichloroethylene',
'CF2Cl2':'Freon-12 (CFC)','CHF3':'Fluoroform','C2F4':'Tetrafluoroethylene (Teflon monomer)',
// === ORGANIC — NITROGEN ===
'HCN':'Hydrogen cyanide','CH3NO':'Formamide','C2H3N':'Acetonitrile',
'CO(NH2)2':'Urea','C3H3N':'Acrylonitrile','C5H5N':'Pyridine','C4H5N':'Pyrrole',
'C6H5NO2':'Nitrobenzene','CH3NO2':'Nitromethane',
'C3H5N3O9':'Nitroglycerin','C7H5N3O6':'TNT',
// === ORGANIC — SULFUR ===
'CH4S':'Methanethiol','C2H6S':'Ethanethiol','C2H6SO':'DMSO',
// === ORGANIC — ETHERS ===
'C2H6O':'Diethyl ether','C4H10O':'Diethyl ether',
// === ORGANIC — POLYMERS (MONOMERS) ===
'C3H6':'Propylene (Polypropylene monomer)','C8H8':'Styrene (Polystyrene monomer)',
'C2H4O':'Ethylene oxide','C4H6':'Butadiene (Rubber monomer)',
// === PHARMACEUTICALS ===
'C8H9NO2':'Acetaminophen (Tylenol)','C13H18O2':'Ibuprofen',
'C10H13N5O4':'Adenosine','C9H8O4':'Aspirin','C17H21NO4':'Cocaine',
'C21H30O2':'THC (Cannabis)','C8H10N4O2':'Caffeine','C10H15N':'Methamphetamine',
'C20H25N3O':'LSD','C11H17NO3':'Epinephrine (Adrenaline)',
'C22H30O5':'Prednisone','C27H44O':'Cholesterol (Vitamin D base)',
// === VITAMINS ===
'C6H8O6':'Vitamin C (Ascorbic acid)','C28H44O':'Vitamin D2',
'C31H46O2':'Vitamin E','C20H30O':'Vitamin A (Retinol)',
// === BIOLOGICAL ===
'C5H4N4O3':'Uric acid','C4H8N2O3':'Asparagine','C3H7NO3':'Serine',
'C10H16N5O13P3':'ATP','C10H12N5O7P':'AMP',
// === EXPLOSIVES & ENERGETICS ===
'C3H5N3O9':'Nitroglycerin','C7H5N3O6':'TNT','C3H6N6O6':'RDX',
'C4H8N8O8':'HMX','CH4N2O':'Urea','NH4ClO4':'Ammonium perchlorate',
// === GEMS & MINERALS ===
'Al2O3':'Corundum (Ruby/Sapphire)','SiO2':'Quartz/Sand','CaCO3':'Calcite/Limestone',
'FeTiO3':'Ilmenite','CaWO4':'Scheelite','ZrSiO4':'Zircon',
'BaTiO3':'Barium titanate','SrTiO3':'Strontium titanate',
'MgAl2O4':'Spinel','Be3Al2Si6O18':'Beryl (Emerald/Aquamarine)',
// === CERAMICS & INDUSTRIAL ===
'WC':'Tungsten carbide','BN':'Boron nitride','SiC':'Silicon carbide',
'TiN':'Titanium nitride','AlN':'Aluminum nitride','Si3N4':'Silicon nitride',
'ZrO2':'Zirconia','CeO2':'Ceria','Y2O3':'Yttria',
'Fe3O4':'Magnetite','MnFe2O4':'Manganese ferrite',
// === PIGMENTS ===
'PbCrO4':'Chrome yellow','Cr2O3':'Chrome green','Fe2O3':'Red ochre',
'TiO2':'Titanium white','ZnO':'Zinc white','BaSO4':'Blanc fixe',
'CoAl2O4':'Cobalt blue','CdS':'Cadmium yellow','CdSe':'Cadmium red',
'HgS':'Vermillion','PbCO3':'Lead white','Cu2CO3':'Verdigris',
// === COMMON HOUSEHOLD ===
'NaHCO3':'Baking soda','NaClO':'Bleach','NaCl':'Table salt',
'CaSO4':'Plaster of Paris','CaCO3':'Chalk','KNO3':'Saltpeter',
'Na2B4O7':'Borax','SiO2':'Glass (Silica)','Al2O3SiO2':'Porcelain',
'Na2CO3':'Washing soda','KAl2Si3AlO10':'Mica',
// === SEMICONDUCTOR ===
'GaAs':'Gallium arsenide','GaN':'Gallium nitride','InP':'Indium phosphide',
'GaP':'Gallium phosphide','InAs':'Indium arsenide','InSb':'Indium antimonide',
'CdTe':'Cadmium telluride','ZnSe':'Zinc selenide','ZnTe':'Zinc telluride',
'SiGe':'Silicon-Germanium','AlGaAs':'Aluminum gallium arsenide',
// === SUPERCONDUCTORS ===
'Nb3Sn':'Niobium-tin (Superconductor)','NbTi':'Niobium-titanium',
'MgB2':'Magnesium diboride',
// === BATTERY MATERIALS ===
'LiCoO2':'Lithium cobalt oxide (Phone battery)','LiFePO4':'Lithium iron phosphate',
'LiMn2O4':'Lithium manganese oxide','NiMH':'Nickel metal hydride',
  };
  if(names[f])return names[f];
  // Reverse lookup: try all permutations of element+count pairs
  const parts=f.match(/([A-Z][a-z]?\d*)/g);
  if(parts&&parts.length>=2&&parts.length<=4){
    // Try reversed
    const rev=parts.slice().reverse().join('');
    if(names[rev])return names[rev];
    // Try all 2-element permutations
    if(parts.length===2){
      const t=[parts[1]+parts[0]];
      for(const x of t)if(names[x])return names[x];
    }
    // 3-element: try all 6 permutations
    if(parts.length===3){
      const p=parts,perms=[p[0]+p[2]+p[1],p[1]+p[0]+p[2],p[1]+p[2]+p[0],p[2]+p[0]+p[1],p[2]+p[1]+p[0]];
      for(const x of perms)if(names[x])return names[x];
    }
  }
  // === AUTO-GENERATE NAME using chemistry naming rules ===
  return autoName(f);
}
function autoName(f){
  // Parse formula into {sym, count} pairs
  const pairs=[];const re=/([A-Z][a-z]?)(\d*)/g;let mm;
  while((mm=re.exec(f))!==null){if(mm[1])pairs.push({sym:mm[1],n:parseInt(mm[2])||1})}
  if(pairs.length===0)return null;
  if(pairs.length===1&&pairs[0].n===1)return EL[pairs[0].sym]?EL[pairs[0].sym].name:pairs[0].sym;

  const prefixes=['','mono','di','tri','tetra','penta','hexa','hepta','octa','nona','deca'];
  const anionSuffix={
    'H':'hydride','O':'oxide','S':'sulfide','N':'nitride','C':'carbide','F':'fluoride',
    'Cl':'chloride','Br':'bromide','I':'iodide','Se':'selenide','Te':'telluride',
    'P':'phosphide','As':'arsenide','Si':'silicide','B':'boride',
  };
  const elName={
    'H':'hydrogen','He':'helium','Li':'lithium','Be':'beryllium','B':'boron','C':'carbon',
    'N':'nitrogen','O':'oxygen','F':'fluorine','Ne':'neon','Na':'sodium','Mg':'magnesium',
    'Al':'aluminum','Si':'silicon','P':'phosphorus','S':'sulfur','Cl':'chlorine','Ar':'argon',
    'K':'potassium','Ca':'calcium','Sc':'scandium','Ti':'titanium','V':'vanadium','Cr':'chromium',
    'Mn':'manganese','Fe':'iron','Co':'cobalt','Ni':'nickel','Cu':'copper','Zn':'zinc',
    'Ga':'gallium','Ge':'germanium','As':'arsenic','Se':'selenium','Br':'bromine','Kr':'krypton',
    'Rb':'rubidium','Sr':'strontium','Y':'yttrium','Zr':'zirconium','Nb':'niobium','Mo':'molybdenum',
    'Tc':'technetium','Ru':'ruthenium','Rh':'rhodium','Pd':'palladium','Ag':'silver','Cd':'cadmium',
    'In':'indium','Sn':'tin','Sb':'antimony','Te':'tellurium','I':'iodine','Xe':'xenon',
    'Cs':'cesium','Ba':'barium','La':'lanthanum','Ce':'cerium','Pr':'praseodymium','Nd':'neodymium',
    'Pm':'promethium','Sm':'samarium','Eu':'europium','Gd':'gadolinium','Tb':'terbium',
    'Dy':'dysprosium','Ho':'holmium','Er':'erbium','Tm':'thulium','Yb':'ytterbium','Lu':'lutetium',
    'Hf':'hafnium','Ta':'tantalum','W':'tungsten','Re':'rhenium','Os':'osmium','Ir':'iridium',
    'Pt':'platinum','Au':'gold','Hg':'mercury','Tl':'thallium','Pb':'lead','Bi':'bismuth',
    'Po':'polonium','At':'astatine','Rn':'radon','Fr':'francium','Ra':'radium',
    'Ac':'actinium','Th':'thorium','Pa':'protactinium','U':'uranium','Np':'neptunium','Pu':'plutonium',
    'Am':'americium','Cm':'curium','Bk':'berkelium','Cf':'californium','Es':'einsteinium',
    'Fm':'fermium','Md':'mendelevium','No':'nobelium','Lr':'lawrencium',
    'Rf':'rutherfordium','Db':'dubnium','Sg':'seaborgium','Bh':'bohrium','Hs':'hassium',
    'Mt':'meitnerium','Ds':'darmstadtium','Rg':'roentgenium','Cn':'copernicium',
    'Nh':'nihonium','Fl':'flerovium','Mc':'moscovium','Lv':'livermorium','Ts':'tennessine','Og':'oganesson',
  };
  const metalCats=['alkali','metal','transition','lanthanide','actinide'];
  const isMetal=s=>EL[s]&&metalCats.includes(EL[s].cat);

  // Single element, multiple atoms (e.g. O3)
  if(pairs.length===1){
    const p=pairs[0],name=elName[p.sym]||p.sym;
    if(p.n===2)return name.charAt(0).toUpperCase()+name.slice(1)+' gas';
    if(p.n===3&&p.sym==='O')return 'Ozone';
    return (prefixes[p.n]||p.n)+name;
  }

  // Two-element compound
  if(pairs.length===2){
    const a=pairs[0],b=pairs[1];
    const aName=elName[a.sym]||a.sym;const bName=elName[b.sym]||b.sym;
    const bSuffix=anionSuffix[b.sym]||(bName.replace(/ine$|ygen$|orus$|on$|ur$/,'')+'ide');

    // Metal + nonmetal → "[Metal] [anion-ide]"
    if(isMetal(a.sym)&&!isMetal(b.sym)){
      const cap=aName.charAt(0).toUpperCase()+aName.slice(1);
      const pre=b.n>1?(prefixes[b.n]||b.n)+bSuffix:bSuffix;
      return cap+' '+pre;
    }
    // Nonmetal + nonmetal → "[prefix][name] [prefix][anion-ide]"
    const aPre=a.n>1?(prefixes[a.n]||a.n):'';
    const bPre=(prefixes[b.n]||b.n);
    const aFull=aPre+aName;
    const bFull=bPre+bSuffix;
    return aFull.charAt(0).toUpperCase()+aFull.slice(1)+' '+bFull;
  }

  // Three+ elements → best effort: "[first element] [second+third]-ate/compound"
  if(pairs.length>=3){
    const first=pairs[0];const fName=elName[first.sym]||first.sym;
    const cap=fName.charAt(0).toUpperCase()+fName.slice(1);
    const rest=pairs.slice(1).map(p=>(elName[p.sym]||p.sym)+(p.n>1?'('+p.n+')':'')).join('-');
    // Detect common polyatomic patterns
    const restF=pairs.slice(1).map(p=>p.sym+((p.n>1)?p.n:'')).join('');
    if(restF.match(/CO3/))return cap+' carbonate';
    if(restF.match(/SO4/))return cap+' sulfate';
    if(restF.match(/SO3/))return cap+' sulfite';
    if(restF.match(/NO3/))return cap+' nitrate';
    if(restF.match(/NO2/))return cap+' nitrite';
    if(restF.match(/PO4/))return cap+' phosphate';
    if(restF.match(/ClO4/))return cap+' perchlorate';
    if(restF.match(/ClO3/))return cap+' chlorate';
    if(restF.match(/ClO/))return cap+' hypochlorite';
    if(restF.match(/CrO4/))return cap+' chromate';
    if(restF.match(/Cr2O7/))return cap+' dichromate';
    if(restF.match(/MnO4/))return cap+' permanganate';
    if(restF.match(/SiO3/))return cap+' silicate';
    if(restF.match(/OH/)){
      if(first.n>1)return cap+'('+first.n+') hydroxide';
      return cap+' hydroxide';
    }
    if(restF.match(/CN/))return cap+' cyanide';
    return cap+' '+rest+' compound';
  }
  return null;
}
// Pretty formula with subscripts
function prettyFormula(f){
  return f.replace(/(\d+)/g,(m)=>{const sub='₀₁₂₃₄₅₆₇₈₉';return m.split('').map(d=>sub[+d]).join('')});
}

// === PHYSICS ===
function simulate(dt){
  const kB=0.001; // Boltzmann-ish scale factor
  const tempFactor=envTemp*kB;
  atoms.forEach(a=>{a.fx=0;a.fy=0});

  // Bond spring forces
  bonds.forEach(b=>{
    const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);if(!a1||!a2)return;
    const el1=getEl(a1),el2=getEl(a2);
    const bondLen=(el1.radius+el2.radius)*0.8/b.order; // shorter for double/triple
    const dx=a2.x-a1.x,dy=a2.y-a1.y;
    const d=Math.sqrt(dx*dx+dy*dy)||1;
    const f=(d-bondLen)*0.15*b.order*(bondStr/100); // spring force scaled by bond strength
    const fx=f*dx/d,fy=f*dy/d;
    a1.fx+=fx;a1.fy+=fy;a2.fx-=fx;a2.fy-=fy;
  });

  // Atom-atom repulsion (Lennard-Jones-ish)
  for(let i=0;i<atoms.length;i++){for(let j=i+1;j<atoms.length;j++){
    const a=atoms[i],b=atoms[j];
    const dx=b.x-a.x,dy=b.y-a.y;const d2=dx*dx+dy*dy;
    const minD=(getEl(a).radius+getEl(b).radius)*0.7;
    if(d2<1)continue;
    const d=Math.sqrt(d2);
    // Repulsion when too close
    if(d<minD){
      const f=(minD-d)*0.5;const fx=f*dx/d,fy=f*dy/d;
      a.fx-=fx;a.fy-=fy;b.fx+=fx;b.fy+=fy;
    }
    // Cooldown check — recently broken bonds can't re-form
    const now=performance.now();
    const coolingA=a.bondCooldown&&(now-a.bondCooldown)<2000;
    const coolingB=b.bondCooldown&&(now-b.bondCooldown)<2000;
    // Weak attraction if both can bond and close enough (van der Waals)
    if(d<minD*3&&d>minD&&canBond(a)&&canBond(b)&&!bondExists(a,b)&&!coolingA&&!coolingB){
      const attract=0.02/(d/minD);
      a.fx+=attract*dx/d;a.fy+=attract*dy/d;
      b.fx-=attract*dx/d;b.fy-=attract*dy/d;
    }
    // Auto-bonding: if close enough and both have valence room and not cooling down
    if(d<minD*1.2&&canBond(a)&&canBond(b)&&!bondExists(a,b)&&!coolingA&&!coolingB){
      if(getEl(a).valence>0&&getEl(b).valence>0){
        addBond(a,b,1);
        logBond(a.sym+'–'+b.sym+' bond formed'+(bonds[bonds.length-1].type!=='covalent'?' ('+bonds[bonds.length-1].type+')':''));
      }
    }
  }}

  // === VSEPR GEOMETRY — enforce bond angles ===
  atoms.forEach(a=>{
    if(a.bonds.length<2)return;
    // Get all bonded neighbor positions
    const neighbors=a.bonds.map(b=>{
      const oid=b.a===a.id?b.b:b.a;return atoms.find(x=>x.id===oid)}).filter(Boolean);
    if(neighbors.length<2)return;
    // Target angles based on steric number (bonds + lone pairs)
    const lp=lonePairs(a);
    const steric=neighbors.length+lp;
    let targetAngle;
    if(steric===2)targetAngle=Math.PI; // 180° linear
    else if(steric===3)targetAngle=2*Math.PI/3; // 120° trigonal planar
    else if(steric===4)targetAngle=109.5*Math.PI/180; // tetrahedral
    else targetAngle=2*Math.PI/neighbors.length;
    // Apply angular spring forces between each pair of bonded neighbors
    for(let i=0;i<neighbors.length;i++){for(let j=i+1;j<neighbors.length;j++){
      const ni=neighbors[i],nj=neighbors[j];
      const ax1=ni.x-a.x,ay1=ni.y-a.y;const ax2=nj.x-a.x,ay2=nj.y-a.y;
      const d1=Math.sqrt(ax1*ax1+ay1*ay1)||1;const d2=Math.sqrt(ax2*ax2+ay2*ay2)||1;
      const cosA=(ax1*ax2+ay1*ay2)/(d1*d2);
      const curAngle=Math.acos(Math.max(-1,Math.min(1,cosA)));
      const angleDiff=curAngle-targetAngle;
      // Torque-like force perpendicular to each bond
      const strength=angleDiff*0.08;
      // Push ni and nj apart/together to fix angle
      const mx=(ni.x+nj.x)/2-a.x,my=(ni.y+nj.y)/2-a.y;
      const md=Math.sqrt(mx*mx+my*my)||1;
      if(angleDiff<0){// angle too small — push apart
        ni.fx+=(-my/md)*strength;ni.fy+=(mx/md)*strength;
        nj.fx+=(my/md)*strength;nj.fy+=(-mx/md)*strength;
      } else {// angle too big — pull together
        ni.fx+=(my/md)*strength;ni.fy+=(-mx/md)*strength;
        nj.fx+=(-my/md)*strength;nj.fy+=(mx/md)*strength;
      }
    }}
  });

  // Electric field — affects ions strongly, polar molecules weakly
  if(eField!==0){
    const ef=eField*0.01;
    atoms.forEach(a=>{
      // Direct force on ions
      if(a.charge!==0)a.fx+=a.charge*ef*20;
      // Polar molecules: atoms in ionic/polar bonds feel partial force based on electronegativity
      if(a.bonds.length>0){
        a.bonds.forEach(b=>{
          if(b.type==='ionic'||b.type==='polar'){
            // More electronegative atom pulls toward negative field direction
            const el=getEl(a);
            const polarity=b.a===a.id?-b.polarity:b.polarity;
            a.fx+=polarity*ef*3;
          }
        });
      }
    });
  }

  // Coulomb forces between charged atoms (ions attract/repel)
  for(let i=0;i<atoms.length;i++){
    if(atoms[i].charge===0)continue;
    for(let j=i+1;j<atoms.length;j++){
      if(atoms[j].charge===0)continue;
      const ai=atoms[i],aj=atoms[j];
      const dx=aj.x-ai.x,dy=aj.y-ai.y;
      const d2=dx*dx+dy*dy;if(d2<4)continue;
      const d=Math.sqrt(d2);
      // Coulomb: opposite charges attract, same repel
      const f=ai.charge*aj.charge*-0.8/(d2/1000+1); // negative product = attract
      const fx=f*dx/d,fy=f*dy/d;
      ai.fx+=fx;ai.fy+=fy;aj.fx-=fx;aj.fy-=fy;
    }
  }

  // Gravity
  if(grav>0)atoms.forEach(a=>{a.fy+=grav*0.01*getEl(a).mass});

  // Pressure — pushes atoms toward center, compresses everything
  if(pressure>0){
    const cx=W/2,cy=H/2,pf=pressure*0.003;
    atoms.forEach(a=>{
      const dx=cx-a.x,dy=cy-a.y;
      const d=Math.sqrt(dx*dx+dy*dy)||1;
      a.fx+=dx/d*pf*d*0.01;
      a.fy+=dy/d*pf*d*0.01;
    });
  }

  // Magnetic field — spins charged particles in circular orbits (Lorentz force)
  if(magField!==0){
    const mf=magField*0.002;
    atoms.forEach(a=>{
      if(a.charge!==0){
        // Lorentz: F = q(v × B) — perpendicular to velocity
        a.fx+=a.charge*a.vy*mf;
        a.fy-=a.charge*a.vx*mf;
      }
      // Paramagnetic metals get slight alignment force
      const el=getEl(a);
      if(el.cat==='transition'||el.cat==='lanthanide'){
        a.fy+=mf*0.3*(a.id%2?1:-1); // slight drift
      }
    });
  }

  // Radiation — random high-energy kicks, breaks bonds, ionizes atoms
  if(radiation>0){
    // Spawn ambient gamma rays from random edges
    if(Math.random()<radiation*0.008){
      const side=Math.floor(Math.random()*4);
      let rx,ry,rvx,rvy;
      const spd=6+Math.random()*6;
      if(side===0){rx=0;ry=Math.random()*H;rvx=spd;rvy=(Math.random()-.5)*2}
      else if(side===1){rx=W;ry=Math.random()*H;rvx=-spd;rvy=(Math.random()-.5)*2}
      else if(side===2){rx=Math.random()*W;ry=0;rvx=(Math.random()-.5)*2;rvy=spd}
      else{rx=Math.random()*W;ry=H;rvx=(Math.random()-.5)*2;rvy=-spd}
      radParticles.push({x:rx,y:ry,vx:rvx,vy:rvy,life:1,type:'gamma'});
    }
    atoms.forEach(a=>{
      // Random photon hit
      if(Math.random()<radiation*0.0004){
        const angle=Math.random()*Math.PI*2;
        const force=radiation*0.15;
        a.vx+=Math.cos(angle)*force;
        a.vy+=Math.sin(angle)*force;
        // Impact flash
        radParticles.push({x:a.x,y:a.y,vx:0,vy:0,life:1,type:'flash',r:8+Math.random()*12});
      }
      // Ionization by radiation
      if(Math.random()<radiation*0.00005&&a.electrons>0){
        a.electrons--;a.charge++;
        logBond(a.sym+' ionized by radiation → '+a.charge+'+');
        // Ejected electron particle
        const ea=Math.random()*Math.PI*2;
        radParticles.push({x:a.x,y:a.y,vx:Math.cos(ea)*5,vy:Math.sin(ea)*5,life:1,type:'electron'});
        // Flash
        for(let i=0;i<3;i++){
          const sa=Math.random()*Math.PI*2;
          radParticles.push({x:a.x,y:a.y,vx:Math.cos(sa)*3,vy:Math.sin(sa)*3,life:1,type:'spark'});
        }
      }
      // Bond breaking by radiation
      if(a.bonds.length>0&&Math.random()<radiation*0.0001){
        const b=a.bonds[Math.floor(Math.random()*a.bonds.length)];
        const oa=atoms.find(x=>x.id===(b.a===a.id?b.b:b.a));
        logBond('γ broke '+a.sym+'−'+(oa?oa.sym:'?'));
        // Break flash at midpoint
        if(oa){
          const mx=(a.x+oa.x)/2,my=(a.y+oa.y)/2;
          radParticles.push({x:mx,y:my,vx:0,vy:0,life:1,type:'flash',r:15});
          for(let i=0;i<4;i++){
            const sa=Math.random()*Math.PI*2;
            radParticles.push({x:mx,y:my,vx:Math.cos(sa)*4,vy:Math.sin(sa)*4,life:1,type:'spark'});
          }
        }
        removeBond(b);
      }
    });
  }
  // Update radiation particles
  for(let i=radParticles.length-1;i>=0;i--){
    const p=radParticles[i];
    p.x+=p.vx;p.y+=p.vy;
    p.life-=p.type==='gamma'?0.008:p.type==='flash'?0.06:0.025;
    if(p.life<=0||p.x<-20||p.x>W+20||p.y<-20||p.y>H+20)radParticles.splice(i,1);
  }

  // === HYDROGEN BONDS — weak intermolecular bonds ===
  hBonds=[];
  if(showHBonds){
    // Find H atoms bonded to electronegative atoms (O, N, F)
    const donors=[];
    atoms.forEach(a=>{
      if(a.sym==='H'&&a.bonds.length>0){
        const partner=atoms.find(x=>x.id===(a.bonds[0].a===a.id?a.bonds[0].b:a.bonds[0].a));
        if(partner&&(partner.sym==='O'||partner.sym==='N'||partner.sym==='F')){
          donors.push({h:a,donor:partner});
        }
      }
    });
    // Check for nearby acceptors (O, N, F with lone pairs on DIFFERENT molecules)
    const molMap=new Map();
    getMolecules().forEach((mol,mi)=>mol.forEach(a=>molMap.set(a.id,mi)));
    donors.forEach(({h,donor})=>{
      atoms.forEach(acc=>{
        if(acc===donor||acc===h)return;
        if(acc.sym!=='O'&&acc.sym!=='N'&&acc.sym!=='F')return;
        if(molMap.get(acc.id)===molMap.get(h.id))return; // same molecule, skip
        const d=dist(h,acc);
        if(d<60&&d>15){
          hBonds.push({h,acc,d});
          // Weak attraction
          const dx=acc.x-h.x,dy=acc.y-h.y;
          const f=0.008*(60-d)/60;
          h.fx+=dx/d*f;h.fy+=dy/d*f;
          acc.fx-=dx/d*f*0.3;acc.fy-=dy/d*f*0.3;
        }
      });
    });
  }

  // === VAN DER WAALS / LONDON DISPERSION — weak attraction between all nearby non-bonded atoms ===
  let vdwPairs=[];
  for(let i=0;i<atoms.length;i++){
    for(let j=i+1;j<atoms.length;j++){
      const ai=atoms[i],aj=atoms[j];
      if(bondExists(ai,aj))continue;
      const dx=aj.x-ai.x,dy=aj.y-ai.y;
      const d2=dx*dx+dy*dy;
      const cutoff=80; // detection range
      if(d2>cutoff*cutoff||d2<100)continue;
      const d=Math.sqrt(d2);
      // Strength scales with atom size (polarizability)
      const strength=(getEl(ai).radius+getEl(aj).radius)*0.00003;
      const f=strength*(cutoff-d)/cutoff;
      const fx=dx/d*f,fy=dy/d*f;
      ai.fx+=fx;ai.fy+=fy;aj.fx-=fx;aj.fy-=fy;
      // Track for rendering if close enough
      if(d<65)vdwPairs.push({a:ai,b:aj,d});
    }
  }

  // === RADIOACTIVE DECAY ===
  atoms.forEach(a=>{
    const decay=DECAY[a.sym];
    if(!decay)return;
    // Probability increases with temperature
    const tempBoost=1+envTemp/10000;
    if(Math.random()<tempBoost/decay.half){
      const el=getEl(a);
      // Transmute atom
      const newSym=decay.products[0];
      if(EL[newSym]){
        const oldSym=a.sym;
        a.sym=newSym;
        a.electrons=EL[newSym].z;
        a.charge=0;
        // Break all bonds
        [...a.bonds].forEach(b=>removeBond(b));
        // Spawn alpha particle (He) flying away
        if(decay.products[1]==='He'){
          const angle=Math.random()*Math.PI*2;
          const he=addAtom('He',a.x+Math.cos(angle)*20,a.y+Math.sin(angle)*20);
          he.vx=Math.cos(angle)*6;he.vy=Math.sin(angle)*6;
          he.bondCooldown=performance.now(); // don't re-bond
          // Alpha particle glow trail
          for(let i=0;i<5;i++){
            radParticles.push({x:a.x,y:a.y,vx:Math.cos(angle+(.5-Math.random())*.4)*(3+Math.random()*2),
              vy:Math.sin(angle+(.5-Math.random())*.4)*(3+Math.random()*2),life:1,type:'spark'});
          }
          radParticles.push({x:a.x,y:a.y,vx:0,vy:0,life:1,type:'flash',r:20});
        }
        // Recoil
        a.vx+=(Math.random()-.5)*3;a.vy+=(Math.random()-.5)*3;
        logBond('☢ '+oldSym+' → '+newSym+' + α');
      }
    }
  });

  // === ELECTRON TRANSFER ANIMATION ===
  // When ionic bond forms, animate the electron flying across
  // (hooked into addBond — see below)
  // Update existing transfer particles
  for(let i=eTransferFX.length-1;i>=0;i--){
    const p=eTransferFX[i];
    p.t+=0.06;
    if(p.t>=1){eTransferFX.splice(i,1);continue}
    p.x=p.sx+(p.ex-p.sx)*p.t+Math.sin(p.t*Math.PI*3)*8;
    p.y=p.sy+(p.ey-p.sy)*p.t+Math.cos(p.t*Math.PI*3)*8;
  }

  // Thermal motion + bond breaking
  atoms.forEach(a=>{
    const el=getEl(a);
    // Random thermal kick
    const thermalKick=Math.sqrt(tempFactor/el.mass)*0.8;
    a.fx+=(Math.random()-.5)*thermalKick;
    a.fy+=(Math.random()-.5)*thermalKick;
    // High temp breaks bonds (scaled by bond strength modifier)
    const breakThresh=2000*(bondStr/100);
    if(envTemp>breakThresh&&a.bonds.length>0&&Math.random()<(envTemp-breakThresh)/50000){
      const b=a.bonds[Math.floor(Math.random()*a.bonds.length)];
      const oa=atoms.find(x=>x.id===(b.a===a.id?b.b:b.a));
      logBond(a.sym+'-'+(oa?oa.sym:'?')+' bond broken');
      // Reverse ionic if applicable
      if(oa){
        const enDiff=Math.abs(el.eneg-getEl(oa).eneg);
        if(enDiff>1.7){a.charge=0;a.electrons=el.z;oa.charge=0;oa.electrons=getEl(oa).z}}
      removeBond(b);
    }
  });

  // Integrate — apply damping and atomScale modifiers
  const damp=damping/100;
  atoms.forEach(a=>{
    if(a===dragAtom)return; // skip dragged
    const el=getEl(a);const invM=1/el.mass;
    a.vx=(a.vx+a.fx*invM*dt)*damp;
    a.vy=(a.vy+a.fy*invM*dt)*damp;
    // Speed limit
    const spd=Math.sqrt(a.vx*a.vx+a.vy*a.vy);
    if(spd>8){a.vx*=8/spd;a.vy*=8/spd}
    a.x+=a.vx*dt;a.y+=a.vy*dt;
    // Walls — use scaled radius
    const r=el.radius*(atomScale/100);
    if(a.x<r){a.x=r;a.vx*=-0.5}if(a.x>W-r){a.x=W-r;a.vx*=-0.5}
    if(a.y<r){a.y=r;a.vy*=-0.5}if(a.y>H-r){a.y=H-r;a.vy*=-0.5}
  });
}

// === RENDERING ===
const _t=()=>performance.now()*0.001; // time in seconds
function render(){
  ctx.clearRect(0,0,W,H);
  const mols=getMolecules();
  const t=_t();

  // === 1. BOND LINES (underneath everything) ===
  if(showBonds)bonds.forEach(b=>{
    const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);if(!a1||!a2)return;
    const dx=a2.x-a1.x,dy=a2.y-a1.y,d=Math.sqrt(dx*dx+dy*dy)||1;
    const nx=-dy/d,ny=dx/d; // unit perpendicular
    const gap=4; // spacing between multi-bond lines
    // Bond color by type
    let col;
    if(b.type==='metallic')col='rgba(255,215,80,.3)';
    else if(b.type==='ionic')col='rgba(255,200,80,.25)';
    else if(b.type==='polar')col='rgba(100,200,255,.2)';
    else col='rgba(255,255,255,.15)';
    
    if(b.type==='metallic'){
      // Metallic bond: broad glowing golden band
      ctx.lineWidth=4;ctx.strokeStyle='rgba(255,215,80,.12)';ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(a1.x,a1.y);ctx.lineTo(a2.x,a2.y);ctx.stroke();
      ctx.lineWidth=2;ctx.strokeStyle='rgba(255,215,80,.25)';
      ctx.beginPath();ctx.moveTo(a1.x,a1.y);ctx.lineTo(a2.x,a2.y);ctx.stroke();
      // Delocalized electron sea
      for(let e=0;e<3;e++){
        const et=t*1.5+e*2.1+b.phase;
        const frac=(Math.sin(et)*0.5+0.5);
        const drift=Math.sin(et*3.7+e)*6;
        const ex=a1.x+dx*frac+nx*drift;
        const ey=a1.y+dy*frac+ny*drift;
        const eg=ctx.createRadialGradient(ex,ey,0,ex,ey,5);
        eg.addColorStop(0,'rgba(255,230,120,.6)');eg.addColorStop(0.5,'rgba(255,215,80,.15)');eg.addColorStop(1,'transparent');
        ctx.fillStyle=eg;ctx.beginPath();ctx.arc(ex,ey,5,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='rgba(255,240,180,.7)';ctx.beginPath();ctx.arc(ex,ey,1.5,0,Math.PI*2);ctx.fill();
      }
    } else if(b.type==='coordinate'){
      // Coordinate/dative bond: arrow from donor to acceptor
      // Donor is the one with lone pairs
      const lp1=loneElectrons(a1),lp2=loneElectrons(a2);
      const donor=lp1>=lp2?a1:a2,acc2=donor===a1?a2:a1;
      const adx=acc2.x-donor.x,ady=acc2.y-donor.y,ad=Math.sqrt(adx*adx+ady*ady)||1;
      // Dashed line
      ctx.setLineDash([5,3]);ctx.strokeStyle='rgba(180,120,255,.35)';ctx.lineWidth=2;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(donor.x,donor.y);ctx.lineTo(acc2.x,acc2.y);ctx.stroke();
      ctx.setLineDash([]);
      // Arrow head at acceptor end
      const aLen=8,aW=4;
      const tipX=acc2.x-adx/ad*getEl(acc2).radius*(atomScale/100);
      const tipY=acc2.y-ady/ad*getEl(acc2).radius*(atomScale/100);
      ctx.fillStyle='rgba(180,120,255,.5)';
      ctx.beginPath();
      ctx.moveTo(tipX,tipY);
      ctx.lineTo(tipX-adx/ad*aLen+(-ady/ad)*aW,tipY-ady/ad*aLen+(adx/ad)*aW);
      ctx.lineTo(tipX-adx/ad*aLen-(-ady/ad)*aW,tipY-ady/ad*aLen-(adx/ad)*aW);
      ctx.closePath();ctx.fill();
    } else {
      ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.lineCap='round';
      // Single bond = regular line
      // Double/triple = parallel lines + pi cloud
      for(let i=0;i<b.order;i++){
        const off=(i-(b.order-1)/2)*gap;
        ctx.beginPath();ctx.moveTo(a1.x+nx*off,a1.y+ny*off);ctx.lineTo(a2.x+nx*off,a2.y+ny*off);ctx.stroke();
      }
      // === PI BOND CLOUDS for double/triple bonds ===
      if(b.order>=2){
        // Pi cloud: elongated lobes above and below the bond axis
        for(let pi=1;pi<b.order;pi++){
          const side=(pi%2===1)?1:-1;
          const cloudW=d*0.35; // width along bond
          const cloudH=10+pi*3; // height perpendicular
          const pulse=0.85+Math.sin(t*3+b.phase+pi)*0.15;
          const cx2=(a1.x+a2.x)/2,cy2=(a1.y+a2.y)/2;
          // Rotated ellipse
          ctx.save();
          ctx.translate(cx2,cy2);
          ctx.rotate(Math.atan2(dy,dx));
          const pg=ctx.createRadialGradient(0,side*cloudH*0.6,0,0,side*cloudH*0.6,cloudH*pulse);
          pg.addColorStop(0,'rgba(140,100,255,.12)');
          pg.addColorStop(0.6,'rgba(140,100,255,.04)');
          pg.addColorStop(1,'transparent');
          ctx.fillStyle=pg;
          ctx.beginPath();ctx.ellipse(0,side*cloudH*0.6,cloudW,cloudH*pulse,0,0,Math.PI*2);ctx.fill();
          ctx.restore();
        }
      }
    }
    // Polar arrow: δ+ → δ- direction
    if(showCharges&&b.type==='polar'){
      const moreEN=getEl(a2).eneg>getEl(a1).eneg?a2:a1;
      const lessEN=moreEN===a1?a2:a1;
      const mx=(a1.x+a2.x)/2,my=(a1.y+a2.y)/2;
      ctx.fillStyle='rgba(100,200,255,.5)';ctx.font='bold 8px JetBrains Mono';ctx.textAlign='center';ctx.textBaseline='middle';
      // δ+ near less electronegative, δ- near more
      const offX=(moreEN.x-lessEN.x)/d*12,offY=(moreEN.y-lessEN.y)/d*12;
      ctx.fillStyle='rgba(239,71,111,.6)';ctx.fillText('δ+',lessEN.x-offX*0.3,lessEN.y-offY*0.3-10);
      ctx.fillStyle='rgba(6,214,160,.6)';ctx.fillText('δ−',moreEN.x+offX*0.3,moreEN.y+offY*0.3-10);
    }
  });

  // === 2. SHARED BONDING ELECTRON PAIRS (orbit between atoms) ===
  bonds.forEach(b=>{
    const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);if(!a1||!a2)return;
    if(b.type==='ionic'||b.type==='metallic')return; // ionic = transferred, metallic = delocalized
    const dx=a2.x-a1.x,dy=a2.y-a1.y,d=Math.sqrt(dx*dx+dy*dy)||1;
    const nx=-dy/d,ny=dx/d; // perpendicular
    const mx=(a1.x+a2.x)/2,my=(a1.y+a2.y)/2;
    // Polarity shifts midpoint toward more electroneg atom
    const pol=b.polarity||0; // -1 to 1, positive = toward a2
    const cx=mx+dx*pol*0.15,cy=my+dy*pol*0.15; // shifted center
    const gap=5;
    for(let p=0;p<b.order;p++){
      const pOff=(p-(b.order-1)/2)*gap;
      // Two electrons per bonding pair, orbit in figure-8/ellipse between atoms
      for(let e=0;e<2;e++){
        const phase=b.phase+p*1.2+e*Math.PI; // offset each electron
        const orbitT=t*2.5+phase;
        // Elliptical orbit: major axis along bond, minor axis perpendicular
        const along=Math.cos(orbitT)*d*0.3; // along bond axis
        const perp=Math.sin(orbitT)*8+pOff; // perpendicular wobble
        // Shift along bond toward more electroneg atom
        const shiftAlong=along+d*pol*0.12;
        const ex=cx+(dx/d)*shiftAlong+nx*perp;
        const ey=cy+(dy/d)*shiftAlong+ny*perp;
        // Electron glow
        const grd=ctx.createRadialGradient(ex,ey,0,ex,ey,6);
        grd.addColorStop(0,'rgba(80,170,255,.8)');grd.addColorStop(0.5,'rgba(80,170,255,.2)');grd.addColorStop(1,'transparent');
        ctx.fillStyle=grd;ctx.beginPath();ctx.arc(ex,ey,6,0,Math.PI*2);ctx.fill();
        // Electron dot
        ctx.fillStyle='rgba(120,200,255,.9)';ctx.beginPath();ctx.arc(ex,ey,2.2,0,Math.PI*2);ctx.fill();
      }
    }
  });

  // === 3. ATOMS ===
  atoms.forEach(a=>{
    const el=getEl(a);const r=el.radius*(atomScale/100);

    // Outer glow
    const grd=ctx.createRadialGradient(a.x,a.y,r*0.2,a.x,a.y,r*1.6);
    grd.addColorStop(0,el.color+'30');grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd;ctx.beginPath();ctx.arc(a.x,a.y,r*1.6,0,Math.PI*2);ctx.fill();

    // === ELECTRON SHELL RENDERING (respects actual electron count) ===
    if(showShells){
      // Compute actual electrons in each shell based on a.electrons
      // Fill from inner to outer, respecting shell capacity
      const shellCap=[2,8,18,32,32,18,8]; // max per shell
      const actualShells=[];
      let eLeft=a.electrons;
      for(let si=0;si<el.shells.length;si++){
        const cap=shellCap[si]||8;
        const fill=Math.min(eLeft,el.shells[si],cap);
        actualShells.push(Math.max(0,fill));
        eLeft-=fill;
        if(eLeft<=0)break;
      }

      // Draw inner shells (all except last)
      const innerEnd=Math.max(0,actualShells.length-1);
      for(let si=0;si<innerEnd;si++){
        const n=actualShells[si];
        const sr=r*(0.5+si*0.3);
        ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=0.8;
        ctx.beginPath();ctx.arc(a.x,a.y,sr,0,Math.PI*2);ctx.stroke();
        for(let e=0;e<n;e++){
          const angle=(e/Math.max(n,1))*Math.PI*2+t*(1.5+si*0.5)*(a.id%2?1:-1);
          const ex=a.x+Math.cos(angle)*sr,ey=a.y+Math.sin(angle)*sr;
          ctx.fillStyle='rgba(80,140,220,.5)';ctx.beginPath();ctx.arc(ex,ey,1.5,0,Math.PI*2);ctx.fill();
        }
      }

      // === OUTER SHELL: show LONE PAIR electrons (unbonded) ===
      const outerShellIdx=Math.max(0,actualShells.length-1);
      const outerR=r*(0.5+outerShellIdx*0.3);
      const outerE=actualShells[outerShellIdx]||0;
      ctx.strokeStyle=outerE===0?'rgba(255,100,100,.1)':'rgba(255,255,255,.05)';ctx.lineWidth=0.8;
      ctx.beginPath();ctx.arc(a.x,a.y,outerR,0,Math.PI*2);ctx.stroke();
      // How many outer electrons are NOT in bonds?
      const loneE=loneElectrons(a);
      const lp=lonePairs(a);
      // Get angles occupied by bonds (to avoid placing lone pairs there)
      const bondAngles=a.bonds.map(b=>{
        const oid=b.a===a.id?b.b:b.a;const oa=atoms.find(x=>x.id===oid);
        if(!oa)return 0;return Math.atan2(oa.y-a.y,oa.x-a.x)});
      // Distribute lone pair electrons — only on main group elements where lone pairs matter
      const showLonePairs=el.cat==='nonmetal'||el.cat==='halogen'||el.cat==='noble'||['Li','Be','Na','Mg','Al','K','Ca','Ga','Ge','In','Sn','Sb','Tl','Pb','Bi'].includes(el.sym);
      if(loneE>0&&showLonePairs&&loneE<=8){
        // Find gaps between bond angles
        const usedAngles=[...bondAngles].sort((x,y)=>x-y);
        const freeAngles=[];
        if(usedAngles.length===0){
          for(let i=0;i<loneE;i++)freeAngles.push((i/loneE)*Math.PI*2);
        } else {
          // Place lone pairs opposite to bonds
          const step=Math.PI*2/Math.max(loneE,1);
          let startAngle=usedAngles.length?usedAngles[0]+Math.PI:0;
          for(let i=0;i<loneE;i++){
            let angle=startAngle+(i-loneE/2)*step*0.4;
            // Avoid overlapping with bond directions
            freeAngles.push(angle);
          }
        }
        // Draw lone pair electrons orbiting on outer shell
        for(let i=0;i<Math.min(loneE,8);i++){
          const baseAngle=freeAngles[i%freeAngles.length]||0;
          const wobble=Math.sin(t*2+i*1.5+a.id)*0.15;
          const angle=baseAngle+wobble;
          // Lone pairs shown as two electrons close together
          if(i%2===0&&i+1<loneE){
            const pairSep=3;const pa=angle;
            for(let pe=0;pe<2;pe++){
              const offset=(pe-0.5)*pairSep;
              const ex=a.x+Math.cos(pa)*outerR+Math.cos(pa+Math.PI/2)*offset;
              const ey=a.y+Math.sin(pa)*outerR+Math.sin(pa+Math.PI/2)*offset;
              // Lone pair glow
              const lg=ctx.createRadialGradient(ex,ey,0,ex,ey,5);
              lg.addColorStop(0,'rgba(180,130,255,.7)');lg.addColorStop(0.5,'rgba(180,130,255,.15)');lg.addColorStop(1,'transparent');
              ctx.fillStyle=lg;ctx.beginPath();ctx.arc(ex,ey,5,0,Math.PI*2);ctx.fill();
              ctx.fillStyle='rgba(200,160,255,.85)';ctx.beginPath();ctx.arc(ex,ey,2,0,Math.PI*2);ctx.fill();
            }
          }
        }
      }
    }

    // Orbital clouds — per-atom only for UNBONDED atoms
    if(showOrbitals&&a.bonds.length===0){
      const outerE=el.shells[el.shells.length-1]||0;
      const outerR=r*(0.5+(el.shells.length-1)*0.3);
      ctx.save();ctx.globalAlpha=0.05;
      if(outerE>2){
        for(let l=0;l<Math.min(3,outerE-2);l++){
          const ang=l*Math.PI/3+t*0.15;
          ctx.fillStyle=el.color;
          ctx.beginPath();ctx.ellipse(a.x+Math.cos(ang)*outerR*0.5,a.y+Math.sin(ang)*outerR*0.5,outerR*0.6,outerR*0.2,ang,0,Math.PI*2);ctx.fill();
          ctx.beginPath();ctx.ellipse(a.x-Math.cos(ang)*outerR*0.5,a.y-Math.sin(ang)*outerR*0.5,outerR*0.6,outerR*0.2,ang,0,Math.PI*2);ctx.fill();
        }
      } else {
        ctx.fillStyle=el.color;ctx.beginPath();ctx.arc(a.x,a.y,outerR*0.8,0,Math.PI*2);ctx.fill();
      }
      ctx.restore();
    }

    // Lone pair orbital lobes (for bonded atoms — these don't merge)
    if(showOrbitals&&a.bonds.length>0){
      const lp=lonePairs(a);
      if(lp>0){
        const outerR=r*(0.5+(el.shells.length-1)*0.3);
        const bondAngles=a.bonds.map(bd=>{const oid=bd.a===a.id?bd.b:bd.a;const oa=atoms.find(x=>x.id===oid);
          return oa?Math.atan2(oa.y-a.y,oa.x-a.x):0});
        // Place lone pair lobes opposite to bonds
        const avgBondAngle=bondAngles.reduce((s,x)=>s+x,0)/bondAngles.length;
        ctx.save();ctx.globalAlpha=0.06;
        for(let l=0;l<lp;l++){
          const spread=lp>1?0.6:0;
          const ang=avgBondAngle+Math.PI+(l-(lp-1)/2)*spread;
          // Lone pair lobe — teardrop shape pointing away from bonds
          ctx.fillStyle='rgba(180,130,255,1)';
          ctx.beginPath();ctx.ellipse(a.x+Math.cos(ang)*outerR*0.6,a.y+Math.sin(ang)*outerR*0.6,outerR*0.5,outerR*0.2,ang,0,Math.PI*2);ctx.fill();
        }
        ctx.restore();
      }
    }

    // Nucleus
    const coreGrd=ctx.createRadialGradient(a.x-r*0.12,a.y-r*0.12,0,a.x,a.y,r*0.42);
    coreGrd.addColorStop(0,'#ffffff');coreGrd.addColorStop(0.35,el.color);coreGrd.addColorStop(1,el.color+'60');
    ctx.fillStyle=coreGrd;ctx.beginPath();ctx.arc(a.x,a.y,r*0.42,0,Math.PI*2);ctx.fill();

    // Ion charge ring — always visible on charged atoms
    if(a.charge!==0){
      const ringCol=a.charge>0?'rgba(239,71,111,':'rgba(6,214,160,';
      const pulse=0.3+Math.sin(t*3+a.id)*0.15;
      ctx.strokeStyle=ringCol+pulse+')';ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(a.x,a.y,r*0.55,0,Math.PI*2);ctx.stroke();
      // Glow
      const igrd=ctx.createRadialGradient(a.x,a.y,r*0.4,a.x,a.y,r*0.8);
      igrd.addColorStop(0,ringCol+'0.08)');igrd.addColorStop(1,'transparent');
      ctx.fillStyle=igrd;ctx.beginPath();ctx.arc(a.x,a.y,r*0.8,0,Math.PI*2);ctx.fill();
    }

    // Symbol
    ctx.fillStyle='#fff';ctx.font='bold '+Math.max(10,r*0.5)+'px Outfit,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(el.sym,a.x,a.y);

    // Charge label — ALWAYS show on ions regardless of toggle
    if(a.charge!==0){
      const cl=a.charge>0?a.charge+'+':Math.abs(a.charge)+'−';
      ctx.fillStyle=a.charge>0?'#ef476f':'#06d6a0';
      ctx.font='bold 10px JetBrains Mono';ctx.fillText(cl,a.x+r*0.55,a.y-r*0.5);
    }

    // Velocity arrow
    if(showVel){
      const vs=Math.sqrt(a.vx*a.vx+a.vy*a.vy);
      if(vs>0.2){ctx.strokeStyle='rgba(6,214,160,.4)';ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(a.x+a.vx*8,a.y+a.vy*8);ctx.stroke()}
    }

    // Hover highlight
    if(a===hoverAtom){
      ctx.strokeStyle='rgba(6,214,160,.5)';ctx.lineWidth=2;ctx.setLineDash([4,3]);
      ctx.beginPath();ctx.arc(a.x,a.y,r*0.65,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);
    }
  });

  // === 4. MOLECULAR ORBITALS (drawn after atoms, spans between bonded pairs) ===
  if(showOrbitals)bonds.forEach(b=>{
    const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);if(!a1||!a2)return;
    if(b.type==='ionic')return; // ionic bonds don't form MOs
    const el1=getEl(a1),el2=getEl(a2);
    const dx=a2.x-a1.x,dy=a2.y-a1.y,d=Math.sqrt(dx*dx+dy*dy)||1;
    const ang=Math.atan2(dy,dx);
    const mx=(a1.x+a2.x)/2+dx*(b.polarity||0)*0.1;
    const my=(a1.y+a2.y)/2+dy*(b.polarity||0)*0.1;
    const r1=el1.radius,r2=el2.radius;

    ctx.save();

    // === σ (sigma) bonding orbital — sausage-shaped envelope wrapping both nuclei ===
    // Drawn as an elongated ellipse centered on the bond midpoint
    const sigmaLen=d*0.55; // half-length along bond
    const sigmaWid=Math.min(r1,r2)*0.35; // half-width perpendicular
    // Gradient: denser in middle (bonding region), fades toward nuclei
    const sigGrd=ctx.createRadialGradient(mx,my,0,mx,my,sigmaLen);
    // Color blend of both atoms
    const c1=el1.color,c2=el2.color;
    sigGrd.addColorStop(0,'rgba(100,200,255,.12)');
    sigGrd.addColorStop(0.6,'rgba(100,200,255,.04)');
    sigGrd.addColorStop(1,'transparent');
    ctx.fillStyle=sigGrd;
    ctx.beginPath();
    ctx.ellipse(mx,my,sigmaLen,sigmaWid,ang,0,Math.PI*2);
    ctx.fill();
    // Sigma outline
    ctx.strokeStyle='rgba(100,200,255,.06)';ctx.lineWidth=0.8;
    ctx.beginPath();ctx.ellipse(mx,my,sigmaLen,sigmaWid,ang,0,Math.PI*2);ctx.stroke();

    // === π (pi) orbitals — for double and triple bonds ===
    if(b.order>=2){
      // First π orbital: two lobes above and below the bond axis
      const piOff=sigmaWid*1.8; // distance of lobe center from bond axis
      const piLen=d*0.4;
      const piWid=Math.min(r1,r2)*0.25;
      const nx=-dy/d,ny=dx/d; // perpendicular unit
      // Upper lobe
      ctx.fillStyle='rgba(255,160,80,.07)';
      ctx.beginPath();ctx.ellipse(mx+nx*piOff,my+ny*piOff,piLen,piWid,ang,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(255,160,80,.05)';ctx.lineWidth=0.6;
      ctx.beginPath();ctx.ellipse(mx+nx*piOff,my+ny*piOff,piLen,piWid,ang,0,Math.PI*2);ctx.stroke();
      // Lower lobe
      ctx.fillStyle='rgba(255,160,80,.07)';
      ctx.beginPath();ctx.ellipse(mx-nx*piOff,my-ny*piOff,piLen,piWid,ang,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(255,160,80,.05)';ctx.lineWidth=0.6;
      ctx.beginPath();ctx.ellipse(mx-nx*piOff,my-ny*piOff,piLen,piWid,ang,0,Math.PI*2);ctx.stroke();

      // Label
      ctx.globalAlpha=0.3;ctx.fillStyle='#ff9944';ctx.font='bold 7px JetBrains Mono';ctx.textAlign='center';
      ctx.fillText('π',mx+nx*(piOff+piWid+6),my+ny*(piOff+piWid+6));
    }

    if(b.order>=3){
      // Second π orbital: rotated 90° from first (in 2D we show it at 45° offset)
      const pi2Off=sigmaWid*2.4;
      const pi2Len=d*0.35;
      const pi2Wid=Math.min(r1,r2)*0.2;
      const nx=-dy/d,ny=dx/d;
      // Rotate 45° from perpendicular
      const rcos=Math.cos(Math.PI/4),rsin=Math.sin(Math.PI/4);
      const n2x=nx*rcos-ny*rsin,n2y=nx*rsin+ny*rcos;
      ctx.fillStyle='rgba(130,255,130,.06)';
      ctx.beginPath();ctx.ellipse(mx+n2x*pi2Off,my+n2y*pi2Off,pi2Len,pi2Wid,ang+Math.PI/4,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(130,255,130,.04)';ctx.lineWidth=0.6;
      ctx.beginPath();ctx.ellipse(mx+n2x*pi2Off,my+n2y*pi2Off,pi2Len,pi2Wid,ang+Math.PI/4,0,Math.PI*2);ctx.stroke();
      ctx.fillStyle='rgba(130,255,130,.06)';
      ctx.beginPath();ctx.ellipse(mx-n2x*pi2Off,my-n2y*pi2Off,pi2Len,pi2Wid,ang+Math.PI/4,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(130,255,130,.04)';ctx.lineWidth=0.6;
      ctx.beginPath();ctx.ellipse(mx-n2x*pi2Off,my-n2y*pi2Off,pi2Len,pi2Wid,ang+Math.PI/4,0,Math.PI*2);ctx.stroke();

      ctx.globalAlpha=0.3;ctx.fillStyle='#88ff88';ctx.font='bold 7px JetBrains Mono';ctx.textAlign='center';
      ctx.fillText('π*',mx+n2x*(pi2Off+pi2Wid+6),my+n2y*(pi2Off+pi2Wid+6));
    }

    // σ label
    ctx.globalAlpha=0.3;ctx.fillStyle='#66bbff';ctx.font='bold 7px JetBrains Mono';ctx.textAlign='center';
    ctx.fillText('σ',mx,my-sigmaWid-5);

    ctx.restore();
  });

  // Bond-start line
  if(mode==='bond'&&bondStart){
    ctx.strokeStyle='rgba(6,214,160,.4)';ctx.lineWidth=1.5;ctx.setLineDash([5,4]);
    ctx.beginPath();ctx.moveTo(bondStart.x,bondStart.y);ctx.lineTo(mX,mY);ctx.stroke();ctx.setLineDash([]);
  }

  // === 5. MOLECULE LABELS — floating formula + name above each molecule ===
  mols.forEach(mol=>{
    if(mol.length<2)return;
    const f=molFormula(mol);
    const pf=prettyFormula(f); // subscripted formula
    const name=nameMolecule(f); // plain english or null
    // Find center and topmost point
    let cx=0,cy=0,minY=Infinity;
    mol.forEach(a=>{cx+=a.x;cy+=a.y;const r=getEl(a).radius;if(a.y-r<minY)minY=a.y-r});
    cx/=mol.length;
    const hasName=!!name;
    const line1=pf;
    const line2=hasName?name:'Unknown compound';
    const labelY=minY-(hasName?22:14);
    ctx.save();
    // Measure text
    ctx.font='bold 10px JetBrains Mono';
    const tw1=ctx.measureText(line1).width;
    ctx.font='600 8px Outfit,sans-serif';
    const tw2=ctx.measureText(line2).width;
    const tw=Math.max(tw1,tw2);
    const pw=tw+16,ph=hasName?28:18;
    const px=cx-pw/2,py=labelY-ph/2;
    // Background pill
    ctx.fillStyle='rgba(4,6,12,.8)';
    ctx.beginPath();const rr=6;
    ctx.moveTo(px+rr,py);ctx.lineTo(px+pw-rr,py);ctx.quadraticCurveTo(px+pw,py,px+pw,py+rr);
    ctx.lineTo(px+pw,py+ph-rr);ctx.quadraticCurveTo(px+pw,py+ph,px+pw-rr,py+ph);
    ctx.lineTo(px+rr,py+ph);ctx.quadraticCurveTo(px,py+ph,px,py+ph-rr);
    ctx.lineTo(px,py+rr);ctx.quadraticCurveTo(px,py,px+rr,py);ctx.fill();
    // Border
    ctx.strokeStyle=hasName?'rgba(6,214,160,.3)':'rgba(255,255,255,.1)';ctx.lineWidth=0.8;
    ctx.beginPath();
    ctx.moveTo(px+rr,py);ctx.lineTo(px+pw-rr,py);ctx.quadraticCurveTo(px+pw,py,px+pw,py+rr);
    ctx.lineTo(px+pw,py+ph-rr);ctx.quadraticCurveTo(px+pw,py+ph,px+pw-rr,py+ph);
    ctx.lineTo(px+rr,py+ph);ctx.quadraticCurveTo(px,py+ph,px,py+ph-rr);
    ctx.lineTo(px,py+rr);ctx.quadraticCurveTo(px,py,px+rr,py);ctx.stroke();
    // Formula line (top)
    ctx.fillStyle='rgba(6,214,160,.9)';ctx.font='bold 10px JetBrains Mono';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(line1,cx,py+(hasName?10:ph/2));
    // Name line (bottom)
    if(hasName){
      ctx.fillStyle='rgba(255,255,255,.55)';ctx.font='600 8px Outfit,sans-serif';
      ctx.fillText(line2,cx,py+21);
    } else {
      // dim "Unknown" only for multi-atom unnamed
      ctx.fillStyle='rgba(255,255,255,.25)';ctx.font='italic 7px Outfit,sans-serif';
      ctx.fillText(line2,cx,py+ph/2+0);
    }
    // Connector line
    ctx.strokeStyle='rgba(6,214,160,.12)';ctx.lineWidth=0.5;
    ctx.beginPath();ctx.moveTo(cx,py+ph);ctx.lineTo(cx,minY-2);ctx.stroke();
    ctx.restore();
  });

  // === RADIATION PARTICLES ===
  if(radParticles.length>0){
    radParticles.forEach(p=>{
      const a=p.life;
      if(p.type==='gamma'){
        // Gamma ray — fast moving yellow-white streak
        const len=12;
        const nx=p.vx/Math.sqrt(p.vx*p.vx+p.vy*p.vy+.01);
        const ny=p.vy/Math.sqrt(p.vx*p.vx+p.vy*p.vy+.01);
        ctx.strokeStyle=`rgba(255,255,100,${a*0.7})`;ctx.lineWidth=1.5;
        ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p.x-nx*len,p.y-ny*len);ctx.stroke();
        // Glow
        const gg=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,4);
        gg.addColorStop(0,`rgba(255,255,180,${a*0.5})`);gg.addColorStop(1,'transparent');
        ctx.fillStyle=gg;ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();
      } else if(p.type==='flash'){
        // Impact flash — expanding white circle
        const r=(p.r||10)*(1.5-p.life);
        const fg=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r);
        fg.addColorStop(0,`rgba(255,255,255,${a*0.6})`);
        fg.addColorStop(0.4,`rgba(255,230,100,${a*0.3})`);
        fg.addColorStop(1,'transparent');
        ctx.fillStyle=fg;ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fill();
      } else if(p.type==='electron'){
        // Ejected electron — small blue dot with trail
        ctx.fillStyle=`rgba(100,180,255,${a*0.9})`;
        ctx.beginPath();ctx.arc(p.x,p.y,2.5,0,Math.PI*2);ctx.fill();
        const eg=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,6);
        eg.addColorStop(0,`rgba(100,180,255,${a*0.4})`);eg.addColorStop(1,'transparent');
        ctx.fillStyle=eg;ctx.beginPath();ctx.arc(p.x,p.y,6,0,Math.PI*2);ctx.fill();
      } else if(p.type==='spark'){
        // Spark — tiny bright dot
        ctx.fillStyle=`rgba(255,220,100,${a*0.8})`;
        ctx.beginPath();ctx.arc(p.x,p.y,1.5,0,Math.PI*2);ctx.fill();
      }
    });
  }

  // === HYDROGEN BONDS — dotted lines ===
  if(showHBonds&&hBonds.length>0){
    ctx.setLineDash([3,4]);ctx.lineWidth=1;
    hBonds.forEach(({h,acc,d})=>{
      const alpha=Math.max(0,1-d/60)*0.4;
      ctx.strokeStyle=`rgba(100,200,255,${alpha})`;
      ctx.beginPath();ctx.moveTo(h.x,h.y);ctx.lineTo(acc.x,acc.y);ctx.stroke();
    });
    ctx.setLineDash([]);
  }

  // === VAN DER WAALS — faint shimmering lines between nearby non-bonded atoms ===
  if(showHBonds&&vdwPairs.length>0){
    vdwPairs.forEach(({a:va,b:vb,d:vd})=>{
      const alpha=Math.max(0,(65-vd)/65)*0.15;
      const shimmer=0.7+Math.sin(t*6+va.id*2.3+vb.id*3.1)*0.3;
      ctx.strokeStyle=`rgba(200,200,255,${alpha*shimmer})`;
      ctx.lineWidth=0.5;
      ctx.setLineDash([2,3]);
      ctx.beginPath();ctx.moveTo(va.x,va.y);ctx.lineTo(vb.x,vb.y);ctx.stroke();
      ctx.setLineDash([]);
    });
  }

  // === AROMATIC RING DETECTION + RENDERING ===
  // Find 6-membered carbon rings and draw delocalized electron circle
  if(showBonds){
    // Build adjacency for carbon atoms
    const carbons=atoms.filter(a=>a.sym==='C'&&a.bonds.length>=2);
    const visited=new Set();
    carbons.forEach(start=>{
      if(visited.has(start.id))return;
      // BFS to find 6-rings of carbons
      const neighbors=(a)=>a.bonds.map(b=>{
        const oid=b.a===a.id?b.b:b.a;
        return atoms.find(x=>x.id===oid);
      }).filter(x=>x&&x.sym==='C');
      // Check if start is part of a 6-ring
      const ring=[];
      function findRing(cur,path,depth){
        if(depth===6&&cur===start&&path.length===6){ring.push([...path]);return}
        if(depth>=6)return;
        for(const nb of neighbors(cur)){
          if(depth>0&&nb===start&&depth===5){ring.push([...path]);return}
          if(path.includes(nb))continue;
          path.push(nb);findRing(nb,path,depth+1);path.pop();
        }
      }
      findRing(start,[start],0);
      if(ring.length>0){
        const r=ring[0];
        // Check that all bonds are order 1 or 2 (aromatic pattern)
        let isAromatic=true;
        for(let i=0;i<6;i++){
          const a=r[i],b2=r[(i+1)%6];
          if(!bondExists(a,b2)){isAromatic=false;break}
        }
        if(isAromatic){
          r.forEach(a=>visited.add(a.id));
          // Center of ring
          let cx2=0,cy2=0;r.forEach(a=>{cx2+=a.x;cy2+=a.y});cx2/=6;cy2/=6;
          // Average radius
          let avgR=0;r.forEach(a=>{avgR+=Math.sqrt((a.x-cx2)**2+(a.y-cy2)**2)});avgR/=6;
          // Draw delocalized electron circle
          const pulse=0.9+Math.sin(t*2)*0.1;
          const ag=ctx.createRadialGradient(cx2,cy2,avgR*0.3*pulse,cx2,cy2,avgR*0.7*pulse);
          ag.addColorStop(0,'rgba(180,140,255,.08)');
          ag.addColorStop(0.5,'rgba(180,140,255,.12)');
          ag.addColorStop(1,'transparent');
          ctx.fillStyle=ag;ctx.beginPath();ctx.arc(cx2,cy2,avgR*0.7*pulse,0,Math.PI*2);ctx.fill();
          // Inner circle line
          ctx.strokeStyle='rgba(180,140,255,.2)';ctx.lineWidth=1.5;
          ctx.beginPath();ctx.arc(cx2,cy2,avgR*0.55*pulse,0,Math.PI*2);ctx.stroke();
          // Floating electrons in the ring
          for(let e=0;e<6;e++){
            const ea=t*1.2+e*Math.PI/3;
            const er=avgR*0.5*pulse;
            const ex=cx2+Math.cos(ea)*er,ey=cy2+Math.sin(ea)*er;
            ctx.fillStyle='rgba(180,140,255,.3)';
            ctx.beginPath();ctx.arc(ex,ey,2,0,Math.PI*2);ctx.fill();
          }
        }
      }
    });
  }

  // === ELECTRON TRANSFER ANIMATION ===
  eTransferFX.forEach(p=>{
    const alpha=1-Math.abs(p.t-0.5)*2;
    // Glowing blue electron dot spiraling
    const eg=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,8);
    eg.addColorStop(0,`rgba(80,180,255,${alpha*0.9})`);
    eg.addColorStop(0.5,`rgba(80,180,255,${alpha*0.3})`);
    eg.addColorStop(1,'transparent');
    ctx.fillStyle=eg;ctx.beginPath();ctx.arc(p.x,p.y,8,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=`rgba(200,230,255,${alpha})`;ctx.beginPath();ctx.arc(p.x,p.y,2.5,0,Math.PI*2);ctx.fill();
    // Trail
    ctx.strokeStyle=`rgba(80,180,255,${alpha*0.3})`;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(p.sx,p.sy);ctx.quadraticCurveTo(p.x,p.y,p.ex,p.ey);ctx.stroke();
  });

  // === SPECTRAL EMISSION — atoms glow their spectral color when hot ===
  if(envTemp>800){
    const glowIntensity=Math.min(1,(envTemp-800)/4000);
    atoms.forEach(a=>{
      const col=SPECTRAL[a.sym];
      if(!col)return;
      const r=getEl(a).radius*(atomScale/100);
      const flicker=0.7+Math.sin(t*8+a.id*3.7)*0.3;
      const gr=ctx.createRadialGradient(a.x,a.y,r*0.3,a.x,a.y,r*2.5);
      gr.addColorStop(0,col+Math.floor(glowIntensity*flicker*180).toString(16).padStart(2,'0'));
      gr.addColorStop(0.4,col+Math.floor(glowIntensity*flicker*60).toString(16).padStart(2,'0'));
      gr.addColorStop(1,'transparent');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(a.x,a.y,r*2.5,0,Math.PI*2);ctx.fill();
    });
  }

  // UI stats
  document.getElementById('aCnt').textContent=atoms.length;
  document.getElementById('bCnt').textContent=bonds.length;
  document.getElementById('mCnt').textContent=mols.length;
}

// === BOND LOG ===
const bLog=document.getElementById('bondLog');
function logBond(txt){
  const d=document.createElement('div');d.className='bl-msg';d.textContent=txt;bLog.prepend(d);
  if(bLog.children.length>5)bLog.removeChild(bLog.lastChild);
  setTimeout(()=>{d.style.opacity='0';d.style.transition='opacity .5s';setTimeout(()=>d.remove(),500)},2500);
}

// === INPUT ===
function atomAt(x,y){
  let best=null,bestD=Infinity;
  atoms.forEach(a=>{const d=dist(a,{x,y});const r=getEl(a).radius*1.0;if(d<r&&d<bestD){best=a;bestD=d}});
  return best;
}
function bondAt(x,y){
  let best=null,bestD=40; // much larger hit radius
  bonds.forEach(b=>{
    const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);if(!a1||!a2)return;
    // Point-to-line segment distance
    const dx=a2.x-a1.x,dy=a2.y-a1.y,len2=dx*dx+dy*dy;if(!len2)return;
    let t=((x-a1.x)*dx+(y-a1.y)*dy)/len2;t=Math.max(0,Math.min(1,t));
    const px=a1.x+t*dx,py=a1.y+t*dy;
    const d=Math.sqrt((x-px)**2+(y-py)**2);
    if(d<bestD){best=b;bestD=d}
    // Also check midpoint of bond (easier to click)
    const mx=(a1.x+a2.x)/2,my=(a1.y+a2.y)/2;
    const md=Math.sqrt((x-mx)**2+(y-my)**2);
    if(md<bestD){best=b;bestD=md}
  });
  return best;
}

const mainCv=document.getElementById('mainCv');
mainCv.addEventListener('mousedown',e=>{
  const r=mainCv.getBoundingClientRect();const x=e.clientX-r.left,y=e.clientY-r.top;
  if(mode==='place'){addAtom(selEl,x,y)}
  else if(mode==='drag'){const a=atomAt(x,y);if(a){dragAtom=a;dragOff={x:a.x-x,y:a.y-y}}}
  else if(mode==='bond'){const a=atomAt(x,y);if(a){if(!bondStart)bondStart=a;
    else{if(bondStart!==a&&canBond(bondStart)&&canBond(a)&&!bondExists(bondStart,a)){
      addBond(bondStart,a,1);logBond(bondStart.sym+'-'+a.sym+' bond forced')}bondStart=null}}}
  else if(mode==='break_b'){
    // Try bond line first
    const b=bondAt(x,y);
    if(b){
      const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);
      logBond((a1?a1.sym:'?')+'−'+(a2?a2.sym:'?')+' broken');removeBond(b);
    } else {
      // Fallback: click an atom to break its last bond
      const a=atomAt(x,y);
      if(a&&a.bonds.length>0){
        const lb=a.bonds[a.bonds.length-1];
        const oid=lb.a===a.id?lb.b:lb.a;
        const oa=atoms.find(x=>x.id===oid);
        logBond(a.sym+'−'+(oa?oa.sym:'?')+' broken');removeBond(lb);
      }
    }
  }
  else if(mode==='ionize'){const a=atomAt(x,y);if(a){
    const el=getEl(a);
    // Auto-enable charge display
    if(!showCharges){showCharges=true;document.getElementById('bCharges').classList.add('active')}
    if(e.shiftKey){
      // Add electron
      a.electrons++;a.charge--;
      logBond(a.sym+' + e⁻ → '+a.sym+(a.charge<0?a.charge+'⁻':a.charge===0?'':''+a.charge+'⁺'));
    } else {
      // Remove electron (ionize)
      if(a.electrons>0){
        a.electrons--;a.charge++;
        logBond(a.sym+' − e⁻ → '+a.sym+(a.charge>0?a.charge+'⁺':a.charge===0?'':''+a.charge+'⁻'));
        // If we removed a bonding electron, break weakest bond
        const maxB=Math.max(0,el.valence-a.charge);
        while(a.bonds.length>maxB&&a.bonds.length>0){
          const b=a.bonds[a.bonds.length-1];
          const oa=atoms.find(x=>x.id===(b.a===a.id?b.b:b.a));
          logBond('Bond broken: '+a.sym+'−'+(oa?oa.sym:'?'));
          removeBond(b);
        }
      }
    }
  }}  else if(mode==='eraser'){const a=atomAt(x,y);if(a)removeAtom(a)}
});
mainCv.addEventListener('mousemove',e=>{
  const r=mainCv.getBoundingClientRect();mX=e.clientX-r.left;mY=e.clientY-r.top;
  if(dragAtom){dragAtom.x=mX+dragOff.x;dragAtom.y=mY+dragOff.y;dragAtom.vx=0;dragAtom.vy=0}
  hoverAtom=atomAt(mX,mY);
  // Info panel
  if(showInfo&&hoverAtom){
    const a=hoverAtom,el=getEl(a);
    document.getElementById('iEl').textContent=el.sym+' ('+el.name+')';
    document.getElementById('iEl').style.color=el.color;
    document.getElementById('iElec').textContent=a.electrons+'/'+el.z+(a.electrons!==el.z?' (ion)':'');
    const bondDescs=a.bonds.map(b=>{const oid=b.a===a.id?b.b:b.a;const oa=atoms.find(x=>x.id===oid);
      return (oa?oa.sym:'?')+(b.order>1?'='.repeat(b.order):'')+'('+b.type+')'}).join(', ');
    document.getElementById('iBond').textContent=curBonds(a)+'/'+maxBonds(a)+(bondDescs?' — '+bondDescs:'');
    const sharedP=a.bonds.reduce((s,b)=>s+(b.type==='ionic'?0:b.order),0);
    document.getElementById('iShared').textContent=sharedP+' pair'+(sharedP!==1?'s':'')+' ('+sharedP*2+' e⁻)';
    document.getElementById('iLone').textContent=lonePairs(a)+' pair'+(lonePairs(a)!==1?'s':'')+' ('+loneElectrons(a)+' e⁻)';
    document.getElementById('iChrg').textContent=a.charge===0?'Neutral':a.charge>0?'+'+a.charge:a.charge;
    document.getElementById('iChrg').style.color=a.charge>0?'#ef476f':a.charge<0?'#06d6a0':'var(--text)';
    // Find molecule
    const mol=getMolecules().find(m=>m.includes(a));
    if(mol){const mf=molFormula(mol);const mn=nameMolecule(mf);
      document.getElementById('iMol').textContent=prettyFormula(mf)+(mn?' — '+mn:'')}
    else document.getElementById('iMol').textContent='—';
  }
  // Cursor
  mainCv.style.cursor=mode==='drag'?(dragAtom?'grabbing':'grab'):mode==='eraser'?'crosshair':'default';
});
window.addEventListener('mouseup',()=>{dragAtom=null});
mainCv.addEventListener('contextmenu',e=>e.preventDefault());
// Double click to increase bond order
mainCv.addEventListener('dblclick',e=>{
  const r=mainCv.getBoundingClientRect();const x=e.clientX-r.left,y=e.clientY-r.top;
  const b=bondAt(x,y);if(b){
    const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);
    if(b.order<3){b.order++;logBond((a1?a1.sym:'?')+'='+(a2?a2.sym:'?')+' (order '+b.order+')')}}
});

// === UI SETUP ===
const tip=document.getElementById('tip');
let elBtns=[];
function buildElBtns(){
  const g=document.getElementById('gEl');g.innerHTML='';elBtns=[];
  Object.entries(EL).forEach(([k,el])=>{
    const b=document.createElement('button');b.className='abtn'+(k==='H'?' active':'');
    b.dataset.sym=k;b.dataset.cat=el.cat;b.dataset.name=el.name.toLowerCase();
    b.innerHTML='<span class="anum">'+el.z+'</span><span class="sym" style="color:'+el.color+'">'+el.sym+'</span><span class="aname">'+el.name.substring(0,6)+'</span>';
    b.addEventListener('click',()=>{
      document.querySelectorAll('.abtn,.tbtn2').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');selEl=k;mode='place';
      document.getElementById('modeName').textContent='Place '+el.name});
    b.addEventListener('mouseenter',e2=>{tip.style.display='block';
      tip.querySelector('.tn').textContent='#'+el.z+' '+el.sym+' — '+el.name;
      tip.querySelector('.tn').style.color=el.color;
      tip.querySelector('.td').textContent=el.desc+'\nValence: '+el.valence+' | EN: '+el.eneg+' | Mass: '+el.mass+'\nShells: ['+el.shells.join(',')+'] | '+el.cat;
      const r2=b.getBoundingClientRect();tip.style.left=(r2.right+6)+'px';tip.style.top=Math.min(r2.top,window.innerHeight-100)+'px'});
    b.addEventListener('mouseleave',()=>{tip.style.display='none'});
    g.appendChild(b);elBtns.push(b);
  });
}
buildElBtns();
// Category filter
let curCat='all';
document.querySelectorAll('.catF').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.catF').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');curCat=btn.dataset.cat;filterEls()})});
// Search
document.getElementById('elSearch').addEventListener('input',filterEls);
function filterEls(){
  const q=document.getElementById('elSearch').value.toLowerCase();
  elBtns.forEach(b=>{
    const matchCat=curCat==='all'||b.dataset.cat===curCat;
    const matchQ=!q||b.dataset.sym.toLowerCase().includes(q)||b.dataset.name.includes(q);
    b.style.display=matchCat&&matchQ?'':'none'});
}
// Tab switching
document.querySelectorAll('.stab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.stab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tabPanel').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-'+tab.dataset.tab).classList.add('active');
    // Show/hide orbital overlay
    const orbW=document.getElementById('orbWrap');
    const toolbar=document.getElementById('toolbar');
    const statsBar=document.getElementById('statsBar');
    const dispBar=document.getElementById('dispBar');
    if(tab.dataset.tab==='orbitals'){
      orbW.style.display='block';
      toolbar.style.display='none';
      statsBar.style.display='none';
      if(dispBar)dispBar.style.display='none';
      setTimeout(()=>{if(typeof initOrb==='function')initOrb()},50);
    }else{
      orbW.style.display='none';
      toolbar.style.display='';
      statsBar.style.display='';
      if(dispBar)dispBar.style.display='';
    }
  });
});
// Tool buttons — compact for floating toolbar
Object.entries(TOOLS).forEach(([k,t])=>{
  const b=document.createElement('button');b.className='tbtn tbtn2';
  b.textContent=k==='break_b'?'Break':k.charAt(0).toUpperCase()+k.slice(1);
  b.addEventListener('click',()=>{
    document.querySelectorAll('.abtn,.tbtn2').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');mode=k;bondStart=null;
    document.getElementById('modeName').textContent=t.name});
  document.getElementById('gTool').appendChild(b);
});
// === STRUCTURES — spawn pre-built molecules and materials ===
const STRUCTURES={
// --- SIMPLE MOLECULES ---
'H₂O — Water':{cat:'mol',temp:300,build(cx,cy){
  const o=addAtom('O',cx,cy);const h1=addAtom('H',cx-30,cy+25);const h2=addAtom('H',cx+30,cy+25);
  addBond(o,h1,1);addBond(o,h2,1)}},
'CO₂ — Carbon Dioxide':{cat:'mol',build(cx,cy){
  const c=addAtom('C',cx,cy);const o1=addAtom('O',cx-40,cy);const o2=addAtom('O',cx+40,cy);
  addBond(c,o1,1);addBond(c,o2,1);
  bonds[bonds.length-1].order=2;bonds[bonds.length-2].order=2}},
'NH₃ — Ammonia':{cat:'mol',build(cx,cy){
  const n=addAtom('N',cx,cy);addBond(n,addAtom('H',cx-28,cy+24),1);
  addBond(n,addAtom('H',cx+28,cy+24),1);addBond(n,addAtom('H',cx,cy-30),1)}},
'CH₄ — Methane':{cat:'mol',build(cx,cy){
  const c=addAtom('C',cx,cy);addBond(c,addAtom('H',cx-28,cy-28),1);addBond(c,addAtom('H',cx+28,cy-28),1);
  addBond(c,addAtom('H',cx-28,cy+28),1);addBond(c,addAtom('H',cx+28,cy+28),1)}},
'HCl — Hydrochloric Acid':{cat:'mol',build(cx,cy){
  addBond(addAtom('H',cx-22,cy),addAtom('Cl',cx+22,cy),1)}},
'N₂ — Nitrogen Gas':{cat:'mol',build(cx,cy){
  const a=addAtom('N',cx-18,cy),b=addAtom('N',cx+18,cy);addBond(a,b,1);
  bonds[bonds.length-1].order=3}},
'O₂ — Oxygen Gas':{cat:'mol',build(cx,cy){
  const a=addAtom('O',cx-18,cy),b=addAtom('O',cx+18,cy);addBond(a,b,1);
  bonds[bonds.length-1].order=2}},
'O₃ — Ozone':{cat:'mol',build(cx,cy){
  const o1=addAtom('O',cx-30,cy+15),o2=addAtom('O',cx,cy-15),o3=addAtom('O',cx+30,cy+15);
  addBond(o2,o1,1);addBond(o2,o3,1)}},
'H₂O₂ — Hydrogen Peroxide':{cat:'mol',build(cx,cy){
  const o1=addAtom('O',cx-15,cy),o2=addAtom('O',cx+15,cy);addBond(o1,o2,1);
  addBond(o1,addAtom('H',cx-35,cy-20),1);addBond(o2,addAtom('H',cx+35,cy+20),1)}},
'HCN — Hydrogen Cyanide':{cat:'mol',build(cx,cy){
  const h=addAtom('H',cx-40,cy),c=addAtom('C',cx,cy),n=addAtom('N',cx+35,cy);
  addBond(h,c,1);addBond(c,n,1);bonds[bonds.length-1].order=3}},
'SO₂ — Sulfur Dioxide':{cat:'mol',build(cx,cy){
  const s=addAtom('S',cx,cy);addBond(s,addAtom('O',cx-35,cy+20),1);addBond(s,addAtom('O',cx+35,cy+20),1)}},
// --- ORGANIC ---
'C₂H₆ — Ethane':{cat:'org',build(cx,cy){
  const c1=addAtom('C',cx-22,cy),c2=addAtom('C',cx+22,cy);addBond(c1,c2,1);
  addBond(c1,addAtom('H',cx-50,cy-20),1);addBond(c1,addAtom('H',cx-50,cy+20),1);addBond(c1,addAtom('H',cx-22,cy-32),1);
  addBond(c2,addAtom('H',cx+50,cy-20),1);addBond(c2,addAtom('H',cx+50,cy+20),1);addBond(c2,addAtom('H',cx+22,cy+32),1)}},
'C₂H₄ — Ethylene':{cat:'org',build(cx,cy){
  const c1=addAtom('C',cx-20,cy),c2=addAtom('C',cx+20,cy);addBond(c1,c2,1);bonds[bonds.length-1].order=2;
  addBond(c1,addAtom('H',cx-45,cy-22),1);addBond(c1,addAtom('H',cx-45,cy+22),1);
  addBond(c2,addAtom('H',cx+45,cy-22),1);addBond(c2,addAtom('H',cx+45,cy+22),1)}},
'C₂H₂ — Acetylene':{cat:'org',build(cx,cy){
  const c1=addAtom('C',cx-18,cy),c2=addAtom('C',cx+18,cy);addBond(c1,c2,1);bonds[bonds.length-1].order=3;
  addBond(c1,addAtom('H',cx-45,cy),1);addBond(c2,addAtom('H',cx+45,cy),1)}},
'C₆H₆ — Benzene Ring':{cat:'org',build(cx,cy){
  const r=40,cs=[];
  for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/2;cs.push(addAtom('C',cx+Math.cos(a)*r,cy+Math.sin(a)*r))}
  for(let i=0;i<6;i++){addBond(cs[i],cs[(i+1)%6],1);if(i%2===0)bonds[bonds.length-1].order=2}
  for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/2;addBond(cs[i],addAtom('H',cx+Math.cos(a)*(r+28),cy+Math.sin(a)*(r+28)),1)}}},
'CH₃OH — Methanol':{cat:'org',build(cx,cy){
  const c=addAtom('C',cx-15,cy),o=addAtom('O',cx+25,cy);addBond(c,o,1);
  addBond(o,addAtom('H',cx+48,cy+18),1);
  addBond(c,addAtom('H',cx-40,cy-20),1);addBond(c,addAtom('H',cx-40,cy+20),1);addBond(c,addAtom('H',cx-15,cy-32),1)}},
'C₂H₅OH — Ethanol':{cat:'org',build(cx,cy){
  const c1=addAtom('C',cx-35,cy),c2=addAtom('C',cx,cy),o=addAtom('O',cx+35,cy);
  addBond(c1,c2,1);addBond(c2,o,1);addBond(o,addAtom('H',cx+55,cy+18),1);
  addBond(c1,addAtom('H',cx-60,cy-18),1);addBond(c1,addAtom('H',cx-60,cy+18),1);addBond(c1,addAtom('H',cx-35,cy-30),1);
  addBond(c2,addAtom('H',cx,cy-30),1);addBond(c2,addAtom('H',cx,cy+30),1)}},
// --- SALTS & IONIC ---
'NaCl — Table Salt':{cat:'ionic',build(cx,cy){
  const na=addAtom('Na',cx-22,cy),cl=addAtom('Cl',cx+22,cy);addBond(na,cl,1)}},
'NaCl Crystal (3×3)':{cat:'ionic',temp:250,build(cx,cy){
  const g=38,as=[];
  for(let r=0;r<3;r++)for(let c=0;c<3;c++){
    const sym=(r+c)%2===0?'Na':'Cl';
    as.push(addAtom(sym,cx-g+c*g,cy-g+r*g))}
  for(let r=0;r<3;r++)for(let c=0;c<3;c++){const i=r*3+c;
    if(c<2)addBond(as[i],as[i+1],1);if(r<2)addBond(as[i],as[i+3],1)}}},
'KCl — Potassium Chloride':{cat:'ionic',build(cx,cy){
  addBond(addAtom('K',cx-22,cy),addAtom('Cl',cx+22,cy),1)}},
'CaF₂ — Fluorite':{cat:'ionic',build(cx,cy){
  const ca=addAtom('Ca',cx,cy);addBond(ca,addAtom('F',cx-30,cy+25),1);addBond(ca,addAtom('F',cx+30,cy+25),1)}},
'MgO — Magnesia':{cat:'ionic',build(cx,cy){
  addBond(addAtom('Mg',cx-22,cy),addAtom('O',cx+22,cy),1)}},
// --- CRYSTALS & MATERIALS ---
'Diamond (C lattice)':{cat:'crystal',temp:300,build(cx,cy){
  const sp=32,cs=[];
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    const off=(r%2)*sp*0.5;cs.push(addAtom('C',cx-sp*1.5+c*sp+off,cy-sp*1.5+r*sp))}
  // Tetrahedral bonds
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){const i=r*4+c;
    if(c<3)addBond(cs[i],cs[i+1],1);
    if(r<3){if(r%2===0&&c<4)addBond(cs[i],cs[i+4],1);
      if(r%2===1&&c>0)addBond(cs[i],cs[i+3],1)}}}},
'Graphite (C sheet)':{cat:'crystal',build(cx,cy){
  const as=[],sp=30;
  for(let r=0;r<3;r++)for(let c=0;c<5;c++){
    const off=(r%2)*sp*0.5;as.push(addAtom('C',cx-sp*2+c*sp+off,cy-sp+r*sp))}
  for(let r=0;r<3;r++)for(let c=0;c<5;c++){const i=r*5+c;
    if(c<4)addBond(as[i],as[i+1],1);
    if(r<2&&(r+c)%2===0&&i+5<as.length)addBond(as[i],as[i+5],1)}}},
'Iron Crystal (BCC)':{cat:'crystal',build(cx,cy){
  const s=40,as=[];
  // BCC = corners + center
  for(let r=0;r<3;r++)for(let c=0;c<3;c++)as.push(addAtom('Fe',cx-s+c*s,cy-s+r*s));
  // Bonds: grid + diagonals to center
  for(let r=0;r<3;r++)for(let c=0;c<3;c++){const i=r*3+c;
    if(c<2)addBond(as[i],as[i+1],1);if(r<2)addBond(as[i],as[i+3],1)}
  addBond(as[0],as[4],1);addBond(as[2],as[4],1);addBond(as[6],as[4],1);addBond(as[8],as[4],1)}},
'Gold Cluster':{cat:'crystal',build(cx,cy){
  const au=addAtom('Au',cx,cy);
  for(let i=0;i<6;i++){const a=i*Math.PI/3;
    addBond(au,addAtom('Au',cx+Math.cos(a)*38,cy+Math.sin(a)*38),1)}}},
'SiO₂ — Quartz':{cat:'crystal',build(cx,cy){
  const si1=addAtom('Si',cx-30,cy),si2=addAtom('Si',cx+30,cy);
  const o1=addAtom('O',cx,cy-5);addBond(si1,o1,1);addBond(si2,o1,1);
  addBond(si1,addAtom('O',cx-55,cy-20),1);addBond(si1,addAtom('O',cx-55,cy+20),1);
  addBond(si2,addAtom('O',cx+55,cy-20),1);addBond(si2,addAtom('O',cx+55,cy+20),1)}},
// --- GASES & ATMOSPHERES ---
'Air (N₂ + O₂)':{cat:'gas',temp:300,build(cx,cy){
  // 78% N₂, 21% O₂, 1% Ar
  for(let i=0;i<8;i++){const x2=cx+(Math.random()-.5)*250,y2=cy+(Math.random()-.5)*200;
    const a=addAtom('N',x2-12,y2),b=addAtom('N',x2+12,y2);addBond(a,b,1);bonds[bonds.length-1].order=3;
    a.vx=(Math.random()-.5)*3;a.vy=(Math.random()-.5)*3;b.vx=a.vx;b.vy=a.vy}
  for(let i=0;i<2;i++){const x2=cx+(Math.random()-.5)*250,y2=cy+(Math.random()-.5)*200;
    const a=addAtom('O',x2-12,y2),b=addAtom('O',x2+12,y2);addBond(a,b,1);bonds[bonds.length-1].order=2;
    a.vx=(Math.random()-.5)*3;a.vy=(Math.random()-.5)*3;b.vx=a.vx;b.vy=a.vy}
  const ar=addAtom('Ar',cx+(Math.random()-.5)*200,cy+(Math.random()-.5)*200);
  ar.vx=(Math.random()-.5)*3;ar.vy=(Math.random()-.5)*3}},
'Steam (H₂O gas)':{cat:'gas',temp:400,build(cx,cy){
  for(let i=0;i<8;i++){const x2=cx+(Math.random()-.5)*280,y2=cy+(Math.random()-.5)*200;
    const o=addAtom('O',x2,y2),h1=addAtom('H',x2-20,y2+16),h2=addAtom('H',x2+20,y2+16);
    addBond(o,h1,1);addBond(o,h2,1);
    const v={x:(Math.random()-.5)*4,y:(Math.random()-.5)*4};o.vx=v.x;o.vy=v.y;h1.vx=v.x;h1.vy=v.y;h2.vx=v.x;h2.vy=v.y}}},
'Noble Gas Mix':{cat:'gas',temp:300,build(cx,cy){
  ['He','Ne','Ar','Kr','Xe'].forEach((sym,i)=>{
    for(let j=0;j<3;j++){const a=addAtom(sym,cx+(Math.random()-.5)*300,cy+(Math.random()-.5)*200);
      a.vx=(Math.random()-.5)*4;a.vy=(Math.random()-.5)*4}})}},
'Hydrogen Gas':{cat:'gas',temp:300,build(cx,cy){
  for(let i=0;i<10;i++){const x2=cx+(Math.random()-.5)*300,y2=cy+(Math.random()-.5)*200;
    const a=addAtom('H',x2-10,y2),b=addAtom('H',x2+10,y2);addBond(a,b,1);
    a.vx=(Math.random()-.5)*5;a.vy=(Math.random()-.5)*5;b.vx=a.vx;b.vy=a.vy}}},
// --- ACIDS & BASES ---
'H₂SO₄ — Sulfuric Acid':{cat:'mol',build(cx,cy){
  const s=addAtom('S',cx,cy);
  const o1=addAtom('O',cx-35,cy-20),o2=addAtom('O',cx+35,cy-20);
  const o3=addAtom('O',cx-30,cy+25),o4=addAtom('O',cx+30,cy+25);
  addBond(s,o1,1);bonds[bonds.length-1].order=2;addBond(s,o2,1);bonds[bonds.length-1].order=2;
  addBond(s,o3,1);addBond(s,o4,1);
  addBond(o3,addAtom('H',cx-52,cy+40),1);addBond(o4,addAtom('H',cx+52,cy+40),1)}},
'NaOH — Lye':{cat:'mol',build(cx,cy){
  const na=addAtom('Na',cx-35,cy),o=addAtom('O',cx,cy),h=addAtom('H',cx+28,cy);
  addBond(na,o,1);addBond(o,h,1)}},
'HNO₃ — Nitric Acid':{cat:'mol',build(cx,cy){
  const n=addAtom('N',cx,cy);
  addBond(n,addAtom('O',cx-35,cy-20),1);bonds[bonds.length-1].order=2;
  addBond(n,addAtom('O',cx+35,cy-20),1);bonds[bonds.length-1].order=2;
  const o=addAtom('O',cx,cy+30);addBond(n,o,1);addBond(o,addAtom('H',cx+25,cy+45),1)}},
// --- BIO MOLECULES ---
'ATP Backbone (simplified)':{cat:'bio',build(cx,cy){
  // Simplified: adenine ring + ribose + 3 phosphates
  const p1=addAtom('P',cx-80,cy),p2=addAtom('P',cx-45,cy),p3=addAtom('P',cx-10,cy);
  addBond(p1,addAtom('O',cx-95,cy-18),1);addBond(p1,addAtom('O',cx-95,cy+18),1);
  addBond(p1,p2,1);addBond(p2,addAtom('O',cx-45,cy-22),1);
  addBond(p2,p3,1);addBond(p3,addAtom('O',cx-10,cy-22),1);
  const c1=addAtom('C',cx+20,cy),c2=addAtom('C',cx+42,cy+15),c3=addAtom('C',cx+65,cy);
  addBond(p3,c1,1);addBond(c1,c2,1);addBond(c2,c3,1);
  addBond(c3,addAtom('N',cx+85,cy-15),1);addBond(c3,addAtom('N',cx+85,cy+15),1)}},
'DNA Base Pair (A-T)':{cat:'bio',build(cx,cy){
  // Simplified adenine-thymine with hydrogen bonds
  const n1=addAtom('N',cx-40,cy-15),c1=addAtom('C',cx-20,cy),n2=addAtom('N',cx,cy+15);
  const n3=addAtom('N',cx+20,cy),c2=addAtom('C',cx+40,cy-15),o1=addAtom('O',cx+60,cy);
  addBond(n1,c1,1);addBond(c1,n2,1);bonds[bonds.length-1].order=2;addBond(n2,n3,1);
  addBond(n3,c2,1);addBond(c2,o1,1);bonds[bonds.length-1].order=2;
  addBond(n1,addAtom('H',cx-58,cy-25),1);addBond(c2,addAtom('C',cx+40,cy-38),1)}},
'Amino Acid (Glycine)':{cat:'bio',build(cx,cy){
  const n=addAtom('N',cx-40,cy),ca=addAtom('C',cx-10,cy),c=addAtom('C',cx+25,cy);
  const o=addAtom('O',cx+50,cy-18),oh=addAtom('O',cx+25,cy+30);
  addBond(n,ca,1);addBond(ca,c,1);addBond(c,o,1);bonds[bonds.length-1].order=2;addBond(c,oh,1);
  addBond(oh,addAtom('H',cx+45,cy+40),1);
  addBond(n,addAtom('H',cx-58,cy-12),1);addBond(n,addAtom('H',cx-58,cy+12),1);
  addBond(ca,addAtom('H',cx-10,cy-28),1);addBond(ca,addAtom('H',cx-10,cy+28),1)}},
// --- FUN / SPECIAL ---
'Buckminsterfullerene (C₆₀ fragment)':{cat:'crystal',build(cx,cy){
  // Partial C60 - hexagonal rings
  const r1=35,r2=65,as=[];
  for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/2;as.push(addAtom('C',cx+Math.cos(a)*r1,cy+Math.sin(a)*r1))}
  for(let i=0;i<12;i++){const a=i*Math.PI/6-Math.PI/12;as.push(addAtom('C',cx+Math.cos(a)*r2,cy+Math.sin(a)*r2))}
  for(let i=0;i<6;i++){addBond(as[i],as[(i+1)%6],1);if(i%2===0)bonds[bonds.length-1].order=2}
  for(let i=0;i<6;i++){addBond(as[i],as[6+i*2],1);addBond(as[i],as[6+(i*2+1)%12],1)}}},
'UF₆ — Uranium Hexafluoride':{cat:'mol',build(cx,cy){
  const u=addAtom('U',cx,cy);
  const dirs=[[0,-40],[0,40],[-40,0],[40,0],[-28,-28],[28,28]];
  dirs.forEach(([dx,dy])=>addBond(u,addAtom('F',cx+dx,cy+dy),1))}},
'Rust (Fe₂O₃)':{cat:'mol',build(cx,cy){
  const fe1=addAtom('Fe',cx-25,cy),fe2=addAtom('Fe',cx+25,cy);
  const o1=addAtom('O',cx,cy-25),o2=addAtom('O',cx-40,cy+20),o3=addAtom('O',cx+40,cy+20);
  addBond(fe1,o1,1);addBond(fe2,o1,1);addBond(fe1,o2,1);addBond(fe2,o3,1)}},
// --- MORE MOLECULES ---
'H₂S — Hydrogen Sulfide':{cat:'mol',build(cx,cy){
  const s=addAtom('S',cx,cy);addBond(s,addAtom('H',cx-28,cy+22),1);addBond(s,addAtom('H',cx+28,cy+22),1)}},
'NO₂ — Nitrogen Dioxide':{cat:'mol',build(cx,cy){
  const n=addAtom('N',cx,cy);addBond(n,addAtom('O',cx-32,cy+20),1);bonds[bonds.length-1].order=2;
  addBond(n,addAtom('O',cx+32,cy+20),1)}},
'CO — Carbon Monoxide':{cat:'mol',build(cx,cy){
  const c=addAtom('C',cx-18,cy),o=addAtom('O',cx+18,cy);addBond(c,o,1);bonds[bonds.length-1].order=3}},
'CCl₄ — Carbon Tetrachloride':{cat:'mol',build(cx,cy){
  const c=addAtom('C',cx,cy);addBond(c,addAtom('Cl',cx-30,cy-30),1);addBond(c,addAtom('Cl',cx+30,cy-30),1);
  addBond(c,addAtom('Cl',cx-30,cy+30),1);addBond(c,addAtom('Cl',cx+30,cy+30),1)}},
'SF₆ — Sulfur Hexafluoride':{cat:'mol',build(cx,cy){
  const s=addAtom('S',cx,cy);const dirs=[[0,-36],[0,36],[-36,0],[36,0],[-25,-25],[25,25]];
  dirs.forEach(([dx,dy])=>addBond(s,addAtom('F',cx+dx,cy+dy),1))}},
'PCl₅ — Phosphorus Pentachloride':{cat:'mol',build(cx,cy){
  const p=addAtom('P',cx,cy);
  for(let i=0;i<5;i++){const a=i*Math.PI*2/5-Math.PI/2;addBond(p,addAtom('Cl',cx+Math.cos(a)*35,cy+Math.sin(a)*35),1)}}},
'N₂O — Laughing Gas':{cat:'mol',build(cx,cy){
  const n1=addAtom('N',cx-22,cy),n2=addAtom('N',cx,cy),o=addAtom('O',cx+22,cy);
  addBond(n1,n2,1);bonds[bonds.length-1].order=2;addBond(n2,o,1);bonds[bonds.length-1].order=2}},
'PH₃ — Phosphine':{cat:'mol',build(cx,cy){
  const p=addAtom('P',cx,cy);addBond(p,addAtom('H',cx-26,cy+22),1);
  addBond(p,addAtom('H',cx+26,cy+22),1);addBond(p,addAtom('H',cx,cy-28),1)}},
'SiH₄ — Silane':{cat:'mol',build(cx,cy){
  const si=addAtom('Si',cx,cy);addBond(si,addAtom('H',cx-28,cy-28),1);addBond(si,addAtom('H',cx+28,cy-28),1);
  addBond(si,addAtom('H',cx-28,cy+28),1);addBond(si,addAtom('H',cx+28,cy+28),1)}},
'ClF₃ — Chlorine Trifluoride':{cat:'mol',build(cx,cy){
  const cl=addAtom('Cl',cx,cy);addBond(cl,addAtom('F',cx,cy-34),1);
  addBond(cl,addAtom('F',cx-30,cy+20),1);addBond(cl,addAtom('F',cx+30,cy+20),1)}},
'XeF₂ — Xenon Difluoride':{cat:'mol',build(cx,cy){
  const xe=addAtom('Xe',cx,cy);addBond(xe,addAtom('F',cx-38,cy),1);addBond(xe,addAtom('F',cx+38,cy),1)}},
'BF₃ — Boron Trifluoride':{cat:'mol',build(cx,cy){
  const b=addAtom('B',cx,cy);for(let i=0;i<3;i++){const a=i*Math.PI*2/3-Math.PI/2;
  addBond(b,addAtom('F',cx+Math.cos(a)*32,cy+Math.sin(a)*32),1)}}},
// --- MORE ORGANIC ---
'C₃H₈ — Propane':{cat:'org',build(cx,cy){
  const c1=addAtom('C',cx-40,cy),c2=addAtom('C',cx,cy),c3=addAtom('C',cx+40,cy);
  addBond(c1,c2,1);addBond(c2,c3,1);
  addBond(c1,addAtom('H',cx-65,cy-18),1);addBond(c1,addAtom('H',cx-65,cy+18),1);addBond(c1,addAtom('H',cx-40,cy-28),1);
  addBond(c2,addAtom('H',cx,cy-28),1);addBond(c2,addAtom('H',cx,cy+28),1);
  addBond(c3,addAtom('H',cx+65,cy-18),1);addBond(c3,addAtom('H',cx+65,cy+18),1);addBond(c3,addAtom('H',cx+40,cy+28),1)}},
'CH₂O — Formaldehyde':{cat:'org',build(cx,cy){
  const c=addAtom('C',cx,cy),o=addAtom('O',cx+30,cy);addBond(c,o,1);bonds[bonds.length-1].order=2;
  addBond(c,addAtom('H',cx-25,cy-20),1);addBond(c,addAtom('H',cx-25,cy+20),1)}},
'C₃H₆O — Acetone':{cat:'org',build(cx,cy){
  const c1=addAtom('C',cx-35,cy),c2=addAtom('C',cx,cy),c3=addAtom('C',cx+35,cy);
  const o=addAtom('O',cx,cy-30);addBond(c1,c2,1);addBond(c2,c3,1);addBond(c2,o,1);bonds[bonds.length-1].order=2;
  addBond(c1,addAtom('H',cx-55,cy-18),1);addBond(c1,addAtom('H',cx-55,cy+18),1);addBond(c1,addAtom('H',cx-35,cy+28),1);
  addBond(c3,addAtom('H',cx+55,cy-18),1);addBond(c3,addAtom('H',cx+55,cy+18),1);addBond(c3,addAtom('H',cx+35,cy+28),1)}},
'CH₂O₂ — Formic Acid':{cat:'org',build(cx,cy){
  const c=addAtom('C',cx,cy),o1=addAtom('O',cx+30,cy-18),o2=addAtom('O',cx+30,cy+18);
  addBond(c,o1,1);bonds[bonds.length-1].order=2;addBond(c,o2,1);addBond(o2,addAtom('H',cx+52,cy+28),1);
  addBond(c,addAtom('H',cx-25,cy),1)}},
'C₂H₄O₂ — Acetic Acid':{cat:'org',build(cx,cy){
  const c1=addAtom('C',cx-20,cy),c2=addAtom('C',cx+20,cy);addBond(c1,c2,1);
  const o1=addAtom('O',cx+45,cy-18),o2=addAtom('O',cx+45,cy+18);
  addBond(c2,o1,1);bonds[bonds.length-1].order=2;addBond(c2,o2,1);addBond(o2,addAtom('H',cx+65,cy+28),1);
  addBond(c1,addAtom('H',cx-42,cy-16),1);addBond(c1,addAtom('H',cx-42,cy+16),1);addBond(c1,addAtom('H',cx-20,cy-28),1)}},
'C₇H₈ — Toluene':{cat:'org',build(cx,cy){
  const r=38,cs=[];
  for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/2;cs.push(addAtom('C',cx+Math.cos(a)*r,cy+Math.sin(a)*r))}
  for(let i=0;i<6;i++){addBond(cs[i],cs[(i+1)%6],1);if(i%2===0)bonds[bonds.length-1].order=2}
  for(let i=1;i<6;i++){const a=i*Math.PI/3-Math.PI/2;addBond(cs[i],addAtom('H',cx+Math.cos(a)*(r+26),cy+Math.sin(a)*(r+26)),1)}
  // Methyl group on top
  const ch3=addAtom('C',cx,cy-r-28);addBond(cs[0],ch3,1);
  addBond(ch3,addAtom('H',cx-18,cy-r-46),1);addBond(ch3,addAtom('H',cx+18,cy-r-46),1);addBond(ch3,addAtom('H',cx,cy-r-56),1)}},
'C₁₀H₈ — Naphthalene':{cat:'org',build(cx,cy){
  const r=30,cs=[];
  // Two fused hexagons
  for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/2;cs.push(addAtom('C',cx-r*0.87+Math.cos(a)*r,cy+Math.sin(a)*r))}
  for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/2;cs.push(addAtom('C',cx+r*0.87+Math.cos(a)*r,cy+Math.sin(a)*r))}
  for(let i=0;i<6;i++)addBond(cs[i],cs[(i+1)%6],1);
  for(let i=6;i<12;i++)addBond(cs[i],cs[i===11?6:(i+1)],1);
  // Shared edge
  addBond(cs[1],cs[10],1);addBond(cs[2],cs[9],1)}},
// --- MORE IONIC ---
'LiF — Lithium Fluoride':{cat:'ionic',build(cx,cy){
  addBond(addAtom('Li',cx-22,cy),addAtom('F',cx+22,cy),1)}},
'CaCl₂ — Calcium Chloride':{cat:'ionic',build(cx,cy){
  const ca=addAtom('Ca',cx,cy);addBond(ca,addAtom('Cl',cx-34,cy),1);addBond(ca,addAtom('Cl',cx+34,cy),1)}},
'Na₂O — Sodium Oxide':{cat:'ionic',build(cx,cy){
  const o=addAtom('O',cx,cy);addBond(o,addAtom('Na',cx-32,cy),1);addBond(o,addAtom('Na',cx+32,cy),1)}},
'AlCl₃ — Aluminum Chloride':{cat:'ionic',build(cx,cy){
  const al=addAtom('Al',cx,cy);for(let i=0;i<3;i++){const a=i*Math.PI*2/3-Math.PI/2;
  addBond(al,addAtom('Cl',cx+Math.cos(a)*34,cy+Math.sin(a)*34),1)}}},
'BaO — Barium Oxide':{cat:'ionic',build(cx,cy){
  addBond(addAtom('Ba',cx-25,cy),addAtom('O',cx+25,cy),1)}},
'FeCl₃ — Iron(III) Chloride':{cat:'ionic',build(cx,cy){
  const fe=addAtom('Fe',cx,cy);for(let i=0;i<3;i++){const a=i*Math.PI*2/3-Math.PI/2;
  addBond(fe,addAtom('Cl',cx+Math.cos(a)*34,cy+Math.sin(a)*34),1)}}},
'TiO₂ — Titanium Dioxide':{cat:'ionic',build(cx,cy){
  const ti=addAtom('Ti',cx,cy);addBond(ti,addAtom('O',cx-30,cy+20),1);addBond(ti,addAtom('O',cx+30,cy+20),1)}},
// --- MORE CRYSTALS ---
'Copper Crystal (FCC)':{cat:'crystal',build(cx,cy){
  const s=36,as=[];
  for(let r=0;r<3;r++)for(let c=0;c<3;c++)as.push(addAtom('Cu',cx-s+c*s,cy-s+r*s));
  // Face centers
  as.push(addAtom('Cu',cx-s/2,cy-s/2));as.push(addAtom('Cu',cx+s/2,cy-s/2));
  as.push(addAtom('Cu',cx-s/2,cy+s/2));as.push(addAtom('Cu',cx+s/2,cy+s/2));
  for(let r=0;r<3;r++)for(let c=0;c<3;c++){const i=r*3+c;
    if(c<2)addBond(as[i],as[i+1],1);if(r<2)addBond(as[i],as[i+3],1)}
  // Connect face centers to corners
  addBond(as[9],as[0],1);addBond(as[9],as[1],1);addBond(as[9],as[3],1);addBond(as[9],as[4],1);
  addBond(as[10],as[1],1);addBond(as[10],as[2],1);addBond(as[10],as[4],1);addBond(as[10],as[5],1)}},
'Silver Chain':{cat:'crystal',build(cx,cy){
  let prev=null;
  for(let i=0;i<8;i++){const a=addAtom('Ag',cx-100+i*28,cy+Math.sin(i*0.8)*15);
    if(prev)addBond(prev,a,1);prev=a}}},
'Platinum Square':{cat:'crystal',build(cx,cy){
  const s=35,as=[];
  for(let r=0;r<3;r++)for(let c=0;c<3;c++)as.push(addAtom('Pt',cx-s+c*s,cy-s+r*s));
  for(let r=0;r<3;r++)for(let c=0;c<3;c++){const i=r*3+c;
    if(c<2)addBond(as[i],as[i+1],1);if(r<2)addBond(as[i],as[i+3],1)}}},
'Titanium Carbide':{cat:'crystal',build(cx,cy){
  const s=36,as=[];
  for(let r=0;r<3;r++)for(let c=0;c<3;c++){
    as.push(addAtom((r+c)%2===0?'Ti':'C',cx-s+c*s,cy-s+r*s))}
  for(let r=0;r<3;r++)for(let c=0;c<3;c++){const i=r*3+c;
    if(c<2)addBond(as[i],as[i+1],1);if(r<2)addBond(as[i],as[i+3],1)}}},
'Salt Crystal (5×5)':{cat:'crystal',temp:250,build(cx,cy){
  const g=32,as=[];
  for(let r=0;r<5;r++)for(let c=0;c<5;c++){
    as.push(addAtom((r+c)%2===0?'Na':'Cl',cx-g*2+c*g,cy-g*2+r*g))}
  for(let r=0;r<5;r++)for(let c=0;c<5;c++){const i=r*5+c;
    if(c<4)addBond(as[i],as[i+1],1);if(r<4)addBond(as[i],as[i+5],1)}}},
// --- MORE GASES ---
'CO₂ Atmosphere':{cat:'gas',temp:300,build(cx,cy){
  for(let i=0;i<6;i++){const x2=cx+(Math.random()-.5)*280,y2=cy+(Math.random()-.5)*200;
    const c=addAtom('C',x2,y2),o1=addAtom('O',x2-22,y2),o2=addAtom('O',x2+22,y2);
    addBond(c,o1,1);bonds[bonds.length-1].order=2;addBond(c,o2,1);bonds[bonds.length-1].order=2;
    const v=(Math.random()-.5)*3;c.vx=v;o1.vx=v;o2.vx=v;c.vy=v;o1.vy=v;o2.vy=v}}},
'Chlorine Gas':{cat:'gas',temp:300,build(cx,cy){
  for(let i=0;i<8;i++){const x2=cx+(Math.random()-.5)*280,y2=cy+(Math.random()-.5)*200;
    const a=addAtom('Cl',x2-14,y2),b=addAtom('Cl',x2+14,y2);addBond(a,b,1);
    a.vx=(Math.random()-.5)*3;a.vy=(Math.random()-.5)*3;b.vx=a.vx;b.vy=a.vy}}},
'Ammonia Gas':{cat:'gas',temp:250,build(cx,cy){
  for(let i=0;i<6;i++){const x2=cx+(Math.random()-.5)*260,y2=cy+(Math.random()-.5)*180;
    const n=addAtom('N',x2,y2);addBond(n,addAtom('H',x2-18,y2+16),1);
    addBond(n,addAtom('H',x2+18,y2+16),1);addBond(n,addAtom('H',x2,y2-20),1);
    const v={x:(Math.random()-.5)*3,y:(Math.random()-.5)*3};
    atoms.slice(-4).forEach(a=>{a.vx=v.x;a.vy=v.y})}}},
'Methane Cloud':{cat:'gas',temp:300,build(cx,cy){
  for(let i=0;i<5;i++){const x2=cx+(Math.random()-.5)*260,y2=cy+(Math.random()-.5)*180;
    const c=addAtom('C',x2,y2);addBond(c,addAtom('H',x2-20,y2-20),1);addBond(c,addAtom('H',x2+20,y2-20),1);
    addBond(c,addAtom('H',x2-20,y2+20),1);addBond(c,addAtom('H',x2+20,y2+20),1);
    const v={x:(Math.random()-.5)*3,y:(Math.random()-.5)*3};
    atoms.slice(-5).forEach(a=>{a.vx=v.x;a.vy=v.y})}}},
'Plasma (Hot Ions)':{cat:'gas',temp:50000,build(cx,cy){
  ['H','H','H','H','He','He','O','N','Fe','Na'].forEach(sym=>{
    const a=addAtom(sym,cx+(Math.random()-.5)*300,cy+(Math.random()-.5)*200);
    a.vx=(Math.random()-.5)*6;a.vy=(Math.random()-.5)*6;
    a.electrons=Math.max(0,a.electrons-Math.floor(Math.random()*3));
    a.charge=getEl(a).z-a.electrons;
  })}},
// --- MORE BIO ---
'Glucose (C₆H₁₂O₆)':{cat:'bio',build(cx,cy){
  // Simplified ring form
  const r=35,cs=[];
  for(let i=0;i<5;i++){const a=i*Math.PI*2/5-Math.PI/2;cs.push(addAtom('C',cx+Math.cos(a)*r,cy+Math.sin(a)*r))}
  const o=addAtom('O',cx+Math.cos(-Math.PI/2+Math.PI*2)*r*0.8,cy+Math.sin(-Math.PI/2+Math.PI*2)*r*0.8);
  for(let i=0;i<4;i++)addBond(cs[i],cs[i+1],1);
  addBond(cs[4],o,1);addBond(o,cs[0],1);
  // OH groups
  cs.forEach((c,i)=>{const a=i*Math.PI*2/5-Math.PI/2;
    const ox=addAtom('O',cx+Math.cos(a)*(r+24),cy+Math.sin(a)*(r+24));addBond(c,ox,1);
    addBond(ox,addAtom('H',cx+Math.cos(a)*(r+42),cy+Math.sin(a)*(r+42)),1)})}},
'Caffeine (simplified)':{cat:'bio',build(cx,cy){
  // Two fused rings
  const cs=[];
  for(let i=0;i<6;i++){const a=i*Math.PI/3;cs.push(addAtom(i%3===0?'N':'C',cx-18+Math.cos(a)*28,cy+Math.sin(a)*28))}
  for(let i=0;i<5;i++){const a=i*Math.PI*2/5;cs.push(addAtom(i%2===0?'N':'C',cx+22+Math.cos(a)*22,cy+Math.sin(a)*22))}
  for(let i=0;i<6;i++)addBond(cs[i],cs[(i+1)%6],1);
  for(let i=6;i<11;i++)addBond(cs[i],cs[i===10?6:(i+1)],1);
  addBond(cs[1],cs[7],1);addBond(cs[2],cs[10],1);
  // Oxygens
  addBond(cs[3],addAtom('O',cx-55,cy+20),1);bonds[bonds.length-1].order=2;
  addBond(cs[5],addAtom('O',cx-10,cy-50),1);bonds[bonds.length-1].order=2}},
'Peptide Bond (Gly-Ala)':{cat:'bio',build(cx,cy){
  // Two amino acids linked
  const n1=addAtom('N',cx-70,cy),ca1=addAtom('C',cx-45,cy),c1=addAtom('C',cx-15,cy);
  const o1=addAtom('O',cx-15,cy-28);addBond(n1,ca1,1);addBond(ca1,c1,1);addBond(c1,o1,1);bonds[bonds.length-1].order=2;
  addBond(n1,addAtom('H',cx-85,cy-14),1);addBond(n1,addAtom('H',cx-85,cy+14),1);
  addBond(ca1,addAtom('H',cx-45,cy-26),1);addBond(ca1,addAtom('H',cx-45,cy+26),1);
  // Peptide bond
  const n2=addAtom('N',cx+10,cy);addBond(c1,n2,1);addBond(n2,addAtom('H',cx+10,cy+22),1);
  const ca2=addAtom('C',cx+35,cy),c2=addAtom('C',cx+65,cy);
  addBond(n2,ca2,1);addBond(ca2,c2,1);
  addBond(ca2,addAtom('C',cx+35,cy-28),1); // side chain
  addBond(c2,addAtom('O',cx+85,cy-14),1);bonds[bonds.length-1].order=2;
  const oh=addAtom('O',cx+85,cy+14);addBond(c2,oh,1);addBond(oh,addAtom('H',cx+100,cy+24),1)}},
'Phospholipid (simplified)':{cat:'bio',build(cx,cy){
  // Head: phosphate + glycerol
  const p=addAtom('P',cx,cy-60);addBond(p,addAtom('O',cx-20,cy-75),1);addBond(p,addAtom('O',cx+20,cy-75),1);
  addBond(p,addAtom('O',cx,cy-85),1);
  const g=addAtom('C',cx,cy-38);addBond(p,g,1);
  // Two tails
  let prev1=g,prev2=g;
  for(let i=0;i<6;i++){
    const c1=addAtom('C',cx-12,cy-20+i*22);addBond(prev1,c1,1);prev1=c1;
    const c2=addAtom('C',cx+12,cy-20+i*22);if(i===0)addBond(g,c2,1);else addBond(prev2,c2,1);prev2=c2;
  }}},
// --- SPECIAL / FUN ---
'Water Cluster (ice-like)':{cat:'crystal',temp:200,build(cx,cy){
  // Hexagonal ice pattern
  const mols=[];
  for(let r=0;r<3;r++)for(let c=0;c<3;c++){
    const off=(r%2)*22;
    const x2=cx-44+c*44+off,y2=cy-38+r*38;
    const o=addAtom('O',x2,y2);const h1=addAtom('H',x2-14,y2+12);const h2=addAtom('H',x2+14,y2+12);
    addBond(o,h1,1);addBond(o,h2,1);mols.push(o)}
  // H-bonds between water molecules (simplified)
  for(let i=0;i<mols.length;i++)for(let j=i+1;j<mols.length;j++){
    const d=Math.sqrt((mols[i].x-mols[j].x)**2+(mols[i].y-mols[j].y)**2);
    if(d<55)addBond(mols[i],mols[j],1)}}},
'TNT (simplified)':{cat:'org',build(cx,cy){
  // Toluene + 3 NO₂ groups
  const r=34,cs=[];
  for(let i=0;i<6;i++){const a=i*Math.PI/3-Math.PI/2;cs.push(addAtom('C',cx+Math.cos(a)*r,cy+Math.sin(a)*r))}
  for(let i=0;i<6;i++){addBond(cs[i],cs[(i+1)%6],1);if(i%2===0)bonds[bonds.length-1].order=2}
  // Methyl top
  addBond(cs[0],addAtom('C',cx,cy-r-24),1);
  // NO₂ groups at positions 2,4,6
  [1,3,5].forEach(i=>{const a=i*Math.PI/3-Math.PI/2;
    const n=addAtom('N',cx+Math.cos(a)*(r+22),cy+Math.sin(a)*(r+22));addBond(cs[i],n,1);
    addBond(n,addAtom('O',cx+Math.cos(a-0.4)*(r+44),cy+Math.sin(a-0.4)*(r+44)),1);
    addBond(n,addAtom('O',cx+Math.cos(a+0.4)*(r+44),cy+Math.sin(a+0.4)*(r+44)),1)})}},
'Uranium Decay Chain':{cat:'gas',temp:1500,build(cx,cy){
  // Scatter of heavy + decay products
  const u=addAtom('U',cx,cy);u.vx=0.5;
  addAtom('Th',cx+60,cy-30).vx=1;
  addAtom('Ra',cx-50,cy+40).vx=-0.8;
  addAtom('Rn',cx+30,cy+60).vy=-1;
  const he1=addAtom('He',cx-40,cy-40);he1.vx=-3;he1.vy=-2;
  const he2=addAtom('He',cx+80,cy+20);he2.vx=3;he2.vy=1;
  addAtom('Pb',cx-70,cy-10).vx=-0.3}},
'Neon Signs':{cat:'gas',temp:800,build(cx,cy){
  ['Ne','Ne','Ne','Ne','Ne','Ar','Ar','Ar','Kr','Xe'].forEach((sym,i)=>{
    const a=addAtom(sym,cx+(Math.random()-.5)*300,cy+(Math.random()-.5)*200);
    a.vx=(Math.random()-.5)*4;a.vy=(Math.random()-.5)*4;
    // Pre-ionize some for glow
    if(Math.random()<0.4){a.electrons--;a.charge++}})}},
};

// Build structure buttons
const structCats={mol:'Molecules',org:'Organic',ionic:'Ionic',crystal:'Crystals',gas:'Gases',bio:'Biomolecules'};
const gStruct=document.getElementById('gStruct');
Object.entries(structCats).forEach(([catKey,catLabel])=>{
  const lbl=document.createElement('div');lbl.className='structCat';
  lbl.textContent=catLabel;gStruct.appendChild(lbl);
  Object.entries(STRUCTURES).forEach(([name,s])=>{
    if(s.cat!==catKey)return;
    const b=document.createElement('button');b.className='structBtn';
    b.textContent=name;
    b.addEventListener('click',()=>{s.build(W/2+(Math.random()-.5)*60,H/2+(Math.random()-.5)*60);
      document.getElementById('modeName').textContent='Spawned: '+name;
      // Auto-adjust temperature if preset specifies one
      if(s.temp!==undefined){
        // Convert Kelvin to slider position: slider = log10(temp)/7.176*1000
        const sv=Math.round(Math.log10(Math.max(1,s.temp))/7.176*1000);
        document.getElementById('sTemp').value=sv;
        document.getElementById('sTemp').dispatchEvent(new Event('input'));
      }});
    gStruct.appendChild(b);
  });
});
// Sliders
document.getElementById('sTemp').addEventListener('input',e=>{
  // Logarithmic: slider 0-1000 maps to 1K - 15,000,000K
  const v=+e.target.value;
  envTemp=Math.round(Math.pow(10, v/1000*7.176)); // 10^0=1, 10^7.176=15M
  if(envTemp<1)envTemp=1;
  // Format display
  let label;
  if(envTemp>=1e6)label=(envTemp/1e6).toFixed(1)+'M K';
  else if(envTemp>=1e3)label=(envTemp/1e3).toFixed(envTemp>=1e4?0:1)+'K K';
  else label=envTemp+' K';
  document.getElementById('sTempV').textContent=label;
});
document.getElementById('sEF').addEventListener('input',e=>{eField=+e.target.value;document.getElementById('sEFV').textContent=eField});
document.getElementById('sSpd').addEventListener('input',e=>{simSpd=+e.target.value;document.getElementById('sSpdV').textContent=simSpd});
document.getElementById('sGrav').addEventListener('input',e=>{grav=+e.target.value;document.getElementById('sGravV').textContent=grav});
document.getElementById('sPres').addEventListener('input',e=>{pressure=+e.target.value;document.getElementById('sPresV').textContent=pressure});
document.getElementById('sMag').addEventListener('input',e=>{magField=+e.target.value;document.getElementById('sMagV').textContent=magField});
document.getElementById('sRad').addEventListener('input',e=>{radiation=+e.target.value;document.getElementById('sRadV').textContent=radiation});
document.getElementById('sSize').addEventListener('input',e=>{atomScale=+e.target.value;document.getElementById('sSizeV').textContent=atomScale+'%'});
document.getElementById('sBStr').addEventListener('input',e=>{bondStr=+e.target.value;document.getElementById('sBStrV').textContent=bondStr+'%'});
document.getElementById('sDamp').addEventListener('input',e=>{damping=+e.target.value;document.getElementById('sDampV').textContent=damping+'%'});
// Reset helpers
function setSlider(id,val,displayVal){
  const el=document.getElementById(id);el.value=val;
  el.dispatchEvent(new Event('input'));
}
document.getElementById('resetEnv').addEventListener('click',()=>{
  setSlider('sTemp',345);setSlider('sEF',0);setSlider('sGrav',0);
  setSlider('sPres',0);setSlider('sMag',0);setSlider('sRad',0);
});
document.getElementById('resetSim').addEventListener('click',()=>{
  setSlider('sSpd',5);setSlider('sSize',100);setSlider('sBStr',100);setSlider('sDamp',95);
});
// Toggles
document.getElementById('bShells').addEventListener('click',function(){showShells=!showShells;this.classList.toggle('active',showShells)});
document.getElementById('bOrbitals').addEventListener('click',function(){showOrbitals=!showOrbitals;this.classList.toggle('active',showOrbitals)});
document.getElementById('bBonds').addEventListener('click',function(){showBonds=!showBonds;this.classList.toggle('active',showBonds)});
document.getElementById('bCharges').addEventListener('click',function(){showCharges=!showCharges;this.classList.toggle('active',showCharges)});
document.getElementById('bHBonds').addEventListener('click',function(){showHBonds=!showHBonds;this.classList.toggle('active',showHBonds)});
document.getElementById('bClear').addEventListener('click',()=>{atoms=[];bonds=[];nextId=1});
document.getElementById('bInfo').addEventListener('click',function(){showInfo=!showInfo;this.classList.toggle('active',showInfo);document.getElementById('infoP').classList.toggle('show',showInfo)});
// Keyboard
window.addEventListener('keydown',e=>{
  if(e.key==='c'){document.getElementById('bClear').click()}
  if(e.key==='Delete'||e.key==='Backspace'){if(hoverAtom)removeAtom(hoverAtom)}
});

// === MAIN LOOP ===
let fc=0,ft=0;
function loop(t){
  requestAnimationFrame(loop);
  const steps=Math.max(1,simSpd);for(let s=0;s<steps;s++)simulate(0.5);
  render();
}
resize();window.addEventListener('resize',resize);
requestAnimationFrame(loop);

// === MOBILE SUPPORT ===
const mobToggle=document.getElementById('mobToggle');
const mobOverlay=document.getElementById('mobOverlay');
const sideEl=document.getElementById('side');
mobToggle.addEventListener('click',()=>{
  sideEl.classList.toggle('open');
  mobOverlay.classList.toggle('show');
  mobToggle.textContent=sideEl.classList.contains('open')?'✕':'☰';
});
mobOverlay.addEventListener('click',()=>{
  sideEl.classList.remove('open');
  mobOverlay.classList.remove('show');
  mobToggle.textContent='☰';
});
// Close sidebar when spawning structure on mobile
const origStructClicks=document.querySelectorAll('#gStruct button');
origStructClicks.forEach(b=>b.addEventListener('click',()=>{
  if(window.innerWidth<=768){sideEl.classList.remove('open');mobOverlay.classList.remove('show');mobToggle.textContent='☰'}
}));

// Touch events on canvas — direct handling, not synthetic mouse events
let touchDragging=false;
mainCv.addEventListener('touchstart',e=>{
  e.preventDefault();
  const touch=e.touches[0];
  const r=mainCv.getBoundingClientRect();
  const x=touch.clientX-r.left,y=touch.clientY-r.top;
  mX=x;mY=y;
  
  if(mode==='place'){addAtom(selEl,x,y)}
  else if(mode==='drag'){
    const a=atomAt(x,y);
    if(a){dragAtom=a;dragOff={x:a.x-x,y:a.y-y};touchDragging=true}
  }
  else if(mode==='bond'){
    const a=atomAt(x,y);
    if(a){if(!bondStart)bondStart=a;
      else{if(bondStart!==a&&canBond(bondStart)&&canBond(a)&&!bondExists(bondStart,a)){
        addBond(bondStart,a,1);logBond(bondStart.sym+'-'+a.sym+' bond forced')}bondStart=null}}
  }
  else if(mode==='break_b'){
    const b=bondAt(x,y);
    if(b){const a1=atoms.find(a=>a.id===b.a),a2=atoms.find(a=>a.id===b.b);
      logBond((a1?a1.sym:'?')+'−'+(a2?a2.sym:'?')+' broken');removeBond(b)}
    else{const a=atomAt(x,y);if(a&&a.bonds.length>0){
      const lb=a.bonds[a.bonds.length-1];const oid=lb.a===a.id?lb.b:lb.a;
      const oa=atoms.find(x=>x.id===oid);logBond(a.sym+'−'+(oa?oa.sym:'?')+' broken');removeBond(lb)}}
  }
  else if(mode==='ionize'){
    const a=atomAt(x,y);
    if(a){if(!showCharges){showCharges=true;document.getElementById('bCharges').classList.add('active')}
      if(a.electrons>0){a.electrons--;a.charge++;
        logBond(a.sym+' − e⁻ → '+a.sym+(a.charge>0?a.charge+'⁺':a.charge===0?'':''+a.charge+'⁻'));
        const el=getEl(a);const maxB=Math.max(0,el.valence-a.charge);
        while(a.bonds.length>maxB&&a.bonds.length>0){const b=a.bonds[a.bonds.length-1];
          const oa=atoms.find(x=>x.id===(b.a===a.id?b.b:b.a));removeBond(b)}}}
  }
  else if(mode==='eraser'){const a=atomAt(x,y);if(a)removeAtom(a)}
},{passive:false});

mainCv.addEventListener('touchmove',e=>{
  e.preventDefault();
  const touch=e.touches[0];
  const r=mainCv.getBoundingClientRect();
  mX=touch.clientX-r.left;mY=touch.clientY-r.top;
  if(dragAtom){
    dragAtom.x=mX+dragOff.x;dragAtom.y=mY+dragOff.y;
    dragAtom.vx=0;dragAtom.vy=0;
  }
  hoverAtom=atomAt(mX,mY);
},{passive:false});

mainCv.addEventListener('touchend',e=>{
  e.preventDefault();
  if(touchDragging){dragAtom=null;touchDragging=false}
},{passive:false});

// Prevent zoom/scroll on canvas
document.addEventListener('touchmove',e=>{
  if(e.target===mainCv)e.preventDefault();
},{passive:false});

// ============================================================
// ============================================================
// === ORBITAL PROBABILITY CLOUD VIEWER (2D Canvas) ===
// ============================================================
(function(){
const ORB_NAMES=['s','p','d','f','g'];
const ORB_ELEMENTS=[
  {z:1,sym:'H',name:'Hydrogen',cfg:'1s\u00B9',shells:[1]},
  {z:2,sym:'He',name:'Helium',cfg:'1s\u00B2',shells:[2]},
  {z:3,sym:'Li',name:'Lithium',cfg:'[He] 2s\u00B9',shells:[2,1]},
  {z:4,sym:'Be',name:'Beryllium',cfg:'[He] 2s\u00B2',shells:[2,2]},
  {z:5,sym:'B',name:'Boron',cfg:'[He] 2s\u00B2 2p\u00B9',shells:[2,3]},
  {z:6,sym:'C',name:'Carbon',cfg:'[He] 2s\u00B2 2p\u00B2',shells:[2,4]},
  {z:7,sym:'N',name:'Nitrogen',cfg:'[He] 2s\u00B2 2p\u00B3',shells:[2,5]},
  {z:8,sym:'O',name:'Oxygen',cfg:'[He] 2s\u00B2 2p\u2074',shells:[2,6]},
  {z:9,sym:'F',name:'Fluorine',cfg:'[He] 2s\u00B2 2p\u2075',shells:[2,7]},
  {z:10,sym:'Ne',name:'Neon',cfg:'[He] 2s\u00B2 2p\u2076',shells:[2,8]},
  {z:11,sym:'Na',name:'Sodium',cfg:'[Ne] 3s\u00B9',shells:[2,8,1]},
  {z:12,sym:'Mg',name:'Magnesium',cfg:'[Ne] 3s\u00B2',shells:[2,8,2]},
  {z:13,sym:'Al',name:'Aluminum',cfg:'[Ne] 3s\u00B2 3p\u00B9',shells:[2,8,3]},
  {z:14,sym:'Si',name:'Silicon',cfg:'[Ne] 3s\u00B2 3p\u00B2',shells:[2,8,4]},
  {z:15,sym:'P',name:'Phosphorus',cfg:'[Ne] 3s\u00B2 3p\u00B3',shells:[2,8,5]},
  {z:16,sym:'S',name:'Sulfur',cfg:'[Ne] 3s\u00B2 3p\u2074',shells:[2,8,6]},
  {z:17,sym:'Cl',name:'Chlorine',cfg:'[Ne] 3s\u00B2 3p\u2075',shells:[2,8,7]},
  {z:18,sym:'Ar',name:'Argon',cfg:'[Ne] 3s\u00B2 3p\u2076',shells:[2,8,8]},
  {z:19,sym:'K',name:'Potassium',cfg:'[Ar] 4s\u00B9',shells:[2,8,8,1]},
  {z:20,sym:'Ca',name:'Calcium',cfg:'[Ar] 4s\u00B2',shells:[2,8,8,2]},
  {z:26,sym:'Fe',name:'Iron',cfg:'[Ar] 3d\u2076 4s\u00B2',shells:[2,8,14,2]},
  {z:29,sym:'Cu',name:'Copper',cfg:'[Ar] 3d\u00B9\u2070 4s\u00B9',shells:[2,8,18,1]},
  {z:30,sym:'Zn',name:'Zinc',cfg:'[Ar] 3d\u00B9\u2070 4s\u00B2',shells:[2,8,18,2]},
  {z:35,sym:'Br',name:'Bromine',cfg:'[Ar] 3d\u00B9\u2070 4s\u00B2 4p\u2075',shells:[2,8,18,7]},
  {z:36,sym:'Kr',name:'Krypton',cfg:'[Ar] 3d\u00B9\u2070 4s\u00B2 4p\u2076',shells:[2,8,18,8]},
  {z:47,sym:'Ag',name:'Silver',cfg:'[Kr] 4d\u00B9\u2070 5s\u00B9',shells:[2,8,18,18,1]},
  {z:79,sym:'Au',name:'Gold',cfg:'[Xe] 4f\u00B9\u2074 5d\u00B9\u2070 6s\u00B9',shells:[2,8,18,32,18,1]},
];

let orbPts=[],orbRY=0,orbRX=0.4,orbAutoSpin=true,orbInited=false;
let orbMouseDown=false,orbLastX=0,orbLastY=0;
let orbAnim=null,orbCv,orbCtx,orbW,orbH,dpr;

const orbQN={n:1,l:0,m:0,pts:15000};
const PTS_OPTIONS=[5000,10000,15000,25000,40000];

// === Wavefunction sampling — proper real spherical harmonics ===
function genOrb(){
  const n=orbQN.n,l=orbQN.l,m=orbQN.m,pts=orbQN.pts;
  orbPts=[];
  const TAU=Math.PI*2,PI=Math.PI;

  // Real spherical harmonic Y_l^m(theta, phi)
  // These produce the actual orbital shapes — lobes, not toroids
  function realY(l,m,ct,st,ph){
    // ct=cos(theta), st=sin(theta), ph=phi
    if(l===0) return 1;
    if(l===1){
      if(m===0) return ct;                    // pz: lobe along z
      if(m===1) return st*Math.cos(ph);       // px: lobe along x
      if(m===-1) return st*Math.sin(ph);      // py: lobe along y
    }
    if(l===2){
      const st2=st*st,ct2=ct*ct;
      if(m===0) return 3*ct2-1;               // dz²: donut+lobes along z
      if(m===1) return st*ct*Math.cos(ph);    // dxz
      if(m===-1) return st*ct*Math.sin(ph);   // dyz
      if(m===2) return st2*Math.cos(2*ph);    // dx²-y²: clover in xy
      if(m===-2) return st2*Math.sin(2*ph);   // dxy: rotated clover
    }
    if(l===3){
      const ct2=ct*ct,st2=st*st;
      if(m===0) return ct*(5*ct2-3);           // fz³
      if(m===1) return st*(5*ct2-1)*Math.cos(ph);  // fxz²
      if(m===-1) return st*(5*ct2-1)*Math.sin(ph);
      if(m===2) return st2*ct*Math.cos(2*ph);      // fxyz
      if(m===-2) return st2*ct*Math.sin(2*ph);
      if(m===3) return st2*st*Math.cos(3*ph);      // fx(x²-3y²)
      if(m===-3) return st2*st*Math.sin(3*ph);
    }
    // Generic fallback for l>=4
    const am=Math.abs(m);
    const angular=Math.pow(st,am)*Math.pow(Math.abs(ct),Math.max(0,l-am));
    return m>=0?angular*Math.cos(am*ph):angular*Math.sin(am*ph);
  }

  // Radial wavefunction R(n,l,r) — associated Laguerre approximation
  function radialR(n,l,r){
    const rho=2*r/n;
    let R=Math.pow(rho,l)*Math.exp(-rho/2);
    const nr=n-l-1;
    if(nr===0) return R;
    if(nr===1) return R*(1-rho/(2*(l+1)));
    if(nr===2) return R*(1-rho/(l+1)+rho*rho/(4*(l+1)*(l+2)));
    if(nr===3) return R*(1-rho*(3.0/(l+1))/4+rho*rho/(4*(l+1)*(l+2))-rho*rho*rho/(24*(l+1)*(l+2)*(l+3)));
    // Higher nr — use polynomial recursion
    let L=1,L1=1-rho/(2*l+2+1);
    for(let k=2;k<=nr;k++){
      const Lnew=((2*k-1+2*l+1-rho)*L1-(k-1+2*l+1)*L)/(k);
      L=L1;L1=Lnew;
    }
    return R*L1;
  }

  // Pre-scan to find max probability for rejection sampling
  let maxP=0;
  for(let i=0;i<1000;i++){
    const r=Math.random()*n*5.5;
    const th=Math.acos(2*Math.random()-1);
    const ph=Math.random()*TAU;
    const R=radialR(n,l,r);
    const Y=realY(l,m,Math.cos(th),Math.sin(th),ph);
    const p=R*R*Y*Y*r*r;
    if(p>maxP)maxP=p;
  }
  if(maxP<1e-30)maxP=1;

  // Rejection sampling
  let attempts=0;
  while(orbPts.length<pts&&attempts<pts*60){
    attempts++;
    const r=Math.random()*n*5.5;
    const th=Math.acos(2*Math.random()-1);
    const ph=Math.random()*TAU;
    const ct=Math.cos(th),st=Math.sin(th);
    const R=radialR(n,l,r);
    const Y=realY(l,m,ct,st,ph);
    const prob=R*R*Y*Y*r*r;
    if(Math.random()<prob/maxP){
      orbPts.push({
        x:r*st*Math.cos(ph),
        y:r*st*Math.sin(ph),
        z:r*ct,
        r:r,
        sign:Y>=0?1:-1  // track lobe sign for coloring
      });
    }
  }
}

// === 2D Canvas renderer (QUANTUM.LAB style) ===
function initOrb(){
  if(orbInited)return;
  orbInited=true;
  orbCv=document.getElementById('orbCv');
  const wrap=document.getElementById('orbWrap');
  dpr=Math.min(window.devicePixelRatio||1,2);
  orbW=wrap.clientWidth;orbH=wrap.clientHeight;
  orbCv.width=orbW*dpr;orbCv.height=orbH*dpr;
  orbCv.style.width=orbW+'px';orbCv.style.height=orbH+'px';
  orbCtx=orbCv.getContext('2d');
  orbCtx.setTransform(dpr,0,0,dpr,0,0);

  genOrb();

  // Mouse controls
  orbCv.addEventListener('mousedown',e=>{orbMouseDown=true;orbLastX=e.clientX;orbLastY=e.clientY;orbAutoSpin=false;
    document.getElementById('orbSpin').classList.remove('active')});
  window.addEventListener('mouseup',()=>orbMouseDown=false);
  window.addEventListener('mousemove',e=>{
    if(!orbMouseDown)return;
    orbRY+=(e.clientX-orbLastX)*0.008;
    orbRX+=(e.clientY-orbLastY)*0.008;
    orbRX=Math.max(-Math.PI/2,Math.min(Math.PI/2,orbRX));
    orbLastX=e.clientX;orbLastY=e.clientY;
  });

  // Touch
  let touchId=null;
  orbCv.addEventListener('touchstart',e=>{e.preventDefault();
    orbMouseDown=true;touchId=e.touches[0].identifier;
    orbLastX=e.touches[0].clientX;orbLastY=e.touches[0].clientY;
    orbAutoSpin=false;document.getElementById('orbSpin').classList.remove('active');
  },{passive:false});
  orbCv.addEventListener('touchmove',e=>{e.preventDefault();
    if(!orbMouseDown)return;
    const t=[...e.touches].find(t=>t.identifier===touchId);if(!t)return;
    orbRY+=(t.clientX-orbLastX)*0.008;
    orbRX+=(t.clientY-orbLastY)*0.008;
    orbRX=Math.max(-Math.PI/2,Math.min(Math.PI/2,orbRX));
    orbLastX=t.clientX;orbLastY=t.clientY;
  },{passive:false});
  orbCv.addEventListener('touchend',e=>{e.preventDefault();orbMouseDown=false},{passive:false});

  // Resize
  const ro=new ResizeObserver(()=>{
    orbW=wrap.clientWidth;orbH=wrap.clientHeight;
    orbCv.width=orbW*dpr;orbCv.height=orbH*dpr;
    orbCv.style.width=orbW+'px';orbCv.style.height=orbH+'px';
    orbCtx=orbCv.getContext('2d');
    orbCtx.setTransform(dpr,0,0,dpr,0,0);
  });
  ro.observe(wrap);

  orbAnimLoop();
}
window.initOrb=initOrb;

function orbAnimLoop(){
  orbAnim=requestAnimationFrame(orbAnimLoop);
  if(!orbCtx)return;
  const C=orbCtx;
  // Fade trail for motion blur effect
  C.fillStyle='rgba(2,5,16,0.12)';
  C.fillRect(0,0,orbW,orbH);

  if(orbAutoSpin)orbRY+=0.003;
  const n=orbQN.n,l=orbQN.l;
  const sc=Math.min(orbW,orbH)*0.06/n;
  const ry=orbRY,rx=orbRX;
  const cy=Math.cos(ry),sy=Math.sin(ry),cx=Math.cos(rx),sx=Math.sin(rx);
  const midX=orbW/2,midY=orbH/2;

  // Draw nucleus glow
  const ng=C.createRadialGradient(midX,midY,0,midX,midY,12);
  ng.addColorStop(0,'rgba(0,228,255,0.3)');ng.addColorStop(0.4,'rgba(17,138,178,0.08)');ng.addColorStop(1,'transparent');
  C.fillStyle=ng;C.beginPath();C.arc(midX,midY,12,0,Math.PI*2);C.fill();
  // Nucleus dot
  C.fillStyle='rgba(0,228,255,0.6)';C.beginPath();C.arc(midX,midY,2.5,0,Math.PI*2);C.fill();

  // Render points — QUANTUM.LAB style: hsla by z-depth, tiny rects
  for(let i=0;i<orbPts.length;i++){
    const p=orbPts[i];
    // 3D rotation: Y-axis then X-axis
    const a=p.x*cy-p.z*sy;
    const b=p.x*sy+p.z*cy;
    const c=p.y*cx-b*sx;
    const d=p.y*sx+b*cx;
    const px=midX+a*sc;
    const py=midY-c*sc;
    // Depth-based alpha
    const depth=(d+n*5.5)/(n*11);
    const alpha=Math.max(0.03,Math.min(0.55,depth*0.55));
    // Color by wavefunction sign — distinct lobes
    // s orbitals: single color (cyan-blue depth gradient)
    // p/d/f: positive lobe = cyan, negative lobe = purple/pink
    let hue;
    if(l===0){
      hue=195+p.z*5; // subtle depth shift for s orbitals
    } else {
      hue=p.sign>0?195:280; // cyan vs purple for opposite lobes
    }
    C.fillStyle='hsla('+hue+',80%,60%,'+alpha+')';
    C.fillRect(px,py,1.5,1.5);
  }

  // HUD info
  C.fillStyle='rgba(17,138,178,0.25)';
  C.font='bold 10px JetBrains Mono';C.textAlign='left';
  C.fillText(orbQN.n+ORB_NAMES[orbQN.l]+' orbital  m='+orbQN.m+'  '+orbPts.length+' pts',12,orbH-12);
  C.textAlign='right';
  C.fillText('drag to rotate',orbW-12,orbH-12);
}

// === Build element grid ===
const orbGrid=document.getElementById('orbElGrid');
ORB_ELEMENTS.forEach((el,i)=>{
  const b=document.createElement('button');b.className='orbElBtn';
  if(i===0)b.classList.add('active');
  b.textContent=el.sym;b.title=el.name;
  b.addEventListener('click',()=>{
    orbGrid.querySelectorAll('.orbElBtn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.getElementById('orbElName').textContent=el.name;
    document.getElementById('orbElName').style.color=
      el.z<=2?'var(--acc2)':el.z<=10?'var(--acc)':el.z<=18?'#e67e22':el.z<=36?'var(--acc3)':'#c39bd3';
    document.getElementById('orbElSym').textContent=el.sym;
    document.getElementById('orbConfig').textContent=el.cfg;
    orbQN.n=Math.min(4,el.shells.length);
    orbQN.l=0;orbQN.m=0;
    buildQNButtons();
    genOrb();
  });
  orbGrid.appendChild(b);
});

// === Quantum number button system ===
function buildQNButtons(){
  const nC=document.getElementById('orbNbtns');nC.innerHTML='';
  for(let i=1;i<=4;i++){
    const b=document.createElement('button');b.className='qnB'+(i===orbQN.n?' active':'');
    b.textContent=i;
    b.addEventListener('click',()=>{orbQN.n=i;if(orbQN.l>=i)orbQN.l=i-1;if(Math.abs(orbQN.m)>orbQN.l)orbQN.m=0;buildQNButtons();genOrb()});
    nC.appendChild(b);
  }
  const lC=document.getElementById('orbLbtns');lC.innerHTML='';
  for(let i=0;i<orbQN.n;i++){
    const b=document.createElement('button');b.className='qnB'+(i===orbQN.l?' active':'');
    b.textContent=i+' '+ORB_NAMES[i];
    b.addEventListener('click',()=>{orbQN.l=i;if(Math.abs(orbQN.m)>i)orbQN.m=0;buildQNButtons();genOrb()});
    lC.appendChild(b);
  }
  const mC=document.getElementById('orbMbtns');mC.innerHTML='';
  for(let i=-orbQN.l;i<=orbQN.l;i++){
    const b=document.createElement('button');b.className='qnB'+(i===orbQN.m?' active':'');
    b.textContent=i===0?'0':i>0?'+'+i:''+i;
    b.addEventListener('click',()=>{orbQN.m=i;buildQNButtons();genOrb()});
    mC.appendChild(b);
  }
  const pC=document.getElementById('orbPtsBtns');pC.innerHTML='';
  PTS_OPTIONS.forEach(p=>{
    const b=document.createElement('button');b.className='qnB'+(p===orbQN.pts?' active':'');
    b.textContent=p>=1000?(p/1000)+'k':p;
    b.addEventListener('click',()=>{orbQN.pts=p;buildQNButtons();genOrb()});
    pC.appendChild(b);
  });
  const shapes={0:'spherical',1:'dumbbell',2:'clover',3:'multi-lobe'};
  const descs={0:'Spherically symmetric cloud. Higher n = more radial nodes.',1:'Dumbbell lobes along an axis. Angular node at equator.',2:'Cloverleaf pattern. Two angular node planes.',3:'Complex multi-lobe shape with three angular nodes.'};
  document.getElementById('orbDesc').textContent=
    orbQN.n+ORB_NAMES[orbQN.l]+' (m='+orbQN.m+') — '+shapes[orbQN.l]+'. '+descs[orbQN.l];
}

// View controls
document.getElementById('orbSpin').addEventListener('click',function(){
  orbAutoSpin=!orbAutoSpin;this.classList.toggle('active',orbAutoSpin)});
document.getElementById('orbReset').addEventListener('click',()=>{
  orbRX=0.4;orbRY=0;orbAutoSpin=true;
  document.getElementById('orbSpin').classList.add('active');
  // Clear canvas fully
  if(orbCtx){orbCtx.fillStyle='#020510';orbCtx.fillRect(0,0,orbW,orbH)}
});
// Remove slice/axes buttons that don't apply to 2D renderer
const sliceBtn=document.getElementById('orbSlice');
const axesBtn=document.getElementById('orbAxes');
if(sliceBtn)sliceBtn.style.display='none';
if(axesBtn)axesBtn.style.display='none';

buildQNButtons();
})();
</script>
</body>
</html>
